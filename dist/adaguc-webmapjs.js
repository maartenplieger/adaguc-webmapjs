!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports["adaguc-webmapjs"]=t():e["adaguc-webmapjs"]=t()}(window,function(){return function(e){var t={};function i(s){if(t[s])return t[s].exports;var n=t[s]={i:s,l:!1,exports:{}};return e[s].call(n.exports,n,n.exports,i),n.l=!0,n.exports}return i.m=e,i.c=t,i.d=function(e,t,s){i.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:s})},i.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i.t=function(e,t){if(1&t&&(e=i(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var s=Object.create(null);if(i.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var n in e)i.d(s,n,function(t){return e[t]}.bind(null,n));return s},i.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return i.d(t,"a",t),t},i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},i.p="",i(i.s=1)}([function(module,__webpack_exports__,__webpack_require__){"use strict";function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var i=0;i<t.length;i++){var s=t[i];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}function _createClass(e,t,i){return t&&_defineProperties(e.prototype,t),i&&_defineProperties(e,i),e}__webpack_require__.d(__webpack_exports__,"n",function(){return isDefined}),__webpack_require__.d(__webpack_exports__,"o",function(){return isNull}),__webpack_require__.d(__webpack_exports__,"r",function(){return toArray}),__webpack_require__.d(__webpack_exports__,"e",function(){return WMJScheckURL}),__webpack_require__.d(__webpack_exports__,"d",function(){return WMJSKVP}),__webpack_require__.d(__webpack_exports__,"p",function(){return preventdefaultEvent}),__webpack_require__.d(__webpack_exports__,"g",function(){return attachEvent}),__webpack_require__.d(__webpack_exports__,"j",function(){return deleteEvent}),__webpack_require__.d(__webpack_exports__,"k",function(){return getMouseXCoordinate}),__webpack_require__.d(__webpack_exports__,"l",function(){return getMouseYCoordinate}),__webpack_require__.d(__webpack_exports__,"a",function(){return MakeHTTPRequest}),__webpack_require__.d(__webpack_exports__,"b",function(){return URLDecode}),__webpack_require__.d(__webpack_exports__,"c",function(){return URLEncode}),__webpack_require__.d(__webpack_exports__,"m",function(){return getUrlVars}),__webpack_require__.d(__webpack_exports__,"i",function(){return composeUrlObjectFromURL}),__webpack_require__.d(__webpack_exports__,"h",function(){return checkIfHashTagChanged}),__webpack_require__.d(__webpack_exports__,"f",function(){return addMouseWheelEvent}),__webpack_require__.d(__webpack_exports__,"q",function(){return removeMouseWheelEvent});var isDefined=function(e){return void 0!==e},isNull=function(e){return null===e},toArray=function(e){if(!e)return[];if(e.length)return e;var t=[];return t[0]=e,t},WMJScheckURL=function(e){return isDefined(e)?(-1===(e=e.trim()).indexOf("?")&&(e+="?"),e):"?"},WMJSSet=function(){};WMJSSet.prototype.add=function(e){this[e]=!0},WMJSSet.prototype.remove=function(e){delete this[e]};var WMJSKVP=function(){function e(t){return _classCallCheck(this,e),this.kvplist=[],this.kvplist=this._parse(t),this.kvplist}return _createClass(e,[{key:"_parse",value:function(e){var t=[],i=e.split("&");if(i)for(var s in i){var n=i[s].split("=");if(2===n.length){var a=n[0],o=n[1];t[a]instanceof Array||(t[a]=[]),t[a].push(o)}}return t}},{key:"getKeys",value:function(){var e=new WMJSSet;for(var t in this.kvplist)e.add(t);return e}},{key:"getValues",value:function(e){return this.kvplist[e]}},{key:"getKeyValues",value:function(){return this.kvplist}}]),e}(),preventdefaultEvent=function(e){var t=e||window.event;t.preventDefault?t.preventDefault():t.returnValue=!1},attachEvent=function(e,t,i){if("mousewheel"==t){var s=function(e,t){var i=0;e||(e=window.event,window.event.cancelBubble=!0,window.event.returnValue=!1),e.wheelDelta?i=e.wheelDelta/120:e.detail&&(i=-e.detail/3),i&&t(i),e.preventDefault&&e.preventDefault(),e.returnValue=!1};return e.addEventListener&&e.addEventListener("DOMMouseScroll",function(e){s(e,i)},!1),void(e.onmousewheel=document.onmousewheel=function(e){s(e,i)})}if(browser.isNS)e.addEventListener(t,i,!0);else{if(e.attachEvent("on"+t,i),null==window.event)return;window.event.cancelBubble=!0,window.event.returnValue=!1}},deleteEvent=function(e,t,i){var s=!0;browser.isOP&&(s=!1),e.removeEventListener?e.removeEventListener(t,i,s):e.detachEvent&&(e.detachEvent(t,i),e.detachEvent("on"+t,i))},getMouseXCoordinate=function(e){return browser.isNS?e.clientX+window.scrollX:window.event.clientX+document.documentElement.scrollLeft+document.body.scrollLeft},getMouseYCoordinate=function(e){return browser.isNS?e.clientY+window.scrollY:window.event.clientY+document.documentElement.scrollTop+document.body.scrollTop},findElementPos=function(e){for(var t=e,i=curtop=0;e;)i+=e.offsetLeft,curtop+=e.offsetTop,e=e.offsetParent;return[i,curtop,parseInt(t.style.width+i),parseInt(t.style.height+curtop)]};function Browser(){this.isIE=!1,this.isNS=!1,this.isOP=!1,this.isKonqueror=!1,this.name=navigator.appName,this.version=null,navigator.userAgent,-1!=navigator.userAgent.indexOf("Opera")?this.isOP=!0:"Netscape"==navigator.appName||"Konqueror"==navigator.appName?(this.isNS=!0,this.isKonqueror=!0):-1!=navigator.appName.indexOf("Microsoft")&&(this.isIE=!0)}var browser=new Browser;function IsNumeric(e){var t,s=!0;for(i=0;i<e.length&&1==s;i++)t=e.charAt(i),-1=="0123456789.".indexOf(t)&&(s=!1);return s}function dump(e,t,i){var s="";i||(i=""),t||(t=0);if("object"===_typeof(e))for(var n in e){var a=e[n],o=i;IsNumeric(n)?(n="["+n+"]",o=i.substr(0,i.length-1)+n):o=i+n,"object"===_typeof(a)?s+=dump(a,t+1,o+"."):s+=o+'="'+a+'"<br>\n'}else s="===>"+e+"<===("+_typeof(e)+")";return s}var Url={encode:function(e){return escape(this._utf8_encode(e))},decode:function(e){return alert("Deprecated function !!! WMJSTools line 325 with ["+e+"]"),this._utf8_decode(unescape(e))},_utf8_encode:function(e){e=e.replace(/\r\n/g,"\n");for(var t="",i=0;i<e.length;i++){var s=e.charCodeAt(i);s<128?t+=String.fromCharCode(s):s>127&&s<2048?(t+=String.fromCharCode(s>>6|192),t+=String.fromCharCode(63&s|128)):(t+=String.fromCharCode(s>>12|224),t+=String.fromCharCode(s>>6&63|128),t+=String.fromCharCode(63&s|128))}return t},_utf8_decode:function(e){for(var t="",i=0,s=c1=c2=0;i<e.length;)(s=e.charCodeAt(i))<128?(t+=String.fromCharCode(s),i++):s>191&&s<224?(c2=e.charCodeAt(i+1),t+=String.fromCharCode((31&s)<<6|63&c2),i+=2):(c2=e.charCodeAt(i+1),c3=e.charCodeAt(i+2),t+=String.fromCharCode((15&s)<<12|(63&c2)<<6|63&c3),i+=3);return t}};function createXHR(){try{return new XMLHttpRequest}catch(e){}try{return new ActiveXObject("Msxml2.XMLHTTP.6.0")}catch(e){}try{return new ActiveXObject("Msxml2.XMLHTTP.3.0")}catch(e){}try{return new ActiveXObject("Msxml2.XMLHTTP")}catch(e){}try{return new ActiveXObject("Microsoft.XMLHTTP")}catch(e){}return!1}function MakeJSONRequest(fname,callbackfunction,errorfunction,pointer,useredirect){function requestError(e){errorfunction?errorfunction(e,pointer):callbackfunction(void 0,pointer)}function redirRequest(){0==useredirect?MakeJSONRequest(fname=requestProxy+"REQUEST="+URLEncode(fname),callbackfunction,errorfunction,pointer,!0):requestError("status("+xhr.status+") to "+fname)}-1==fname.indexOf("?")?fname+="?":fname+="&",fname+="rand="+Math.random(),useredirect||(useredirect=!1);try{var xhr=createXHR();xhr.open("GET",fname,!0),xhr.onreadystatechange=function(){if(4==xhr.readyState)if(200==xhr.status){try{var data=eval("("+xhr.responseText+")")}catch(e){return void requestError("Invalid JSON: '"+xhr.responseText+"'")}null==data?requestError("request returned no data:"+fname):callbackfunction(data,pointer)}else redirRequest()},xhr.send(null)}catch(e){redirRequest()}}var MakeHTTPRequest=function e(t,i,s,n,a,o){function r(e){s?s(e,n):i(void 0,n)}function h(){!1===a?(t=o+"REQUEST="+URLEncode(t),e(t,i,s,n,!0,o)):r("status("+l.status+") to "+t)}-1===t.indexOf("?")?t+="?":t+="&",t+="rand="+Math.random(),a||(a=!1);try{var l=createXHR();l.open("GET",t,!0),l.onreadystatechange=function(){if(4===l.readyState)if(200===l.status){try{var e=l.responseText}catch(e){return void r("Exception occured:"+e)}void 0===e||""===e?r("request returned no data"):i(e,n)}else h()},l.send(null)}catch(e){h()}},URLDecode=function(e){return isDefined(e)?e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=e.replaceAll("+"," ")).replaceAll("%2B","+")).replaceAll("%20"," ")).replaceAll("%5E","^")).replaceAll("%26","&")).replaceAll("%3F","?")).replaceAll("%3E",">")).replaceAll("%3C","<")).replaceAll("%5C","\\")).replaceAll("%2F","/")).replaceAll("%25","%")).replaceAll("%3A",":")).replaceAll("%27","'")).replaceAll("%24","$"):""},URLEncode=function(e){if(!e)return e;if(void 0===e)return e;if(""===e)return e;if("string"!=typeof e)return e;var t="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz%-_.!~*'()",i="0123456789ABCDEF";e=(e=(e=(e=(e=(e=(e=(e=(e=e.replace(/%/g,"%25")).replace(/\+/g,"%2B")).replace(/ /g,"%20")).replace(/\^/g,"%5E")).replace(/&/g,"%26")).replace(/\?/g,"%3F")).replace(/>/g,"%3E")).replace(/</g,"%3C")).replace(/\\/g,"%5C");for(var s="",n=0;n<e.length;n++){var a=e.charAt(n);if(" "===a)s+="%20";else if(-1!==t.indexOf(a))s+=a;else{var o=a.charCodeAt(0);o>255?(alert("Unicode Character '"+a+"' cannot be encoded using standard URL encoding.\n(URL encoding only supports 8-bit characters.)\nA space (+) will be substituted."),s+="+"):(s+="%",s+=i.charAt(o>>4&15),s+=i.charAt(15&o))}}return s};function checkValidInputTokens(e){var t=/^([a-zA-Z'_:~%?\$,\.\0-9 \-=\/&])+$/;if(t.test(e)){var i=URLDecode(e);if(t.test(i))return!0}return!1}String.prototype.replaceAll=function(e,t){for(var i=this,s=i.indexOf(e);-1!=s;)s=(i=i.replace(e,t)).indexOf(e);return i},String.prototype.trim=function(){var e=this;return e=(e=e.replace(/^\s+/,"")).replace(/\s+$/,"")};var getUrlVars=function(){for(var e,t=[],i=window.location.href.slice(window.location.href.indexOf("?")+1).split("&"),s=0;s<i.length;s++)(e=i[s].split("="))[1]=URLDecode(e[1]),0==checkValidInputTokens(e[0])||0==checkValidInputTokens(e[1])||(t[e[0]]=e[1]+"");return t};function getUrlVarsFromHashTag(){var e,t=[],i=window.location.hash.indexOf("#");"?"==window.location.hash[i+1]&&i++;for(var s=window.location.hash.slice(i+1).split("&"),n=0;n<s.length;n++)(e=s[n].split("="))[1]=URLDecode(e[1]),0==checkValidInputTokens(e[0])||0==checkValidInputTokens(e[1])||(t[e[0]]=e[1]+"");return t}var composeUrlObjectFromURL=function(e){var t=[];if(!isDefined(e))return t;var i="",s=[],n=e.split("?");n.length>1?(i=n[0],s=n[1].split("&")):s=n[0].split("&");for(var a=0;a<s.length;a++){var o=s[a].split("=");isDefined(o[1])?(o[1]=URLDecode(o[1]),0==checkValidInputTokens(o[0])||0==checkValidInputTokens(o[1])||isDefined(o[1])&&o[1].length>0&&(t[o[0].toLowerCase()]=o[1]+"")):(o=s[a].split("%3D"),isDefined(o[1])&&(o[1]=URLDecode(o[1]),0==checkValidInputTokens(o[0])||0==checkValidInputTokens(o[1])||isDefined(o[1])&&o[1].length>0&&(t[o[0].toLowerCase()]=o[1]+"")))}return s[0].indexOf("="),{location:i,kvp:t}},currentLocationHash="",hashTagCheckerInUse=!1,hashTagTimerIsRunning=!1,_checkIfHashTagChanged=function e(t){var i=window.location.hash;if(currentLocationHash!=i&&i.length>0&&(currentLocationHash=i,-1!=window.location.href.indexOf("#"))){var s=window.location.href.split("#")[1];s=s.replaceAll("%27","'");var n=getUrlVarsFromHashTag();isDefined(n.clearhash)&&"1"==n.clearhash&&(window.location.hash="",currentLocationHash=""),t(s,n)}!0!==hashTagTimerIsRunning&&(hashTagTimerIsRunning=!0,setTimeout(function(){hashTagTimerIsRunning=!1,e(t)},500))},checkIfHashTagChanged=function(e){isDefined(e)&&(1!=hashTagCheckerInUse?(hashTagCheckerInUse=!0,_checkIfHashTagChanged(e)):alert("checkIfHashTagChanged is in use"))},decodeBase64=function(e){var t,i,s,n={},a=0,o=0,r="",h=String.fromCharCode,l=e.length;for(t=0;t<64;t++)n["ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(t)]=t;for(i=0;i<l;i++)for(a=(a<<6)+n[e.charAt(i)],o+=6;o>=8;)((s=a>>>(o-=8)&255)||i<l-2)&&(r+=h(s));return r},addMouseWheelEvent=function(e,t){if(!window.addWheelListener){var i,s,n=function(e,t,n,o){e[i](a+t,"wheel"==s?n:function(e){!e&&(e=window.event);var t={originalEvent:e,target:e.target||e.srcElement,type:"wheel",deltaMode:"MozMousePixelScroll"==e.type?0:1,deltaX:0,deltaY:0,deltaZ:0,preventDefault:function(){e.preventDefault?e.preventDefault():e.returnValue=!1}};return"mousewheel"==s?(t.deltaY=-.025*e.wheelDelta,e.wheelDeltaX&&(t.deltaX=-.025*e.wheelDeltaX)):t.deltaY=e.deltaY||e.detail,n(t)},o||!1)},a="";window.addEventListener?i="addEventListener":(i="attachEvent",a="on"),s="onwheel"in document.createElement("div")?"wheel":void 0!==document.onmousewheel?"mousewheel":"DOMMouseScroll",window.addWheelListener=function(e,t,i){n(e,s,t,i),"DOMMouseScroll"==s&&n(e,"MozMousePixelScroll",t,i)}}window.addWheelListener(e,t)},removeMouseWheelEvent=function(e,t){console.warn("TODO: Implement removeMouseWheelEvent in WMJSTools.js")}},function(e,t,i){"use strict";i.r(t);var s=window.$,n=window.moment,a=window.proj4,o=i(0);function r(e,t){for(var i=0;i<t.length;i++){var s=t[i];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}var h=0,l=function(){function e(t,i,n,a){var r=this;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.randomize=!0,this._srcLoaded=void 0,this._isLoaded=void 0,this._isLoading=void 0,this._hasError=void 0,this._opacity=void 0,Object(o.n)(a)&&Object(o.n)(a.randomizer)&&!1===a.randomizer&&(this.randomize=!1),this.init=this.init.bind(this),this.isLoaded=this.isLoaded.bind(this),this.isLoading=this.isLoading.bind(this),this.checkIfThisSourceIsSet=this.checkIfThisSourceIsSet.bind(this),this.setSource=this.setSource.bind(this),this.clear=this.clear.bind(this),this.getSrc=this.getSrc.bind(this),this.hasError=this.hasError.bind(this),this.stopLoading=this.stopLoading.bind(this),this._load=this._load.bind(this),this.load=this.load.bind(this),this.loadEvent=this.loadEvent.bind(this),this.setOpacity=this.setOpacity.bind(this),this.getOpacity=this.getOpacity.bind(this),this.setPosition=this.setPosition.bind(this),this.setSize=this.setSize.bind(this),this.setZIndex=this.setZIndex.bind(this),this.getElement=this.getElement.bind(this),this.init(),this.srcToLoad=t,this._type=n,this.loadEventCallback=i,this.el=s(document.createElement("img")),this.el.on("load",function(){r.loadEvent(r,!1)}),this.el.on("error",function(e){r.loadEvent(r,!0)}),this.el.onselectstart=function(){return!1},this.el.ondrag=function(){return!1}}var t,i,n;return t=e,(i=[{key:"init",value:function(){this._srcLoaded="undefined image",this._isLoaded=!1,this._isLoading=!1,this._hasError=!1,this._opacity=1,this._stopLoading=!1}},{key:"isLoaded",value:function(){return!this._isLoading&&this._isLoaded}},{key:"isLoading",value:function(){return this._isLoading}},{key:"checkIfThisSourceIsSet",value:function(e){return this._srcLoaded===e||this.srcToLoad===e}},{key:"setSource",value:function(e){this._isLoading?console.error("-------------------------\x3e Source set while still loading!!! "):(this.srcToLoad=e,this._srcLoaded!==this.srcToLoad?this._isLoaded=!1:this._isLoaded=!0)}},{key:"clear",value:function(){this.init(),this._stopLoading=!0}},{key:"stopLoading",value:function(){this._stopLoading=!0}},{key:"getSrc",value:function(){return this.srcToLoad}},{key:"hasError",value:function(){return this._hasError}},{key:"load",value:function(){this._stopLoading=!1,this._load()}},{key:"_load",value:function(){var e=this;if(this._hasError=!1,!0!==this._isLoaded){if(this._isLoading=!0,!this.srcToLoad)return console.error("Source not set"),void this.loadEvent(this,!0);if(this.srcToLoad.startsWith("/")&&!this.srcToLoad.startsWith("//")){var t=window.location.href.split("/").filter(function(e){return e.length>0}),i=t[0]+"//"+t[1]+"/";this.srcToLoad=i+this.srcToLoad}if(!1===this.srcToLoad.startsWith("http")&&!1===this.srcToLoad.startsWith("//"))return console.error("Source does not start with http"),void this.loadEvent(this,!0);this.srcToLoad!==this._srcLoaded?!0!==this.timerIsRunning&&(h>=4?!1===this._stopLoading?(this.timerIsRunning=!0,setTimeout(function(){e.timerIsRunning=!1,e._load()},10)):this.init():(h++,this.randomize?this.getElement()[0].src=this.srcToLoad+"&"+Math.random():this.getElement()[0].src=this.srcToLoad)):this.loadEvent(this,!1)}else this.loadEvent(this,!1)}},{key:"loadEvent",value:function(e,t){h--,this._hasError=t,this._isLoading=!1,this._isLoaded=!0,this._srcLoaded=this.srcToLoad,Object(o.n)(this.loadEventCallback)&&this.loadEventCallback(this)}},{key:"setOpacity",value:function(e){this._opacity=parseFloat(e),this.el.css("opacity",this._opacity)}},{key:"getOpacity",value:function(e){return this._opacity}},{key:"setPosition",value:function(e,t){this.el.css({top:parseInt(t)+"px",left:parseInt(e)+"px",position:"absolute"})}},{key:"setSize",value:function(e,t){e=parseInt(e),t=parseInt(t),0!==e&&0!==t&&(isNaN(e)||isNaN(t)||(this.el.width(parseInt(e)+"px"),this.el.height(parseInt(t)+"px")))}},{key:"setZIndex",value:function(e){this.el.zIndex=e}},{key:"getElement",value:function(){return this.el}}])&&r(t.prototype,i),n&&r(t,n),e}();function u(e,t){for(var i=0;i<t.length;i++){var s=t[i];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}var d=function(){function e(t,i,s){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.imagesbysrc={},this.imageLife=0,this._imageLifeCounter=0,this._type=i,this._loadEventCallbackList=[],this._maxNumberOfImages=t,this._options=s,this.imageLoadEventCallback=this.imageLoadEventCallback.bind(this),this.getImageForSrc=this.getImageForSrc.bind(this),this.clear=this.clear.bind(this),this.stopLoading=this.stopLoading.bind(this),this.addLoadEventCallback=this.addLoadEventCallback.bind(this),this.getNumImagesLoading=this.getNumImagesLoading.bind(this),this.getImage=this.getImage.bind(this),this.emptyImage=new l}var t,i,s;return t=e,(i=[{key:"imageLoadEventCallback",value:function(e,t){for(var i=0;i<this._loadEventCallbackList.length;i++)this._loadEventCallbackList[i](e)}},{key:"_getKeys",value:function(e){if(Object.keys)return Object.keys(e);var t,i=[];for(t in e)Object.prototype.hasOwnProperty.call(e,t)&&i.push(t);return i}},{key:"getImageForSrc",value:function(e){if(this.imagesbysrc[e])return this.imagesbysrc[e]}},{key:"clear",value:function(){for(var e in this.imagesbysrc)this.imagesbysrc.hasOwnProperty(e)&&this.imagesbysrc[e].clear()}},{key:"stopLoading",value:function(){for(var e in this.imagesbysrc)this.imagesbysrc.hasOwnProperty(e)&&this.imagesbysrc[e].stopLoading()}},{key:"addLoadEventCallback",value:function(e){this._loadEventCallbackList.push(e)}},{key:"getNumImagesLoading",value:function(){var e=0;for(var t in this.imagesbysrc)this.imagesbysrc.hasOwnProperty(t)&&this.imagesbysrc[t].isLoading()&&e++;return e}},{key:"getImage",value:function(e){var t=this,i=this.getImageForSrc(e);if(void 0!==i)return i.imageLife=this._imageLifeCounter++,i;if(this._getKeys(this.imagesbysrc).length<this._maxNumberOfImages)return(i=new l(e,this.imageLoadEventCallback,this._type,this._options)).setSource(e),i.KVP=new o.d(e),this.imagesbysrc[e]=i,i.imageLife=this._imageLifeCounter++,i;var s=-1,n=this._imageLifeCounter;return Object.keys(this.imagesbysrc).forEach(function(e){var i=t.imagesbysrc[e];!1===i.isLoading()&&n>=i.imageLife&&(n=i.imageLife,s=e)}),-1===s?(console.error("not enough cache for "+this._type),this.emptyImage):(i=this.imagesbysrc[s],delete this.imagesbysrc[s],i.clear(),i.setSource(e),i.KVP=new o.d(e),this.imagesbysrc[e]=i,i.imageLife=this._imageLifeCounter++,i)}}])&&u(t.prototype,i),s&&u(t,s),e}(),c=function(e){console.log("error:"+e)},m={version100:"1.0.0",version111:"1.1.1",version130:"1.3.0"},f=[["EPSG:4326","+title=WGS 84 (long/lat) +proj=longlat +ellps=WGS84 +datum=WGS84 +units=degrees"],["EPSG:4269","+title=NAD83 (long/lat) +proj=longlat +a=6378137.0 +b=6356752.31414036 +ellps=GRS80 +datum=NAD83 +units=degrees"],["EPSG:3575","+proj=laea +lat_0=90 +lon_0=10 +x_0=0 +y_0=0 +ellps=WGS84 +datum=WGS84 +units=m +no_defs"],["EPSG:3785","+proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0 +k=1.0 +units=m +nadgrids=@null +wktext  +no_defs"],["EPSG:3857","+proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0 +k=1.0 +units=m +nadgrids=@null +wktext  +no_defs"],["EPSG:3411","+proj=stere +lat_0=90 +lat_ts=70 +lon_0=-45 +k=1 +x_0=0 +y_0=0 +a=6378273 +b=6356889.449 +units=m +no_defs"],["EPSG:3412","+proj=stere +lat_0=-90 +lat_ts=-70 +lon_0=0 +k=1 +x_0=0 +y_0=0 +a=6378273 +b=6356889.449 +units=m +no_defs"],["EPSG:28992","+proj=sterea +lat_0=52.15616055555555 +lon_0=5.38763888888889 +k=0.9999079 +x_0=155000 +y_0=463000 +ellps=bessel +units=m +no_defs  <>"],["EPSG:32661","+proj=stere +lat_0=90 +lat_ts=90 +lon_0=0 +k=0.994 +x_0=2000000 +y_0=2000000 +ellps=WGS84 +datum=WGS84 +units=m +no_defs"],["EPSG:102100","+proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0 +k=1.0 +units=m +nadgrids=@null +wktext  +no_defs"]];function p(e){return(p="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function g(e,t){for(var i=0;i<t.length;i++){var s=t[i];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}var v=function(){function e(t,i,s,n){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.left=-180,this.bottom=-90,this.right=180,this.top=90,this.clone=this.clone.bind(this),this.copy=this.copy.bind(this),this.setBBOX=this.setBBOX.bind(this),this.equals=this.equals.bind(this),this.toString=this.toString.bind(this),this.setBBOX(t,i,s,n)}var t,i,s;return t=e,(i=[{key:"clone",value:function(t){void 0===t&&(t=this);var i=new e;return i.left=t.left,i.bottom=t.bottom,i.right=t.right,i.top=t.top,i}},{key:"copy",value:function(e){this.setBBOX(e)}},{key:"setBBOX",value:function(e,t,i,s){if(null==e)return this.left=-180,this.bottom=-90,this.right=180,void(this.top=90);if(!t)if("object"===p(e)){var n=e;void 0===n.length||null===n.length?(e=n.left,t=n.bottom,i=n.right,s=n.top):(e=parseFloat(n[0]),t=parseFloat(n[1]),i=parseFloat(n[2]),s=parseFloat(n[3]))}else try{var a=e.split(",");4!==a.length&&c("Invalid map bounding box: '"+e+"'"),e=parseFloat(a[0]),t=parseFloat(a[1]),i=parseFloat(a[2]),s=parseFloat(a[3])}catch(e){}void 0!==e&&void 0!==t&&void 0!==i&&void 0!==s&&null!==e&&null!==t&&null!==i&&null!==s||(void 0===e&&(e=-180),void 0===i&&(i=180),void 0===t&&(t=-90),void 0===s&&(s=90)),this.left=e,this.bottom=t,this.right=i,this.top=s}},{key:"equals",value:function(e,t,i,s){if(!e)return!1;if(void 0!==t&&this.left===e&&this.right===i&&this.top===s&&this.bottom===t)return!0;if("object"===p(e)){if(this.left===e.left&&this.right===e.right&&this.top===e.top&&this.bottom===e.bottom)return!0}else{var n=e.split(",");4!==n.length&&console.log("Invalid map bounding box: "+e);var a=parseFloat(n[0]);t=parseFloat(n[1]),i=parseFloat(n[2]),s=parseFloat(n[3]);var o=0;if(this.left===a&&o++,this.right===i&&o++,this.top===s&&o++,this.bottom===t&&o++,o>=2)return!0}return!1}},{key:"toString",value:function(){return this.left+","+this.bottom+","+this.right+","+this.top}}])&&g(t.prototype,i),s&&g(t,s),e}();var y=function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.bbox=new v,this.srs="EPSG:4326"};function b(e,t){for(var i=0;i<t.length;i++){var s=t[i];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}function _(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var x=function e(){_(this,e),this.name=void 0,this.functionpointer=void 0,this.finished=0,this.keepOnCall=!1},B=function(){function e(){_(this,e),this._callBacks=[],this._suspendedEvents=[],this.addToCallback=this.addToCallback.bind(this),this.removeEvents=this.removeEvents.bind(this),this.suspendEvent=this.suspendEvent.bind(this),this.resumeEvent=this.resumeEvent.bind(this),this.triggerEvent=this.triggerEvent.bind(this),this.destroy=this.destroy.bind(this)}var t,i,s;return t=e,(i=[{key:"addToCallback",value:function(e,t,i){var s=-1;i||(i=!1);for(var n=0;n<this._callBacks.length;n++){if(1===this._callBacks[n].finished){s=n;break}if(this._callBacks[n].name===e&&this._callBacks[n].functionpointer===t)return this._callBacks[n].keepOnCall=i,!1}return-1===s&&(s=this._callBacks.length,this._callBacks.push(new x)),this._callBacks[s].name=e,this._callBacks[s].functionpointer=t,this._callBacks[s].finished=0,this._callBacks[s].keepOnCall=i,!0}},{key:"removeEvents",value:function(e,t){for(var i=0;i<this._callBacks.length;i++)0===this._callBacks[i].finished&&this._callBacks[i].name===e&&(t?this._callBacks[i].functionpointer===t&&(this._callBacks[i].finished=1):this._callBacks[i].finished=1)}},{key:"destroy",value:function(){this._callBacks.length=0}},{key:"suspendEvent",value:function(e){this._suspendedEvents[e]=!0}},{key:"resumeEvent",value:function(e){this._suspendedEvents[e]=!1}},{key:"triggerEvent",value:function(e,t){if(!0!==this._suspendedEvents[e]){for(var i=[],s=0;s<this._callBacks.length;s++)if(0===this._callBacks[s].finished&&this._callBacks[s].name===e){!1===this._callBacks[s].keepOnCall&&(this._callBacks[s].finished=1);try{i.push(this._callBacks[s].functionpointer(t,this))}catch(i){console.log("Error for event ["+e+"]: ",t,i)}}return i}}}])&&b(t.prototype,i),s&&b(t,s),e}();function w(){this.init=function(i,s){(e=parseInt(i/10+.5))<1&&(e=1),t=e=1,a=s,o(),n=i/1,e>0&&r()},this.reset=function(){e=t,e=1},this.stop=function(){o()};var e,t,i=null,s=!1,n=10,a="";function o(){s&&clearTimeout(i),s=!1}function r(){0==e?(o(),""!=a&&a()):(e-=1,s=!0,i=setTimeout(r,n))}}function L(e,t){for(var i=0;i<t.length;i++){var s=t[i];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}var S=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this._isRunning=!1,this._milliseconds=10,this._stop=!1,this.init=this.init.bind(this),this.stop=this.stop.bind(this)}var t,i,s;return t=e,(i=[{key:"init",value:function(e,t){var i=this;this._stop=!1,this._milliseconds=e,this._milliseconds<10&&(this._milliseconds=50),!1===this._isRunning&&(self.setTimeout(function(){i._isRunning=!1,!1===i._stop&&t()},this._milliseconds),this._isRunning=!0)}},{key:"stop",value:function(){this._stop=!0}}])&&L(t.prototype,i),s&&L(t,s),e}();function k(e,t){for(var i=0;i<t.length;i++){var s=t[i];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}var T=function(){function e(t,i,n,a,o){var r=this;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.canvas=s("<canvas/>",{class:"WMJSCanvasBuffer"}).width(a).height(o),this._ctx=this.canvas[0].getContext("2d"),this._ctx.canvas.width=a,this._ctx.canvas.height=o,this._imageStore=n,this.ready=!0,this.hidden=!0,this.layerstodisplay=[],this.layers=[],this._defaultImage=new l("webmapjs/img/stoploading.png",function(){console.log("no image loaded"),r._statDivBufferImageLoaded()},this._type),this._currentbbox=void 0,this._currentnewbbox=void 0,this._width=a,this._height=o,this._type=i,this._webmapJSCallback=t,"imagebuffer"===this._type&&this.canvas.addClass("wmjsimagebuffer"),"legendbuffer"===this._type&&this.canvas.addClass("wmjslegendbuffer"),this.canvas.addClass("WMJSCanvasBuffer-noselect"),this.getCanvasContext=this.getCanvasContext.bind(this),this.imageLoadComplete=this.imageLoadComplete.bind(this),this._statDivBufferImageLoaded=this._statDivBufferImageLoaded.bind(this),this.hide=this.hide.bind(this),this.display=this.display.bind(this),this.finishedLoading=this.finishedLoading.bind(this),this.resize=this.resize.bind(this),this.load=this.load.bind(this),this.setSrc=this.setSrc.bind(this),this._getPixelCoordFromGeoCoord=this._getPixelCoordFromGeoCoord.bind(this),this.setBBOX=this.setBBOX.bind(this),this.getBuffer=this.getBuffer.bind(this)}var t,i,n;return t=e,(i=[{key:"getCanvasContext",value:function(){return this._ctx}},{key:"imageLoadComplete",value:function(e){this._statDivBufferImageLoaded(),this._webmapJSCallback.triggerEvent("onimageload"),"imagebuffer"===this._type&&this._webmapJSCallback.triggerEvent("onimagebufferimageload",e)}},{key:"_statDivBufferImageLoaded",value:function(){for(var e=0;e<this.layers.length;e++)if(!1===this.layers[e].image.isLoaded())return;this.finishedLoading()}},{key:"hide",value:function(){this.hidden=!0,this.canvas.hide(),this.layers.length=0,this.layerstodisplay.length=0}},{key:"display",value:function(e,t){var i=[];if(!e||t){var s,n;if(this.hidden=!1,this._ctx.globalAlpha=1,"legendbuffer"===this._type&&this._ctx.clearRect(0,0,this._width,this._height),"imagebuffer"===this._type&&(this._ctx.beginPath(),this._ctx.rect(0,0,this._width,this._height),this._ctx.fillStyle="white",this._ctx.fill(),this._webmapJSCallback.triggerEvent("beforecanvasstartdraw",this._ctx)),e){var a=t,o=e;s=this._getPixelCoordFromGeoCoord({x:a.left,y:a.top},o),n=this._getPixelCoordFromGeoCoord({x:a.right,y:a.bottom},o)}for(var r=0,h=0;h<this.layerstodisplay.length;h++)if(this.layerstodisplay[h].image.setSize(this._width,this._height),!1===this.layerstodisplay[h].image.hasError()){var l=this.layerstodisplay[h].opacity;this._ctx.globalAlpha=l;var u=this.layerstodisplay[h].image.getElement()[0];if("legendbuffer"===this._type){var d=parseInt(u.width)+4,c=parseInt(u.height)+4;r+=d+4;var m=this._width-r+2,f=this._height-c-2;this._ctx.beginPath(),this._ctx.fillStyle="#FFFFFF",this._ctx.lineWidth=.3,this._ctx.globalAlpha=.5,this._ctx.strokeStyle="#000000",this._ctx.rect(parseInt(m)+.5,parseInt(f)+.5,d,c),this._ctx.fill(),this._ctx.stroke(),this._ctx.globalAlpha=1,this._ctx.drawImage(u,m,f)}else if(e){var p=parseInt(s.x+.5),g=parseInt(s.y+.5),v=parseInt(n.x-s.x+.5),y=parseInt(n.y-s.y+.5);v===parseInt(this._ctx.canvas.width)&&y===parseInt(this._ctx.canvas.height)?this._ctx.drawImage(u,p,g):this._ctx.drawImage(u,p,g,v,y)}else this._ctx.drawImage(u,0,0,this._width,this._height)}else i.push(this.layerstodisplay[h]);this._ctx.globalAlpha=1,"imagebuffer"===this._type&&i.length>0&&this._webmapJSCallback.triggerEvent("canvasonerror",i),"imagebuffer"===this._type&&this._webmapJSCallback.triggerEvent("beforecanvasdisplay",this._ctx),this.canvas.show(),"imagebuffer"===this._type&&this._webmapJSCallback.triggerEvent("aftercanvasdisplay",this._ctx)}else console.error("skipping WMJSCanvasBuffer:display because newbbox is undefined")}},{key:"finishedLoading",value:function(){if(!this.ready){this.ready=!0,this.layerstodisplay.length=0;for(var e=0;e<this.layers.length;e++)this.layerstodisplay.push(this.layers[e]),this.layers[e].image.hasError()&&c('Unable to get image <a target="_blank" href="'+this.layerstodisplay[e].image.getSrc()+'">'+this.layerstodisplay[e].image.getSrc()+"</a>");try{Object(o.n)(this.onLoadReadyFunction)&&this.onLoadReadyFunction(this)}catch(e){c("Exception in Divbuffer::finishedLoading: "+e)}}}},{key:"resize",value:function(e,t){e=parseInt(e),t=parseInt(t),this._width===e&&this._height===t||(this._width=e,this._height=t,this.canvas.width(e),this.canvas.height(t),this._ctx.canvas.height=t,this._ctx.canvas.width=e)}},{key:"load",value:function(e){if(!1!==this.ready){this.ready=!1,this.layerstodisplay.length=0,this.onLoadReadyFunction=e||{},this.nrLoading=0;for(var t=0;t<this.layers.length;t++)this.layers[t].loadThisOne=!1,!1===this.layers[t].image.isLoaded()&&(this.layers[t].loadThisOne=!0,this.nrLoading++);if(0===this.nrLoading)this._statDivBufferImageLoaded();else{this._type,this._type;for(var i=0;i<this.layers.length;i++)!0===this.layers[i].loadThisOne&&(this.layers[i].image.getSrc(),this.layers[i].image.getSrc());for(var s=0;s<this.layers.length;s++)!0===this.layers[s].loadThisOne&&this.layers[s].image.load()}}}},{key:"setSrc",value:function(e,t,i,s,n,a){if(Object(o.n)(t)){for(;e>=this.layers.length;)this.layers.push({image:this._defaultImage,opacity:a,linkedInfo:n,loadThisOne:!1});var r=this._imageStore.getImage(t);this.layers[e].image=r}else console.log("undefined")}},{key:"_getPixelCoordFromGeoCoord",value:function(e,t){return{x:this._width*(e.x-t.left)/(t.right-t.left),y:this._height*(e.y-t.top)/(t.bottom-t.top)}}},{key:"setBBOX",value:function(e,t){this._currentbbox===t+""&&this._currentnewbbox===e+""||(this._currentbbox=t+"",this._currentnewbbox=e+"",!1===this.hidden&&this.display(e,t))}},{key:"getBuffer",value:function(){return this.canvas}}])&&k(t.prototype,i),n&&k(t,n),e}();function M(e,t){for(var i=0;i<t.length;i++){var s=t[i];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}var O=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),t.animationDelay=100,this._callBack=t.getListener(),this._imageStore=t.getImageStore(),this._divAnimationInfo=document.createElement("div"),t.currentAnimationStep=0,t.animationList=void 0,t.isAnimating=!1,t.setAnimationDelay=function(e){e<1&&(e=1),t.animationDelay=e},this._divAnimationInfo.style.zIndex=1e4,this._divAnimationInfo.style.background="none",this._divAnimationInfo.style.position="absolute",this._divAnimationInfo.style.border="none",this._divAnimationInfo.style.margin="0px",this._divAnimationInfo.style.padding="0px",this._divAnimationInfo.style.lineHeight="14px",this._divAnimationInfo.style.fontFamily='"Courier New", "Lucida Console", Monospace',this._divAnimationInfo.style.fontSize="10px",t.getBaseElement().append(this._divAnimationInfo),s(this._divAnimationInfo).mouseout(function(){t.mouseHoverAnimationBox=!1}),t.isAnimatingLoopRunning=!1,this._map=t,this._removeAllChilds=this._removeAllChilds.bind(this),this._drawAnimationBar=this._drawAnimationBar.bind(this),this._animate=this._animate.bind(this),this._animateLoop=this._animateLoop.bind(this),this.checkAnimation=this.checkAnimation.bind(this),this.stopAnimating=this.stopAnimating.bind(this),t.stopAnimating=this.stopAnimating,t.checkAnimation=this.checkAnimation}var t,i,n;return t=e,(i=[{key:"_removeAllChilds",value:function(e){try{if(e.hasChildNodes())for(;e.childNodes.length>=1;)e.removeChild(e.firstChild)}catch(e){}}},{key:"_drawAnimationBar",value:function(e){}},{key:"_animate",value:function(){if(!1!==this._map.isAnimating&&!0!==this._map.animateBusy){var e=this._map.animationList[this._map.currentAnimationStep];e?(this._map.setDimension(e.name,e.value,!1),this._callBack.triggerEvent("ondimchange"),this._callBack.triggerEvent("onnextanimationstep",this._map),this._map._pdraw(),this._map.animateBusy=!1):c("No animation step for "+this._map.currentAnimationStep)}}},{key:"_animateLoop",value:function(){if(!1!==this._map.isAnimating){var e=this._map.animationDelay;if(0===this._map.currentAnimationStep&&(e*=3),this._map.currentAnimationStep===this._map.animationList.length-1&&(e*=5),this._map.animationTimer.init(e,this._animateLoop),this.checkAnimation(),!1===this._map.mouseHoverAnimationBox){this._animate();var t=this._map.currentAnimationStep+1;t>=this._map.animationList.length&&(t=0);var i=!1,s=0,n=this._map.animationList[t];this._map.setDimension(n.name,n.value,!1),this._map.animationList[t].requests=this._map.getWMSRequests(),n=this._map.animationList[this._map.currentAnimationStep],this._map.setDimension(n.name,n.value,!1);for(var a=0;a<this._map.animationList[t].requests.length;a++){var o=this._map.animationList[t].requests[a],r=this._map.getImageStore().getImageForSrc(o);r&&r.isLoaded()&&s++}s===this._map.animationList[t].requests.length&&(i=!0),i&&(this._map.currentAnimationStep=t)}}else this._map.isAnimatingLoopRunning=!1}},{key:"checkAnimation",value:function(){if(!1!==this._map.isAnimating){if(this._map.animationTimer||(this._map.animationTimer=new w),!1===this._map.mouseHoverAnimationBox){var e=this._imageStore.getNumImagesLoading();if(e<4){var t=this._map.animationList.length;if(this._map.animationList.length>0)for(var i=0;i<t;i++){for(var s=i+this._map.currentAnimationStep;s<0;)s+=this._map.animationList.length;for(;s>=this._map.animationList.length;)s-=this._map.animationList.length;if(s<0&&(s=0),s>=0){var n=this._map.animationList[s];if(this._map.setDimension(n.name,n.value,!1),this._map.animationList[s].requests=this._map.getWMSRequests(),n=this._map.animationList[this._map.currentAnimationStep],this._map.setDimension(n.name,n.value,!1),this._map.animationList[s].imagesInPrefetch=this._map.prefetch(this._map.animationList[s].requests),(e+=this._map.animationList[s].imagesInPrefetch.length)>3)break}}}}!1===this._map.isAnimatingLoopRunning&&(this._map.isAnimatingLoopRunning=!0,this._animateLoop())}else this._map.isAnimatingLoopRunning=!1}},{key:"stopAnimating",value:function(){!1!==this._map.isAnimating&&(this._divAnimationInfo.style.display="none",this._map.isAnimating=!1,this._map.animateBusy=!1,this._map.rebuildMapDimensions(),this._callBack.triggerEvent("onstopanimation",this._map))}}])&&M(t.prototype,i),n&&M(t,n),e}();function C(e,t){for(var i=0;i<t.length;i++){var s=t[i];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}var D=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,i,s;return t=e,(i=[{key:"render",value:function(e,t,i,s,n,a,o,r,h){var l={};if(o.stopLoading(),h){"streetmap"===h&&(h="OSM"),"pdok"===h&&(h="OSM"),"naturalearth2"===h&&(h="NaturalEarth2");var u=r[h];if(u){var d=u[i];if(!d)for(var c in r)if(r.hasOwnProperty(c))for(var m in r[c])r[c].hasOwnProperty(m)&&m===i&&(d=r[c][m]);var f=Math.PI,p=256,g=2*f*6378137/p,v=-2*f*6378137/2,y=2*f*6378137/2;d.tileSize&&(p=d.tileSize),d.resolution&&(g=d.resolution),d.origX&&(v=d.origX),d.origY&&(y=d.origY);var b=s,_=e.right-e.left,x=g*p+v,B=y-g*p,w=x-v,L=y-B,S=Math.log(Math.abs(x-v)/(_/b*p))/Math.log(2);!function(r){var h=d.home,u=d.tileServerType,c=d.tms||!1;r<d.minLevel&&(r=d.minLevel),r>d.maxLevel&&(r=d.maxLevel);var m=Math.pow(2,r),f=w/(g/m*p),b=L/(g/m*p),_=parseInt(Math.round((e.left-v)/w*f/1+.5)),x=parseInt(Math.round((e.right-v)/w*f/1+.5)),S=parseInt(Math.round(b-(e.bottom-B)/L*b+.5)),k=parseInt(Math.round(b-(e.top-B)/L*b+.5)),T=function(e,t,i){var s=g/Math.pow(2,e);return{x:t*s+v,y:y-i*s}},M=function(e,t,i,s){var n=i*(e.x-t.left)/(t.right-t.left),a=s*(e.y-t.top)/(t.bottom-t.top);return{x:parseFloat(n),y:parseFloat(a)}},O=function e(i,a,r,d){var m,f=!(arguments.length>4&&void 0!==arguments[4])||arguments[4],g=function(e,t,i){var s=T(e,t*p,i*p),n=T(e,(t+1)*p,(i+1)*p);return{left:s.x,bottom:s.y,right:n.x,top:n.y}}(a,r,d),v=M({x:g.left,y:g.bottom},t,s,n),y=M({x:g.right,y:g.top},t,s,n);if("osm"===u&&(m=c?h+a+"/"+r+"/"+(b-1-d)+".png":h+a+"/"+r+"/"+d+".png"),"arcgisonline"!==u&&"wmst"!==u||(m=h+a+"/"+d+"/"+r),!l[m]){l[m]=!0;var _=o.getImage(m);if(0==f)if(_.isLoaded())try{i.drawImage(_.getElement()[0],parseInt(v.x),parseInt(v.y),parseInt(y.x-v.x)+1,parseInt(y.y-v.y)+1)}catch(e){}else a>1&&e(i,a-1,parseInt(r/2),parseInt(d/2),!1);else f&&!1===_.isLoaded()&&!1===_.hasError()&&!1===_.isLoading()&&_.load(),_.isLoaded()?i.drawImage(_.getElement()[0],parseInt(v.x),parseInt(v.y),parseInt(y.x-v.x)+1,parseInt(y.y-v.y)+1):a>1&&e(i,a-1,parseInt(r/2),parseInt(d/2),!1)}};if("EPSG:4326"!==i&&"EPSG:4258"!==i||(f*=2),k<1&&(k=1),k>b&&(k=b),_<1&&(_=1),_>f&&(_=f),S<1&&(S=1),S>b&&(S=b),x<1&&(x=1),x>f&&(x=f),S-k>20)console.error("Too many tiles in vertical",S-k);else if(x-_>20)console.error("Too many tiles in horizontal",S-k);else for(var C=k-1;C<S;C++)for(var D=_-1;D<x;D++)O(a,r,D,C)}(parseInt(S+.5))}else console.error("Tiled layer with name "+h+" not found")}else console.error("layerName not defined")}}])&&C(t.prototype,i),s&&C(t,s),e}(),I=function(e,t,i){var s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"#FFF",n=arguments.length>4&&void 0!==arguments[4]?arguments[4]:"#000",a={x:parseInt(t),y:parseInt(i)};e.fillStyle=s,e.globalAlpha=1,e.beginPath();e.arc(a.x,a.y-22.5,9,Math.PI,2*Math.PI),e.bezierCurveTo(a.x+9,a.y-22.5,a.x+5.625,a.y-9,a.x,a.y),e.bezierCurveTo(a.x,a.y,a.x-5.625,a.y-9,a.x-9,a.y-22.5),e.stroke(),e.fill(),e.fillStyle="#FFF",e.beginPath(),e.arc(a.x,a.y-22.5,4.5,2*Math.PI,0),e.fill(),e.fillStyle=n,e.beginPath(),e.arc(a.x,a.y,2,2*Math.PI,0),e.fill()},E={delete:{text:"Delete"},delete_selected_flag_tooltip:{tooltip:"Delete selected flag"},add_flag_tooltip:{tooltip:"Add a flag with current latitude, longitude and name"},are_you_sure:{text:"Are you sure about deleting this flag?"},delete_title_confirm:{text:"Delete flag"},default_selected_flag:{text:"None"},selected_flag:{text:"Nearest flag:"},add_point_interest_abstract:{text:"Add or update your point of interest here with a latitude, a longitude and a name of choice."},insert_name:{text:"Name:"},add_point_interest:{text:"Add point of interest"},add:{text:"Add"},place_search_term:{text:"Search for location&hellip;"},debug_searching_location:{text:"Searching for location in SQLite DB:"},debug_searching_sqlite_location:{text:"Searching for location with GeoNames API:"},geonames_api_call_failed:{text:"GeoNames API request failed"},geonames_sqlite_call_failed:{text:"GeoNames SQLite request failed."},no_results_search:{text:"No results for search"},unable_to_do_getcapabilities:{text:"Unable to do getcapabilities for"},unable_to_connect_server:{text:"Unable to connect to the service."},unable_to_search:{text:"Unable to perform a search"},no_urls_in_config:{text:"No GeoNames URLs defined in config file"},only_alpha_num_allowed:{text:"Search may only contain alpha numeric characters"},no_search_definition:{text:"Search term is empty"},result:{text:"Result"},service_has_error:{text:"--- service has an error ---"},no_time_dimension_in_layer:{text:"No time dimension found in this layer"},no_service_defined:{text:"No service defined"},service_url_empty:{text:"Service URL is empty"},wms_service_exception_code:{text:"WMS Service exception with code "},unnamed_service:{text:"Unnamed service"},add_layers:{text:"Add layers&hellip;",tooltip:"Add new datasets, layers and services"},add_custom_service:{text:"Add a custom version 1.1.1 Web Map Service (WMS)"},properties_for:{text:"Properties for"},color_range:{text:"Color range"},reset:{text:"Reset"},apply:{text:"Apply"},min_value:{text:"Min value"},max_value:{text:"Max value"},wms_version:{text:"WMS version"},wms_comp_mode:{text:"WMS 1.3.0 BBOX compatibility mode"},projections:{text:"Projections"},projection:{text:"Projection"},epsg_code:{text:"EPSG Code"},bounding_box:{text:"Bounding Box"},file_metadata:{text:"File metadata"},show_file_metadata:{text:"Show file metadata"},download_data_wcs:{text:"Download data via WCS"},coordinate_reference_system:{text:"Coordinate reference system"},area_bounding_box:{text:"Area / Bounding box"},dimensions:{text:"Dimensions"},dimension:{text:"Dimension"},formats:{text:"Formats"},north:{text:"North"},west:{text:"West"},east:{text:"East"},south:{text:"South"},cell_size:{text:"Cell size"},x_resolution:{text:"X Resolution"},y_resolution:{text:"Y Resolution"},raster_size:{text:"Raster size"},raster_width:{text:"Raster width"},raster_height:{text:"Raster height"},format:{text:"Format"},show:{text:"Show"},create_permanent_links:{text:"Create permanent links"},please_select_product:{text:"Please select a product"},no_capability_element_found:{text:"No Capability element found in service"},no_wms_capability_element_found:{text:"No WMS Capability element found"},no_wms_layer_element_found:{text:"No WMS Layer element found"},settings_and_options:{tooltip:"Settings and options"},show_time_selection_window:{text:"Show time selection window&hellip;"},create_animation:{text:"Create animation&hellip;"},create_link:{text:"Create link&hellip;"},show_debug_information:{text:"Show debug information&hellip;"},add_custom_wms_service:{text:"Add custom WMS service&hellip;"},undo_zoom_pan_action:{text:"Undo zoom/pan action"},redo_zoom_pan_action:{text:"Redo zoom/pan action"},abort_loading:{text:"Abort loading"},about_the_adaguc_viewer:{text:"About the ADAGUC viewer",tooptip:"Display info about the ADAGUC viewer"},about_adaguc:{text:"About ADAGUC"},about_adaguc_more_information:{text:'<br/><br/>Please visit <a target="_blank" href="http://adaguc.knmi.nl/">http://adaguc.knmi.nl/</a> for more information.<div>'},layers:{text:"Layers",tooltip:"Layers"},predefined_areas:{tooltip:"Select predefined areas"},basemaps_overlays:{tooltip:"Select basemaps and overlays"},add_layers_and_services:{text:"Add Layers and Services"},add_new_layer:{tooltip:"Add new layer"},clone_this_layer:{tooltip:"Clone this layer and place it on top of the layerlist"},remove_this_layer:{tooltip:"Remove this layer"},move_layer_up:{tooltip:"Move this layer up in the list and the map view"},move_layer_down:{tooltip:"Move this layer down in the list and the map view"},title:{text:"Title"},layer:{text:"Layer"},type:{text:"Type"},name:{text:"Name"},abstract:{text:"Abstract"},service:{text:"Service"},description:{text:"Description"},no_dimensions_available:{text:"No layers with a time dimension available."},load_all:{text:"Load all"},play_animation:{text:"Play animation"},stop:{text:"Stop"},start:{text:"Start"},opacity:{text:"Opacity:"},zoom_to_this_layer:{tooltip:"Zoom to this layer"},start_or_stop_animation:{tooltip:"Start or stop animation"},reload_this_layer:{tooltip:"Reload this layer"},layer_properties:{tooltip:"Layer properties"},hide_or_display_layer:{tooltip:"Hide or display this layer"},select_layer_product_from_service:{tooltip:"Select a layer or product from the service"},change_style_layer:{tooltip:"Change the style of this layer"},available_styles:{text:"Available styles"},no_styles_available:{text:"No styles available"},default:{text:"Default"},embed:{text:"Embed"},time_selection:{text:"Time selection"},local_time:{text:"Local time"},year:{text:"Year"},month:{text:"Month"},day:{text:"Day"},hour:{text:"Hour"},min:{text:"Min"},select_layer:{text:"Select layer"},select_dimension:{text:"Select dimension"},start_at:{text:"Start at"},number_of_steps:{text:"Number of steps"},delay_ms:{text:"Delay (ms)"},enter_wms_version_url:{text:"Enter WMS version 1.1.1 URL here..."},enter_search_term:{text:"Enter your location here&hellip;"},not_available_message:{text:"Not available"}};function P(e,t){for(var i=0;i<t.length;i++){var s=t[i];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}var R=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,i,n;return t=e,(i=[{key:"closeAllDialogs",value:function(e){for(var t=0;t<e.length;t++)e[t].remove();e=[]}},{key:"createDialog",value:function(e,t,i,n){var a=0,r=0,h=!0,l=!0;Object(o.n)(e.show)&&(h=e.show),Object(o.n)(e.x)&&(a=e.x),Object(o.n)(e.y)&&(r=e.y),Object(o.n)(e.autoDestroy)&&(l=e.autoDestroy);var u=s("<div />",{css:{minHeight:"20px",height:180,width:320,zIndex:1e3,border:"1px solid #01405e",borderRadius:"3px",position:"absolute",boxShadow:"0.06rem 0.125rem 0.125rem rgba(0, 0, 0, 0.3)",margin:0,padding:"0px",backgroundColor:"#01547d",display:"inline-block"},mousedown:function(e){e.stopPropagation&&e.stopPropagation(),Object(o.p)(e)},mousewheel:function(e){e.stopPropagation&&e.stopPropagation()}});h&&u.appendTo(t),u.hasBeenDragged=!1,u.on("drag",function(e,t){u.hasBeenDragged=!0}),u.resizable(),u.draggable(),u.closeDialog=function(){!1===l?(u.hide(),u.trigger("hide")):u.remove()},u.keyup(function(e){27===e.keyCode&&u.closeDialog()}),s("<div/>",{css:{color:"white",fontWeight:"bold",textColor:"white",width:"16px",height:"16px",lineHeight:"14px",margin:"1px",padding:"1px !important",zIndex:1200},click:function(){u.closeDialog()}}).appendTo(u).button({label:"X"}).addClass("wmjsdialog-closebutton");var d=s("<div/>",{css:{position:"absolute",right:"0px",top:"18px",background:"#FFF",borderTop:"1px solid #01405e",width:"100%",height:"100%",overflow:"auto",fontSize:"10px",lineHeight:"12px"},mousedown:function(e){Object(o.p)(e)}}).appendTo(u);if(u.resize(function(){d.css({width:u.width()+"px",height:u.height()-18+"px"})}),u.resize(),u.setLoading=function(){d.html('<img style="margin-left:10px;margin-top:10px;" src="'+n+'"/>')},u.setXY=function(e,t){u.hasBeenDragged=!1,u.css({left:e+"px",top:t+"px"});var s=i.getGeoCoordFromPixelCoord({x:e,y:t});u.geoPosX=s.x,u.geoPosY=s.y,u.x=e,u.y=t},u.setXY(a,r),u.origX=a,u.origY=r,u.setLoading(),u.setHTML=function(e){d.html(e)},Object(o.n)(e.dataURL)){var c=function(e){d.html(e)};Object(o.a)(e.dataURL,c,c)}return u}}])&&P(t.prototype,i),n&&P(t,n),e}();function X(e){return(X="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function U(e,t){for(var i=0;i<t.length;i++){var s=t[i];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}function F(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var A=function(e){0},W=function(e){0},V=0,z=new d(360,"wmjslegendbuffer"),G=new d(360,"wmjsimagebuffer"),N=new d(360,"wmjsimagebuffer",{randomizer:!1}),q=function e(t,i){F(this,e),this.layer=t,this.data=i},Y=function(){function e(t,i){F(this,e),this.WebMapJSMapVersion="3.2.7",this.base="./",this.noimage=void 0,this.showDialog=!0,this.loadingImageSrc=void 0,this.WMSControlsImageSrc=void 0,this.mainElement=t,this.baseDiv=void 0,this.mainTimeSlider=void 0,this.srs=void 0,this.resizeBBOX=new v,this.defaultBBOX=new v,this.width=2,this.height=2,this.layers=[],this.busy=0,this.mapdimensions=[],this.baseLayers="",this.numBaseLayers=0,this._map=this,this.renderer="WMJSCanvasBuffer",this.layersBusy=0,this.mapBusy=!1,this.hasGeneratedId=!1,this.divZoomBox=document.createElement("div"),this.divBoundingBox=document.createElement("div"),this.divDimInfo=document.createElement("div"),this.divMapPin={displayMapPin:!0},this._displayLegendInMap=!0,this.messageDiv=void 0,this.timeoffsetContainerDiv=void 0,this.timeoffsetDiv=void 0,this.bbox=new v,this.updateBBOX=new v,this.loadedBBOX=new v,this.loadingBBOX=new v,this.drawnBBOX=new v,this.updateSRS="",this.divBuffer=[],this.mapHeader={height:0,fill:{color:"#EEE",opacity:.4},hover:{color:"#017daf",opacity:.9},selected:{color:"#017daf",opacity:1},hoverSelected:{color:"#017daf",opacity:1},cursorSet:!1,prevCursor:"default",hovering:!1},this.currentCursor="default",this.mapIsActivated=!1,this.isMapHeaderEnabled=!1,this.showScaleBarInMap=!0,this.mouseHoverAnimationBox=!1,this.loadingDiv=s('<div class="WMJSDivBuffer-loading"/>',{}),this.initialized=0,this.newSwapBuffer=0,this.currentSwapBuffer=1,this.suspendDrawing=!1,this.activeLayer=void 0,this.MaxUndos=3,this.NrOfUndos=0,this.UndoPointer=0,this.DoUndo=0,this.DoRedo=0,this.NrRedos=0,this.NrUndos=0,this.WMJSProjection_undo=new Array(this.MaxUndos),this.WMJSProjection_tempundo=new Array(this.MaxUndos);for(var n=0;n<this.MaxUndos;n++)this.WMJSProjection_undo[n]=new y,this.WMJSProjection_tempundo[n]=new y;this.inlineGetFeatureInfo=!0,this.callBack=new B,this.setBaseURL("./"),this.gfiDialogList=[],this.legendBusy=!1,this.setTimeOffsetValue="",this.setMessageValue="",this.canvasErrors=[],this.resizeWidth=-1,this.resizeHeight=-1,this._resizeTimerBusy=!1,this._resizeTimer=new w,this.zoomBeforeLoadBBOX=void 0,this.srsBeforeLoadBBOX=void 0,this.drawTimer=new S,this.drawTimerBusy=!1,this.drawTimerPending=!1,this.drawTimerAnimationList=void 0,this.wmjsAnimate=void 0,this.loadingDivTimer=new w,this.mouseWheelBusy=0,this.flyZoomToBBOXTimerStart=1,this.flyZoomToBBOXTimerSteps=5,this.flyZoomToBBOXTimerLoop=void 0,this.flyZoomToBBOXTimer=new S,this.flyZoomToBBOXScaler=0,this.flyZoomToBBOXCurrent=new v,this.flyZoomToBBOXFly=new v,this.flyZoomToBBOXNew=new v,this.flyZoomToBBOXContinueNew=new v,this.flyZoomToBBOXTimerFuncBusy=0,this.flyZoomToBBOXTimerFuncBusyAndContinue=0,this.mouseWheelEventBBOXCurrent=new v,this.mouseWheelEventBBOXNew=new v,this.pinchStart1=void 0,this.pinchStart2=void 0,this.pinchBox=void 0,this.mouseX=0,this.mouseY=0,this.mouseDownX=-1e4,this.mouseDownY=-1e4,this.mouseUpX=1e4,this.mouseUpY=1e4,this.mouseDragging=0,this.controlsBusy=!1,this.mouseDownPressed=0,this.elementPosition=void 0,this.mapMode="pan",this.numGetFeatureInfoRequests=0,this.getFeatureInfoResult=[],this.numGetPointInfoRequests=0,this.getPointInfoResult=[],this.getPointInfoBusy=!1,this.requestProxy=void 0,this.oldMapMode=void 0,this.InValidMouseAction=0,this.resizingBBOXCursor=!1,this.resizingBBOXEnabled=!1,this.mouseGeoCoordXY=void 0,this.mouseUpdateCoordinates=void 0,this.mapPanning=0,this.mapPanStartGeoCoords=void 0,this.mapZooming=0,this.proj4={},this.proj4.srs="empty",this.proj4.projection=void 0,this.longlat="EPSG:4326",a.defs(f),this.knmiGeoNamesURL=void 0,this.geoNamesURL=void 0,this.defaultUsernameSearch="adaguc",this.setDebugFunction=function(e){A=e},this.setErrorFunction=function(e){W=e},this.setBaseURL=this.setBaseURL.bind(this),this.showDialogs=this.showDialogs.bind(this),this.setXML2JSONURL=this.setXML2JSONURL.bind(this),this.setWMJSTileRendererTileSettings=this.setWMJSTileRendererTileSettings.bind(this),this.getLegendStore=this.getLegendStore.bind(this),this.makeComponentId=this.makeComponentId.bind(this),this.enableInlineGetFeatureInfo=this.enableInlineGetFeatureInfo.bind(this),this.dialogClosed=this.dialogClosed.bind(this),this.closeAllGFIDialogs=this.closeAllGFIDialogs.bind(this),this.onLegendCallbackFunction=this.onLegendCallbackFunction.bind(this),this.loadLegendInline=this.loadLegendInline.bind(this),this.setMessage=this.setMessage.bind(this),this.setTimeOffset=this.setTimeOffset.bind(this),this.init=this.init.bind(this),this.rebuildMapDimensions=this.rebuildMapDimensions.bind(this),this.getLayerByServiceAndName=this.getLayerByServiceAndName.bind(this),this.getLayers=this.getLayers.bind(this),this.setLayer=this.setLayer.bind(this),this.setActive=this.setActive.bind(this),this.setActiveLayer=this.setActiveLayer.bind(this),this.calculateNumBaseLayers=this.calculateNumBaseLayers.bind(this),this.enableLayer=this.enableLayer.bind(this),this.disableLayer=this.disableLayer.bind(this),this.toggleLayer=this.toggleLayer.bind(this),this.displayLayer=this.displayLayer.bind(this),this._getLayerIndex=this._getLayerIndex.bind(this),this.removeAllLayers=this.removeAllLayers.bind(this),this.deleteLayer=this.deleteLayer.bind(this),this.moveLayerDown=this.moveLayerDown.bind(this),this.swapLayers=this.swapLayers.bind(this),this.moveLayerUp=this.moveLayerUp.bind(this),this.addLayer=this.addLayer.bind(this),this.getActiveLayer=this.getActiveLayer.bind(this),this.setProjection=this.setProjection.bind(this),this.getBBOX=this.getBBOX.bind(this),this.getProjection=this.getProjection.bind(this),this.getSize=this.getSize.bind(this),this.getWidth=this.getWidth.bind(this),this.getHeight=this.getHeight.bind(this),this.repositionLegendGraphic=this.repositionLegendGraphic.bind(this),this.setSize=this.setSize.bind(this),this._setSize=this._setSize.bind(this),this.getBBOXandProjString=this.getBBOXandProjString.bind(this),this.isTouchDevice=this.isTouchDevice.bind(this),this.getDimensionRequestString=this.getDimensionRequestString.bind(this),this.dateToISO8601=this.dateToISO8601.bind(this),this.buildWMSGetMapRequest=this.buildWMSGetMapRequest.bind(this),this.abort=this.abort.bind(this),this.isBusy=this.isBusy.bind(this),this._makeInfoHTML=this._makeInfoHTML.bind(this),this.getLegendGraphicURLForLayer=this.getLegendGraphicURLForLayer.bind(this),this.showScaleBar=this.showScaleBar.bind(this),this.hideScaleBar=this.hideScaleBar.bind(this),this.getMaxNumberOfAnimations=this.getMaxNumberOfAnimations.bind(this),this.drawLastTimes=this.drawLastTimes.bind(this),this.drawAutomatic=this.drawAutomatic.bind(this),this.display=this.display.bind(this),this.draw=this.draw.bind(this),this._draw=this._draw.bind(this),this._drawAndLoad=this._drawAndLoad.bind(this),this._drawReady=this._drawReady.bind(this),this._onLayersReadyCallbackFunction=this._onLayersReadyCallbackFunction.bind(this),this._onMapReadyCallbackFunction=this._onMapReadyCallbackFunction.bind(this),this._onResumeSuspendCallbackFunction=this._onResumeSuspendCallbackFunction.bind(this),this._animFrameRedraw=this._animFrameRedraw.bind(this),this.getWMSRequests=this.getWMSRequests.bind(this),this.prefetch=this.prefetch.bind(this),this.getImageStore=this.getImageStore.bind(this),this.isThisRequestLoaded=this.isThisRequestLoaded.bind(this),this._pdraw=this._pdraw.bind(this),this._updateBoundingBox=this._updateBoundingBox.bind(this),this.flipBuffers=this.flipBuffers.bind(this),this.getBackBufferCanvasContext=this.getBackBufferCanvasContext.bind(this),this.getFrontBufferCanvasContext=this.getFrontBufferCanvasContext.bind(this),this.redrawBuffer=this.redrawBuffer.bind(this),this.addBaseLayers=this.addBaseLayers.bind(this),this.setBaseLayers=this.setBaseLayers.bind(this),this.getBaseLayers=this.getBaseLayers.bind(this),this.getNumLayers=this.getNumLayers.bind(this),this.getBaseElement=this.getBaseElement.bind(this),this.flyZoomToBBOXTimerFunc=this.flyZoomToBBOXTimerFunc.bind(this),this.flyZoomToBBOXStop=this.flyZoomToBBOXStop.bind(this),this.flyZoomToBBOXStartZoom=this.flyZoomToBBOXStartZoom.bind(this),this.mouseWheelEvent=this.mouseWheelEvent.bind(this),this.pinchStart=this.pinchStart.bind(this),this.pinchMove=this.pinchMove.bind(this),this.pinchEnd=this.pinchEnd.bind(this),this.destroy=this.destroy.bind(this),this.detachEvents=this.detachEvents.bind(this),this.attachEvents=this.attachEvents.bind(this),this._getCorrectWMSDimName=this._getCorrectWMSDimName.bind(this),this._getMapDimURL=this._getMapDimURL.bind(this),this._buildLayerDims=this._buildLayerDims.bind(this),this.getMapMode=this.getMapMode.bind(this),this.getWMSMetaDataRequestURL=this.getWMSMetaDataRequestURL.bind(this),this.getPointInfoRequestURL=this.getPointInfoRequestURL.bind(this),this.getWMSGetFeatureInfoRequestURL=this.getWMSGetFeatureInfoRequestURL.bind(this),this.featureInfoRequestReady=this.featureInfoRequestReady.bind(this),this.newGetPointInfo=this.newGetPointInfo.bind(this),this.getPointInfo=this.getPointInfo.bind(this),this.newGetFeatureInfo=this.newGetFeatureInfo.bind(this),this.getFeatureInfo=this.getFeatureInfo.bind(this),this.getGetFeatureInfoObjectAsHTML=this.getGetFeatureInfoObjectAsHTML.bind(this),this.getMapPinXY=this.getMapPinXY.bind(this),this.positionMapPinByLatLon=this.positionMapPinByLatLon.bind(this),this.repositionMapPin=this.repositionMapPin.bind(this),this.setMapPin=this.setMapPin.bind(this),this.isMapPinVisible=this.isMapPinVisible.bind(this),this.showMapPin=this.showMapPin.bind(this),this.hideMapPin=this.hideMapPin.bind(this),this.setMapModeGetInfo=this.setMapModeGetInfo.bind(this),this.setMapModeZoomBoxIn=this.setMapModeZoomBoxIn.bind(this),this.setMapModeZoomOut=this.setMapModeZoomOut.bind(this),this.setMapModePan=this.setMapModePan.bind(this),this.setMapModePoint=this.setMapModePoint.bind(this),this.setMapModeNone=this.setMapModeNone.bind(this),this.getMouseCoordinatesForDocument=this.getMouseCoordinatesForDocument.bind(this),this.getMouseCoordinatesForElement=this.getMouseCoordinatesForElement.bind(this),this.mouseDown=this.mouseDown.bind(this),this._checkInvalidMouseAction=this._checkInvalidMouseAction.bind(this),this.updateMouseCursorCoordinates=this.updateMouseCursorCoordinates.bind(this),this.mouseDownEvent=this.mouseDownEvent.bind(this),this.mouseMoveEvent=this.mouseMoveEvent.bind(this),this.mouseUpEvent=this.mouseUpEvent.bind(this),this.mouseMove=this.mouseMove.bind(this),this.mouseUp=this.mouseUp.bind(this),this._mouseDragStart=this._mouseDragStart.bind(this),this.mouseDrag=this.mouseDrag.bind(this),this.mouseDragEnd=this.mouseDragEnd.bind(this),this._mapPanStart=this._mapPanStart.bind(this),this._mapPan=this._mapPan.bind(this),this._mapPanEnd=this._mapPanEnd.bind(this),this._mapZoomStart=this._mapZoomStart.bind(this),this._mapZoom=this._mapZoom.bind(this),this._mapZoomEnd=this._mapZoomEnd.bind(this),this.setCursor=this.setCursor.bind(this),this.getId=this.getId.bind(this),this.zoomTo=this.zoomTo.bind(this),this.pixelCoordinatesToXY=this.pixelCoordinatesToXY.bind(this),this.getGeoCoordFromPixelCoord=this.getGeoCoordFromPixelCoord.bind(this),this.getProj4=this.getProj4.bind(this),this.getPixelCoordFromLatLong=this.getPixelCoordFromLatLong.bind(this),this.WCJSSearchRequest=this.WCJSSearchRequest.bind(this),this.WCJSSearchRequestGeoNames=this.WCJSSearchRequestGeoNames.bind(this),this.calculateBoundingBoxAndZoom=this.calculateBoundingBoxAndZoom.bind(this),this.getLatLongFromPixelCoord=this.getLatLongFromPixelCoord.bind(this),this.getPixelCoordFromGeoCoord=this.getPixelCoordFromGeoCoord.bind(this),this.addListener=this.addListener.bind(this),this.removeListener=this.removeListener.bind(this),this.getListener=this.getListener.bind(this),this.suspendEvent=this.suspendEvent.bind(this),this.resumeEvent=this.resumeEvent.bind(this),this.getDimensionList=this.getDimensionList.bind(this),this.getDimension=this.getDimension.bind(this),this.setDimension=this.setDimension.bind(this),this.setLayerOpacity=this.setLayerOpacity.bind(this),this.zoomToLayer=this.zoomToLayer.bind(this),this.setPreviousExtent=this.setPreviousExtent.bind(this),this.setNextExtent=this.setNextExtent.bind(this),this.setBBOX=this.setBBOX.bind(this),this.zoomOut=this.zoomOut.bind(this),this.zoomIn=this.zoomIn.bind(this),this.searchForLocation=this.searchForLocation.bind(this),this.displayLegendInMap=this.displayLegendInMap.bind(this),this.showBoundingBox=this.showBoundingBox.bind(this),this.hideBoundingBox=this.hideBoundingBox.bind(this),this.clearImageStore=this.clearImageStore.bind(this),this.init()}var t,i,r;return t=e,(i=[{key:"setBaseURL",value:function(e){this.base=e,this.noimage=this.base+"/img/blank.gif?",this.loadingImageSrc=this.base+"/img/ajax-loader.gif",this.WMSControlsImageSrc=this.base+"/img/mapcontrols.gif"}},{key:"showDialogs",value:function(e){this.showDialog=e}},{key:"setXML2JSONURL",value:function(e){this.xml2jsonrequest=e}},{key:"setWMJSTileRendererTileSettings",value:function(e){this.tileRenderSettings=e}},{key:"getLegendStore",value:function(){return z}},{key:"makeComponentId",value:function(e){return this.mainElement.id||(this.mainElement.id="WebMapJSMapNo_"+V),!1===this.hasGeneratedId&&(this.hasGeneratedId=!0,V++),this.mainElement.id+"_"+e}},{key:"enableInlineGetFeatureInfo",value:function(e){this.inlineGetFeatureInfo=e}},{key:"dialogClosed",value:function(e){for(var t=0;t<this.gfiDialogList.length;t++)this.gfiDialogList[t]===e&&(this.gfiDialogList.splice(t,1),t--)}},{key:"closeAllGFIDialogs",value:function(){(new R).closeAllDialogs(this.gfiDialogList)}},{key:"onLegendCallbackFunction",value:function(){this.loadLegendInline()}},{key:"loadLegendInline",value:function(e){}},{key:"setMessage",value:function(e){this.setMessageValue=e&&""!==e?e:""}},{key:"setTimeOffset",value:function(e){this.setTimeOffsetValue=e&&""!==e?e:""}},{key:"init",value:function(){var e=this;try{geoNamesURL&&(this.geoNamesURL=geoNamesURL)}catch(e){}try{defaultUsernameSearch&&(this.defaultUsernameSearch=defaultUsernameSearch)}catch(e){}try{xml2jsonrequestURL&&this.setXML2JSONURL(xml2jsonrequestURL)}catch(e){}try{WMJSTileRendererTileSettings&&this.setWMJSTileRendererTileSettings(WMJSTileRendererTileSettings)}catch(e){}this.mainElement.style.height||(this.mainElement.style.height="1px"),this.mainElement.style.width||(this.mainElement.style.width="1px"),this.baseDivId=this.makeComponentId("baseDiv"),s("<div/>",{id:this.baseDivId,css:{position:"relative",overflow:"hidden",width:this.mainElement.clientWidth,height:this.mainElement.clientHeight,border:"0px  solid black",margin:0,padding:0,clear:"both",left:"0px",top:"0px"}}).appendTo(this.mainElement),this.baseDiv=s("#"+this.baseDivId),this.baseDiv.css("cursor","default"),this.mainElement.style.margin="0px",this.mainElement.style.padding="0px",this.mainElement.style.border="none",this.mainElement.style.lineHeight="0px",this.mainElement.style.display="inline-block",this.divZoomBox.style.position="absolute",this.divZoomBox.style.display="none",this.divZoomBox.style.border="2px dashed #000000",this.divZoomBox.style.margin="0px",this.divZoomBox.style.padding="0px",this.divZoomBox.style.lineHeight="0",this.divZoomBox.style.background="#AFFFFF",this.divZoomBox.style.opacity="0.3",this.divZoomBox.style.filter="alpha(opacity=30)",this.divZoomBox.style.left="0px",this.divZoomBox.style.top="0px",this.divZoomBox.style.width="100px",this.divZoomBox.style.height="100px",this.divZoomBox.style.zIndex=1e3,this.divZoomBox.oncontextmenu=function(){return!1},this.baseDiv.append(this.divZoomBox),this.divBoundingBox.style.position="absolute",this.divBoundingBox.style.display="none",this.divBoundingBox.style.border="3px solid #6060FF",this.divBoundingBox.style.margin="0px",this.divBoundingBox.style.padding="0px",this.divBoundingBox.style.lineHeight="0",this.divBoundingBox.style.left="0px",this.divBoundingBox.style.top="0px",this.divBoundingBox.style.width="100px",this.divBoundingBox.style.height="100px",this.divBoundingBox.style.zIndex=1e3,this.divBoundingBox.oncontextmenu=function(){return!1},this.baseDiv.append(this.divBoundingBox),this.divDimInfo.style.position="absolute",this.divDimInfo.style.zIndex=1e3,this.divDimInfo.style.width="auto",this.divDimInfo.style.height="auto",this.divDimInfo.style.background="none",this.divDimInfo.oncontextmenu=function(){return!1},this.divDimInfo.innerHTML="",this.baseDiv.append(this.divDimInfo),this.baseDiv.append(this.loadingDiv),"undefined"!=typeof defaultUsernameSearch&&(s("<div/>",{id:this.makeComponentId("searchboxdiv"),mousedown:function(e){e.stopPropagation()}}).addClass("webmapjs_searchboxdiv").html("<input class='webmapjs_locationfield' type='text' name='searchtextfield' id='searchtextfield' placeholder="+E.place_search_term.text+" />",{mousedown:function(e){e.stopPropagation(),Object(o.p)(e)}}).appendTo(this.baseDiv),s("<button/>",{id:this.makeComponentId("searchboxbutton"),mousedown:function(e){e.stopPropagation()},click:function(){var t=s("#searchtextfield").val();e.searchForLocation(t)}}).addClass("webmapjs_locationbutton").appendTo(this.baseDiv),s("#searchtextfield").keypress(function(t){if(13===t.which){var i=s("#searchtextfield").val();return e.searchForLocation(i),!1}})),this.attachEvents(),this.bbox.left=-180,this.bbox.bottom=-90,this.bbox.right=180,this.bbox.top=90,this.srs="EPSG:4326",this.setSize(this.mainElement.clientWidth,this.mainElement.clientHeight);for(var t=0;t<2;t++){var i=new T(this.callBack,"imagebuffer",G,this.getWidth(),this.getHeight());G.addLoadEventCallback(i.imageLoadComplete),this.baseDiv.append(i.getBuffer()),this.divBuffer.push(i)}z.addLoadEventCallback(function(){e.draw("legendImageStore loaded")}),this.callBack.addToCallback("display",this.display,!0),this.callBack.addToCallback("draw",function(){console.log("draw event triggered externally, skipping")},!0),N.addLoadEventCallback(function(){e.draw("bgMapImageStore loaded")});this.addListener("beforecanvasstartdraw",function(t){if(e.baseLayers)for(var i=0;i<e.baseLayers.length;i++)if(e.baseLayers[i].enabled&&!1===e.baseLayers[i].keepOnTop){if(e.baseLayers[i].type&&"twms"!==e.baseLayers[i].type)continue;if(!e.tileRenderSettings){console.log("tileRenderSettings not set");continue}e.wmjsTileRenderer.render(e.bbox,e.updateBBOX,e.srs,e.width,e.height,t,N,e.tileRenderSettings,e.baseLayers[i].name)}},!0);var n=function(e,t,i,s,n){e.textBaseline="top",e.fillStyle="#FFF",e.globalAlpha=.75;var a=e.measureText(t).width;e.fillRect(i-8,s-8,a+16,parseInt(n)+14),e.fillStyle="#444",e.globalAlpha=1,e.fillText(t,i,s+2)};this.addListener("beforecanvasdisplay",function(t){!function(t){e.divMapPin.displayMapPin&&I(t,e.divMapPin.x,e.divMapPin.y,"#9090FF","#000");for(var i=0,s=0;s<e.layers.length;s++)if(!1!==e.layers[s].enabled){var a=e.getLegendGraphicURLForLayer(e.layers[s]);if(Object(o.n)(a)){var r=z.getImage(a);if(!1===r.hasError())if(!1===r.isLoaded()&&!1===r.isLoading())r.load();else{var h=r.getElement()[0],l=parseInt(h.width)+4,u=parseInt(h.height)+4;i+=l+4;var d=e.width-i+2,c=e.height-u-2;t.beginPath(),t.fillStyle="#FFFFFF",t.lineWidth=.3,t.globalAlpha=.5,t.strokeStyle="#000000",t.rect(parseInt(d)+.5,parseInt(c)+.5,l,u),t.fill(),t.stroke(),t.globalAlpha=1,t.drawImage(h,d,c)}}}e.isMapHeaderEnabled&&(t.beginPath(),t.rect(0,0,e.width,e.mapHeader.height),!1===e.mapIsActivated?(t.globalAlpha=e.mapHeader.hovering?e.mapHeader.hover.opacity:e.mapHeader.fill.opacity,t.fillStyle=e.mapHeader.hovering?e.mapHeader.hover.color:e.mapHeader.fill.color):(t.globalAlpha=e.mapHeader.hovering?e.mapHeader.hoverSelected.opacity:e.mapHeader.selected.opacity,t.fillStyle=e.mapHeader.hovering?e.mapHeader.hoverSelected.color:e.mapHeader.selected.color),t.fill(),t.globalAlpha=1);for(var m=0;m<e.layers.length;m++)for(var f=0;f<e.layers[m].dimensions.length;f++)"outside range"===e.layers[m].dimensions[f].currentValue?e.canvasErrors.push({linkedInfo:{layer:e.layers[m],message:"Time outside range"}}):"date too early"===e.layers[m].dimensions[f].currentValue?e.canvasErrors.push({linkedInfo:{layer:e.layers[m],message:"Time too early"}}):"date too late"===e.layers[m].dimensions[f].currentValue&&e.canvasErrors.push({linkedInfo:{layer:e.layers[m],message:"Time too late"}});if(e.canvasErrors&&e.canvasErrors.length>0){var p=e.width/2,g=6+15*e.canvasErrors.length,v=e.width-p,y=e.isMapHeaderEnabled?e.mapHeader.height:0;t.beginPath(),t.rect(v,y,v+p,y+g),t.fillStyle="white",t.globalAlpha=.9,t.fill(),t.globalAlpha=1,t.fillStyle="black",t.font="10pt Helvetica";for(var b=0;b<e.canvasErrors.length;b++)if(e.canvasErrors[b].linkedInfo){var _=e.canvasErrors[b].linkedInfo.message?", "+e.canvasErrors[b].linkedInfo.message:"";t.fillText("Layer with title "+e.canvasErrors[b].linkedInfo.layer.title+" failed to load"+_,v+5,y+11+15*b)}else t.fillText("Layer failed to load.",v+5,y+11+15*b);e.canvasErrors=[]}if(""!==e.setTimeOffsetValue&&(t.font="20px Helvetica",n(t,e.setTimeOffsetValue,e.width/2-70,e.height-26,20)),""!==e.setMessageValue&&(t.font="15px Helvetica",n(t,e.setMessageValue,e.width/2-70,2,15)),!0===e.showScaleBarInMap){var x=function(){var t=0,i=1e-7,s=e.updateBBOX.right-e.updateBBOX.left,n=e.width/s;if(!(n<=0)){var a=25/n,o=0;do{if(0==(o=a/(i*=10)))return;t=25/o}while(t<25);do{if(0==(o=a/(i/=2)))return;t=25/o}while(t>25);do{if(0==(o=a/(i*=1.2)))return;t=25/o}while(t<25);var r=i,h=Math.pow(10,Math.round(Math.log10(i)+.5)-1);return(r=Math.round(r/h))<2.5&&(r=2.5),r>2.5&&r<7.5&&(r=5),r>7.5&&(r=10),t=25/(o=25/n/(r*=h)),{width:parseInt(t),mapunits:r}}}();if(x){var B=e.height-25.5;t.beginPath(),t.lineWidth=2.5,t.fillStyle="#000",t.strokeStyle="#000",t.font="9px Helvetica",t.textBaseline="middle";for(var w=0;w<2;w++)t.moveTo(7.5,21-w+B),t.lineTo(2*x.width+7.5+1,21-w+B);var L=parseInt(Math.round(x.width/5));t.lineWidth=.5;for(var S=1;S<5;S++)t.moveTo(7.5+L*S,21+B),t.lineTo(7.5+L*S,16+B);t.lineWidth=1,t.moveTo(7.5,21+B),t.lineTo(7.5,14+B),t.moveTo(7.5+x.width,21+B),t.lineTo(7.5+x.width,14+B),t.moveTo(7.5+2*x.width+1,21+B),t.lineTo(7.5+2*x.width+1,14+B);var k="";"EPSG:3411"===e.srs&&(k="meter"),"EPSG:3412"===e.srs&&(k="meter"),"EPSG:3575"===e.srs&&(k="meter"),"EPSG:4326"===e.srs&&(k="degrees"),"EPSG:28992"===e.srs&&(k="meter"),"EPSG:32661"===e.srs&&(k="meter"),"EPSG:3857"===e.srs&&(k="meter"),"EPSG:900913"===e.srs&&(k="meter"),"EPSG:102100"===e.srs&&(k="meter"),"meter"===k&&x.mapunits>1e3&&(x.mapunits/=1e3,k="km"),t.fillText("0",4.5,12+B);var T=x.mapunits.toPrecision()+"";t.fillText(T,7.5+x.width-2.5*T.length+0,12+B),T=(2*x.mapunits).toPrecision()+"",t.fillText(T,7.5+2*x.width-2.5*T.length+0,12+B),t.fillText(k,7.5+2*x.width+10,18+B),t.stroke()}}if(t.font="10px Helvetica",t.textBaseline="middle",Object(o.n)(e.mouseGeoCoordXY)){var M=1/Math.pow(10,parseInt(Math.log((e.bbox.right-e.bbox.left)/e.width)/Math.log(10))-2);M<1&&(M=1),t.fillStyle="#000000";var O=Math.round(e.mouseGeoCoordXY.x*M)/M,C=Math.round(e.mouseGeoCoordXY.y*M)/M,D="";"EPSG:3857"===e.srs&&(D="meter"),t.fillText("CoordYX: ("+C+", "+O+") "+D,5,e.height-50)}if(Object(o.n)(e.mouseUpdateCoordinates)){var E=e.getLatLongFromPixelCoord(e.mouseUpdateCoordinates);if(Object(o.n)(E)){t.fillStyle="#000000";var P=Math.round(100*E.x)/100,R=Math.round(100*E.y)/100;t.fillText("Lat/Lon: ("+R.toFixed(2)+", "+P.toFixed(2)+")  degrees",5,e.height-38)}}t.fillStyle="#000000",t.fillText("Map projection: "+e.srs,5,e.height-26),t.font="7px Helvetica",t.fillText("ADAGUC webmapjs "+e.WebMapJSMapVersion,e.width-85,e.height-5)}(t)},!0),this.addListener("canvasonerror",function(t){e.canvasErrors=t},!0),this._updateBoundingBox(this.bbox),this.wmjsAnimate=new O(this),this.wmjsTileRenderer=new D,this.initialized=1}},{key:"rebuildMapDimensions",value:function(){for(var e=0;e<this.mapdimensions.length;e++)this.mapdimensions[e].used=!1;for(var t=0;t<this.layers.length;t++)for(var i=0;i<this.layers[t].dimensions.length;i++){var s=this.layers[t].dimensions[i],n=this.getDimension(s.name);if(Object(o.n)(n))n.used=!0;else{var a=s.clone();a.used=!0,this.mapdimensions.push(a)}}for(var r=0;r<this.mapdimensions.length;r++)!1===this.mapdimensions[r].used&&(this.mapdimensions.splice(r,1),r--);this.callBack.triggerEvent("onmapdimupdate")}},{key:"getLayerByServiceAndName",value:function(e,t){for(var i=0;i<this.layers.length;i++){var s=this.layers[this.layers.length-i-1];if(s.name===t&&s.service===e)return s}}},{key:"getLayers",value:function(){for(var e=[],t=0;t<this.layers.length;t++){var i=this.layers[this.layers.length-t-1];e.push(i)}return e}},{key:"setLayer",value:function(e,t){return console.log("setlayer"),this.addLayer(e,t,e)}},{key:"setActive",value:function(e){this.mapIsActivated=e,this.isMapHeaderEnabled=!0}},{key:"setActiveLayer",value:function(e){this.activeLayer=e,this.loadLegendInline(),this.callBack.triggerEvent("onchangeactivelayer")}},{key:"calculateNumBaseLayers",value:function(){if(this.numBaseLayers=0,this.baseLayers)for(var e=0;e<this.baseLayers.length;e++)this.baseLayers[e].enabled&&!1===this.baseLayers[e].keepOnTop&&this.numBaseLayers++}},{key:"enableLayer",value:function(e){e.enabled=!0,this.calculateNumBaseLayers(),this.rebuildMapDimensions(),this.loadLegendInline(!0)}},{key:"disableLayer",value:function(e){e.enabled=!1,this.calculateNumBaseLayers(),this.rebuildMapDimensions(),this.loadLegendInline(!0)}},{key:"toggleLayer",value:function(e){!0===e.enabled?e.enabled=!1:e.enabled=!0,this.calculateNumBaseLayers(),this.rebuildMapDimensions(),this.loadLegendInline(!0)}},{key:"displayLayer",value:function(e,t){e.enabled=t,this.calculateNumBaseLayers(),this.rebuildMapDimensions(),this.loadLegendInline(!0)}},{key:"_getLayerIndex",value:function(e){if(e){for(var t=0;t<this.layers.length;t++)if(this.layers[t]===e)return t;return-1}}},{key:"removeAllLayers",value:function(){for(var e=0;e<this.layers.length;++e)this.layers[e].setAutoUpdate(!1);this.layers=[],this.mapdimensions=[],this.callBack.triggerEvent("onlayeradd")}},{key:"deleteLayer",value:function(e){if(!(this.layers.length<=0)){e.setAutoUpdate(!1);var t=this._getLayerIndex(e);if(t>=0){for(var i=t;i<this.layers.length-1;i++)this.layers[i]=this.layers[i+1];this.layers.length--,this.activeLayer=void 0,t>=0&&t<this.layers.length?(this.rebuildMapDimensions(),this.setActiveLayer(this.layers[t])):this.layers.length>0&&(this.rebuildMapDimensions(),this.setActiveLayer(this.layers[this.layers.length-1]))}this.callBack.triggerEvent("onlayerchange"),this.rebuildMapDimensions()}}},{key:"moveLayerDown",value:function(e){var t=this._getLayerIndex(e);if(t>0){var i=this.layers[t-1],s=this.layers[t];i&&s&&(this.layers[t]=i,this.layers[t-1]=s)}else try{W("moveLayerDown: layer '"+e.name+"' not found.")}catch(e){W("moveLayerDown: layer invalid.")}}},{key:"swapLayers",value:function(e,t){var i=this._getLayerIndex(e),s=this._getLayerIndex(t);if(i>=0&&s>=0){var n=this.layers[i],a=this.layers[s];a&&n&&(this.layers[i]=a,this.layers[s]=n)}else try{W("moveLayers: layer '"+e.name+"' not found.")}catch(e){W("moveLayers: layer invalid.")}}},{key:"moveLayerUp",value:function(e){var t=this._getLayerIndex(e);if(t<this.layers.length-1){var i=this.layers[t+1],s=this.layers[t];i&&s&&(this.layers[t]=i,this.layers[t+1]=s)}else try{W("moveLayerUp: layer '"+e.name+"' not found.")}catch(e){W("moveLayerUp: layer invalid.")}}},{key:"addLayer",value:function(e){var t=this;if(Object(o.n)(e)){e.parentMaps.includes(this)||e.parentMaps.push(this),this.layers.push(e);e.parseLayer(function(e){for(var i=0;i<e.dimensions.length;i++){var s=t.getDimension(e.dimensions[i].name);Object(o.n)(s)&&Object(o.n)(s.currentValue)&&!0===e.dimensions[i].linked&&e.dimensions[i].setClosestValue(s.currentValue)}t.rebuildMapDimensions(),t.callBack.triggerEvent("onlayeradd")},void 0,"WMJSLayer::addLayer")}}},{key:"getActiveLayer",value:function(){return this.activeLayer}},{key:"setProjection",value:function(e,t){this.hideMapPin(),e||(e="EPSG:4326"),"object"===X(e)&&(t=e.bbox,e=e.srs),e||(e="EPSG:4326"),this.srs=e,this.updateSRS=this.srs,this.proj4.srs===this.srs&&Object(o.n)(this.proj4.projection)||("GFI:TIME_ELEVATION"===this.srs?this.proj4.projection="EPSG:4326":this.proj4.projection=this.srs,this.proj4.srs=this.srs),this.setBBOX(t),this.defaultBBOX.setBBOX(t),this.updateMouseCursorCoordinates(),this.callBack.triggerEvent("onsetprojection",[this.srs,this.bbox])}},{key:"getBBOX",value:function(){return this.updateBBOX}},{key:"getProjection",value:function(e){return{srs:this.srs,bbox:this.bbox}}},{key:"getSize",value:function(){return{width:this.width,height:this.height}}},{key:"getWidth",value:function(){return this.width}},{key:"getHeight",value:function(){return this.height}},{key:"repositionLegendGraphic",value:function(e){this._displayLegendInMap?this.loadLegendInline(e):this.draw()}},{key:"setSize",value:function(e,t,i){var s=this;if(!(parseInt(e)<4||parseInt(t)<4)){if(this.resizeWidth=parseInt(e),this.resizeHeight=parseInt(t),!0!==i)return!1===this._resizeTimerBusy?(this._resizeTimerBusy=!0,void this._setSize(this.resizeWidth,this.resizeHeight)):void this._resizeTimer.init(200,function(){s._resizeTimerBusy=!1,s._setSize(s.resizeWidth,s.resizeHeight),s.draw("resizeTimer")});this._setSize(this.resizeWidth,this.resizeHeight)}}},{key:"_setSize",value:function(e,t){if(e&&t&&!(parseInt(e)<4||parseInt(t)<4)){0;var i=this.getProjection();this.width=parseInt(e),this.height=parseInt(t),(this.width<4||isNaN(this.width))&&(this.width=4),(this.height<4||isNaN(this.height))&&(this.height=4),i.srs&&i.bbox||(W("this.setSize: Setting default projection (EPSG:4326 with (-180,-90,180,90)"),i.srs="EPSG:4326",i.bbox.left=-180,i.bbox.bottom=-90,i.bbox.right=180,i.bbox.top=90,this.setProjection(i.srs,i.bbox)),this.baseDiv.css({width:this.width,height:this.height}),this.mainElement.style.width=this.width+"px",this.mainElement.style.height=this.height+"px",this.setBBOX(this.resizeBBOX),this.repositionMapPin(),this.showBoundingBox(),this.divBuffer.length>1&&(this.divBuffer[0].resize(this.getWidth(),this.getHeight()),this.divBuffer[1].resize(this.getWidth(),this.getHeight())),this.repositionLegendGraphic(!0),this.divBuffer[this.currentSwapBuffer]&&this.divBuffer[this.currentSwapBuffer].display(),this.callBack.triggerEvent("onresize",[this.width,this.height])}}},{key:"getBBOXandProjString",value:function(e){var t="";return e.version!==m.version100&&e.version!==m.version111||(t+="SRS="+Object(o.c)(this.srs)+"&",t+="BBOX="+this.bbox.left+","+this.bbox.bottom+","+this.bbox.right+","+this.bbox.top+"&"),e.version===m.version130&&(t+="CRS="+Object(o.c)(this.srs)+"&","EPSG:4326"===this.srs&&!1===e.wms130bboxcompatibilitymode?t+="BBOX="+this.bbox.bottom+","+this.bbox.left+","+this.bbox.top+","+this.bbox.right+"&":t+="BBOX="+this.bbox.left+","+this.bbox.bottom+","+this.bbox.right+","+this.bbox.top+"&"),t}},{key:"isTouchDevice",value:function(){return!1}},{key:"getDimensionRequestString",value:function(e){return this._getMapDimURL(e)}},{key:"dateToISO8601",value:function(e){var t=function(e,t){var i,s=e+"",n=t-s.length,a="";for(i=0;i<n;i++)a+="0"+a;return s=a+s};return t(e.getUTCFullYear(),4)+"-"+t(e.getUTCMonth()+1,2)+"-"+t(e.getUTCDate(),2)+"T"+t(e.getUTCHours(),2)+":"+t(e.getUTCMinutes(),2)+":"+t(e.getUTCSeconds(),2)+"Z"}},{key:"buildWMSGetMapRequest",value:function(e){if(Object(o.n)(e.name)&&(e.format||(e.format="image/png",W("layer format missing!")),!(e.name.length<1))){if("GFI:TIME_ELEVATION"===this.srs){var t=e.getmapURL;t+="&SERVICE=WMS&REQUEST=GetFeatureInfo&VERSION="+e.version,t+="&LAYERS="+Object(o.c)(e.name);var i=e.name.split(",");return t+="&QUERY_LAYERS="+Object(o.c)(i[i.length-1]),t+="&BBOX=29109.947643979103,6500000,1190890.052356021,7200000",e.version!==m.version100&&e.version!==m.version111||(t+="&SRS="+Object(o.c)("EPSG:3857")+"&"),e.version===m.version130&&(t+="&CRS="+Object(o.c)("EPSG:3857")+"&"),t+="WIDTH="+this.width,t+="&HEIGHT="+this.height,e.version!==m.version100&&e.version!==m.version111||(t+="&X=707",t+="&Y=557"),e.version===m.version130&&(t+="&I=707",t+="&J=557"),e.sldURL&&(t+="&SLD="+Object(o.c)(e.sldURL)),t+="&FORMAT=image/gif",t+="&INFO_FORMAT=image/png",t+="&STYLES=",t+="&time="+this.dateToISO8601(new Date(this.bbox.left))+"/"+this.dateToISO8601(new Date(this.bbox.right)),t+="&elevation="+this.bbox.bottom+"/"+this.bbox.top}var s=e.getmapURL;s+="&SERVICE=WMS&",s+="VERSION="+e.version+"&",s+="REQUEST=GetMap&",s+="LAYERS="+Object(o.c)(e.name)+"&",s+="WIDTH="+this.width+"&",s+="HEIGHT="+this.height+"&",s+=this.getBBOXandProjString(e),e.sldURL&&(s+="SLD="+Object(o.c)(e.sldURL)+"&"),s+="STYLES="+Object(o.c)(e.currentStyle)+"&",s+="FORMAT="+e.format+"&",!0===e.transparent?s+="TRANSPARENT=TRUE&":s+="TRANSPARENT=FALSE&";try{s+=this._getMapDimURL(e)}catch(e){return}return s+=e.wmsextensions.url}}},{key:"abort",value:function(){this.callBack.triggerEvent("onmapready"),this.mapBusy=!1,this.callBack.triggerEvent("onloadingcomplete")}},{key:"isBusy",value:function(){return!(!0!==this.suspendDrawing&&!this.mapBusy&&1!==this.layersBusy)||(!1===this.divBuffer[0].ready||!1===this.divBuffer[1].ready)}},{key:"_makeInfoHTML",value:function(){try{var e='<table class="myTable">',t=!1;if(e+="<tr><th>Layer</th>",this.mapdimensions)for(var i=0;i<this.mapdimensions.length;i++)e+="<th>"+this.mapdimensions[i].name+"</th>";if(e+="</tr>",e+="<tr><td>Map</tdh>",this.mapdimensions)for(var s=0;s<this.mapdimensions.length;s++)e+="<td>"+this.mapdimensions[s].currentValue+"</td>";e+="</tr>";var n=0;for(n=0;n<this.getNumLayers();n++){var a=this.getNumLayers()-1-n;if(this.layers[a].service&&this.layers[a].enabled){var o=this.layers[a].dimensions;if(o){var r="";e+="<tr><td>"+(r+=this.layers[a].title)+"</td>";for(var h=0;h<this.mapdimensions.length;h++){for(var l=!1,u=0;u<o.length;u++)if(o[u].name.toUpperCase()===this.mapdimensions[h].name.toUpperCase()){e+="<td>"+o[u].currentValue+"</td>",l=!0,t=!0;break}!1===l&&(e+="<td>-</td>")}e+="</tr>"}}}if(e+="</table>",!0===t){this.divDimInfo.style.display="",this.divDimInfo.innerHTML=e;this.divDimInfo.style.width=Math.min(this.width-parseInt(this.divDimInfo.style.marginLeft)-210,350)+"px",this.divDimInfo.style.left="8px",this.divDimInfo.style.top="8px"}else this.divDimInfo.style.display="none"}catch(e){W("Exception"+e)}}},{key:"getLegendGraphicURLForLayer",value:function(e){if(e){var t=e.legendGraphic;if(!t)return;t+="&layers="+Object(o.c)(e.name)+"&";try{!0===e.legendIsDimensionDependant&&(t+=this.getDimensionRequestString(e)+"&"),e.sldURL&&(t+="&SLD="+Object(o.c)(e.sldURL)),t+="&transparent=true&width=90&height=250&"}catch(e){return}return t+=e.wmsextensions.url}}},{key:"showScaleBar",value:function(){this.showScaleBarInMap=!0,console.log("todo showScaleBar")}},{key:"hideScaleBar",value:function(){this.showScaleBarInMap=!1,console.log("todo hideScaleBar")}},{key:"getMaxNumberOfAnimations",value:function(){return 60}},{key:"drawLastTimes",value:function(e,t){if(t||(t="hours"),0!==this.layers.length){var i=this.getActiveLayer();if(i){var s=i.getDimension("time");if(s){for(var a=s.size()-1,o=[],r=n.utc(s.getValueForIndex(a)),h=r.subtract(e,t);a>=0&&(r=s.getValueForIndex(a--))&&"date too early"!==r&&!h.isAfter(n.utc(r));)o.unshift({name:"time",value:r});this.draw(o)}}}}},{key:"drawAutomatic",value:function(e,t){if(0!==this.layers.length){for(var i=e.format("YYYY-MM-DDTHH:mm:ss"),s=[],a=0;n(i)<t&&a<1e3;){a++;for(var o=null,r=this.layers.length-1;r>=0;r--){var h=this.layers[r].getDimension("time");if(h){var l=h.getNextClosestValue(i);l&&"date too early"!==l&&(null===o||n(l)<n(o))&&(o=l)}}if(null===o)break;var u={name:"time",value:o};s.push(u),i=o}if(s.length>0)this.draw(s);else{var d=this.layers[0].getDimension("time");if(!d)return;for(var c=d.size(),m=[],f=c-Math.min(d.size(),100);f<c;++f)m.push({name:d.name,value:d.getValueForIndex(f)});this.draw(m)}}}},{key:"display",value:function(){this.divBuffer[this.currentSwapBuffer].display(this.updateBBOX,this.loadedBBOX),this.drawnBBOX.setBBOX(this.bbox)}},{key:"_animFrameRedraw",value:function(){this._draw(this._animationList)}},{key:"draw",value:function(e){this._animationList=e,this.isAnimating||(this.drawPending?this.needsRedraw=!0:(this.drawPending=!0,this._animFrameRedraw()))}},{key:"_draw",value:function(e){this.drawnBBOX.setBBOX(this.bbox),this._drawAndLoad(e)}},{key:"_drawReady",value:function(){this.drawPending=!1,this.drawBusy=0,this.needsRedraw&&(this.needsRedraw=!1,this.draw(this._animationList))}},{key:"_drawAndLoad",value:function(e){if(this.width<4||this.height<4)this._drawReady();else{if(this.callBack.triggerEvent("beforedraw"),!1===this.isAnimating&&void 0!==e&&"object"===X(e)&&e.length>0){if(e.length>60)return W("Too many animations given, max is 60"),void this.draw("self");this.isAnimating=!0,this.callBack.triggerEvent("onstartanimation",this),this.currentAnimationStep=0,this.animationList=[],this.mouseHoverAnimationBox=!1;for(var t=0;t<e.length;t++){var i={name:e[t].name,value:e[t].value};this.setDimension(e[t].name,e[t].value,!1),i.requests=this.getWMSRequests(),this.animationList.push(i)}this.setDimension(this.animationList[this.currentAnimationStep].name,this.animationList[this.currentAnimationStep].value,!1),this.wmjsAnimate.checkAnimation()}this._pdraw()}}},{key:"_onLayersReadyCallbackFunction",value:function(){this.draw("onlayersready callback")}},{key:"_onMapReadyCallbackFunction",value:function(){A("--\x3e onmapready event called"),this.draw("onmapready callback")}},{key:"_onResumeSuspendCallbackFunction",value:function(){this.draw("onresumesuspend callback")}},{key:"getWMSRequests",value:function(){for(var e=[],t=this.getNumLayers(),i=0;i<t;i++)if(this.layers[i].service&&this.layers[i].enabled){var s=this.buildWMSGetMapRequest(this.layers[i]);s&&e.push(s)}return e}},{key:"prefetch",value:function(e){for(var t=[],i=0;i<e.length;i++){var s=G.getImage(e[i]);!1===s.isLoaded()&&!1===s.isLoading()&&(t.push(s),s.load())}return t}},{key:"getImageStore",value:function(){return G}},{key:"isThisRequestLoaded",value:function(e){var t=G.getImageForSrc(e);return void 0===t?0:t.isLoaded()?2:t.isLoading()?1:void 0}},{key:"_pdraw",value:function(){var e=this;if(0!==this.initialized){if(!0===this.suspendDrawing)return!0===this.callBack.addToCallback("onresumesuspend",this._onResumeSuspendCallbackFunction)&&A("Suspending on onresumesuspend"),void this._drawReady();1!==this.layersBusy?this.mapBusy?!0===this.callBack.addToCallback("onmapready",this._onMapReadyCallbackFunction)&&A("Suspending on onmapready"):(!function(){var t;var i=0;if(e.numBaseLayers=0,e.baseLayers)for(var s=0;s<e.baseLayers.length;s++)if(e.baseLayers[s].enabled&&!1===e.baseLayers[s].keepOnTop){if(e.baseLayers[s].type&&"twms"===e.baseLayers[s].type)continue;e.numBaseLayers++,(t=e.buildWMSGetMapRequest(e.baseLayers[s]))&&(e.divBuffer[e.newSwapBuffer].setSrc(i,t,e.getWidth(),e.getHeight(),{layer:e.baseLayers[s]},e.baseLayers[s].opacity),i++)}for(var n=0;n<e.getNumLayers();n++)if(e.layers[n].service&&e.layers[n].enabled){var a=e.layers[n].dimensions;(t=e.buildWMSGetMapRequest(e.layers[n],a))&&(e.divBuffer[e.newSwapBuffer].setSrc(i,t,e.getWidth(),e.getHeight(),{layer:e.layers[n]},e.layers[n].opacity),e.layers[n].image=e.divBuffer[e.newSwapBuffer].layers[i],i++)}if(e.baseLayers)for(var o=0;o<e.baseLayers.length;o++)e.baseLayers[o].enabled&&!0===e.baseLayers[o].keepOnTop&&(t=e.buildWMSGetMapRequest(e.baseLayers[o]))&&(e.divBuffer[e.newSwapBuffer].setSrc(i,t,e.getWidth(),e.getHeight(),{layer:e.baseLayers[o]},e.baseLayers[o].opacity),i++);e.flipBuffers()}(),this.callBack.triggerEvent("ondrawready",this.map),this.loadLegendInline()):!0===this.callBack.addToCallback("onlayersready",this._onLayersReadyCallbackFunction)&&A("Suspending on onlayersready")}}},{key:"_updateBoundingBox",value:function(e){if(0!==this.divBuffer.length){var t=this.bbox;Object(o.n)(e)&&(t=e),this.updateBBOX.copy(t),this.divBuffer[this.currentSwapBuffer].setBBOX(this.updateBBOX,this.loadedBBOX),this.divBuffer[this.currentSwapBuffer].mapbbox=this.updateBBOX,this.showBoundingBox(this.divBoundingBox.bbox,this.updateBBOX),this.callBack.triggerEvent("onupdatebbox",this.updateBBOX),this.repositionMapPin(e)}}},{key:"flipBuffers",value:function(){var e=this;var t=this.currentSwapBuffer,i=this.newSwapBuffer;this.callBack.triggerEvent("onmapstartloading"),this.mapBusy=!0,this.loadingDivTimer.init(500,function(){e.loadingDiv.show()}),this.loadingBBOX.setBBOX(this.bbox),this.divBuffer[i]&&this.divBuffer[i].load(function(){try{e.divBuffer[t].srs=e.srs,e.divBuffer[i].bbox=e.bbox.clone(),e.divBuffer[i].srs=e.srs,e.loadedBBOX.setBBOX(e.loadingBBOX),e.divBuffer[i].display(e.updateBBOX,e.loadedBBOX),e.divMapPin.oldx=e.divMapPin.exactX,e.divMapPin.oldy=e.divMapPin.exactY,e.divBuffer[t].hide(),e.currentSwapBuffer=i,e.newSwapBuffer=t}catch(e){console.log(e)}e.mapBusy=!1,e.callBack.triggerEvent("onmaploadingcomplete",e),e.callBack.triggerEvent("onloadingcomplete",e),e.callBack.triggerEvent("onmapready",e),e.loadingDiv.hide(),e.loadingDivTimer.stop(),e._drawReady()})}},{key:"getBackBufferCanvasContext",value:function(){return this.divBuffer[this.newSwapBuffer].getCanvasContext()}},{key:"getFrontBufferCanvasContext",value:function(){return this.divBuffer[this.currentSwapBuffer].getCanvasContext()}},{key:"redrawBuffer",value:function(){this.divBuffer[this.currentSwapBuffer].display(),this.drawnBBOX.setBBOX(this.bbox),this.draw()}},{key:"addBaseLayers",value:function(e){if(e){this.numBaseLayers=0,e=Object(o.r)(e),this.baseLayers.push(e);for(var t=0;t<this.baseLayers.length;t++)!0===this.baseLayers.keepOnTop&&this.numBaseLayers++;this.callBack.triggerEvent("onlayeradd")}else this.baseLayers=void 0}},{key:"setBaseLayers",value:function(e){if(e){this.numBaseLayers=0,this.baseLayers=e;for(var t=0;t<this.baseLayers.length;t++)!0===this.baseLayers.keepOnTop&&this.numBaseLayers++;this.callBack.triggerEvent("onlayerchange")}else this.baseLayers=void 0}},{key:"getBaseLayers",value:function(){return this.baseLayers}},{key:"getNumLayers",value:function(){return this.layers.length}},{key:"getBaseElement",value:function(){return this.baseDiv}},{key:"flyZoomToBBOXTimerFunc",value:function(){this.flyZoomToBBOXScaler=this.flyZoomToBBOXTimerLoop/this.flyZoomToBBOXTimerSteps;var e=1-this.flyZoomToBBOXScaler;if(this.flyZoomToBBOXFly.left=this.flyZoomToBBOXCurrent.left*e+this.flyZoomToBBOXNew.left*this.flyZoomToBBOXScaler,this.flyZoomToBBOXFly.bottom=this.flyZoomToBBOXCurrent.bottom*e+this.flyZoomToBBOXNew.bottom*this.flyZoomToBBOXScaler,this.flyZoomToBBOXFly.right=this.flyZoomToBBOXCurrent.right*e+this.flyZoomToBBOXNew.right*this.flyZoomToBBOXScaler,this.flyZoomToBBOXFly.top=this.flyZoomToBBOXCurrent.top*e+this.flyZoomToBBOXNew.top*this.flyZoomToBBOXScaler,this._updateBoundingBox(this.flyZoomToBBOXFly),this.flyZoomToBBOXTimerLoop+=1,this.flyZoomToBBOXTimerLoop>this.flyZoomToBBOXTimerSteps)return this.flyZoomToBBOXTimerLoop=this.flyZoomToBBOXTimerStart,this.setBBOX(this.flyZoomToBBOXFly),this.display(),void(0===this.flyZoomToBBOXTimerFuncBusyAndContinue?(this.flyZoomToBBOXTimerFuncBusyAndContinue=0,this.flyZoomToBBOXTimerFuncBusy=0,this.draw("flyZoomToBBOXTimerFunc")):(this.flyZoomToBBOXTimerFuncBusyAndContinue=0,this.flyZoomToBBOXTimerFuncBusy=0,this.flyZoomToBBOXStartZoom(this.updateBBOX,this.flyZoomToBBOXContinueNew)));this.flyZoomToBBOXTimer.init(10,this.flyZoomToBBOXTimerFunc)}},{key:"flyZoomToBBOXStop",value:function(e,t){this.flyZoomToBBOXTimerFuncBusy&&this.setBBOX(this.flyZoomToBBOXFly),this.flyZoomToBBOXTimerFuncBusyAndContinue=0,this.flyZoomToBBOXTimerFuncBusy=0,this.flyZoomToBBOXTimer.stop()}},{key:"flyZoomToBBOXStartZoom",value:function(e,t){if(1===this.flyZoomToBBOXTimerFuncBusy)return this.flyZoomToBBOXContinueNew.copy(t),void(this.flyZoomToBBOXTimerFuncBusyAndContinue=1);this.flyZoomToBBOXCurrent.copy(e),this.flyZoomToBBOXNew.copy(t),this.flyZoomToBBOXTimerLoop=this.flyZoomToBBOXTimerStart,this.flyZoomToBBOXTimerFuncBusyAndContinue=0,0===this.flyZoomToBBOXTimerFuncBusy&&(this.flyZoomToBBOXTimerFuncBusy=1,this.flyZoomToBBOXTimerFunc())}},{key:"mouseWheelEvent",value:function(e){if(Object(o.p)(e),1!==this.mouseWheelBusy){var t=-e.deltaY;this.mouseWheelBusy=1;var i,s,n=this.updateBBOX.right-this.updateBBOX.left,a=this.updateBBOX.bottom-this.updateBBOX.top,r=this.getGeoCoordFromPixelCoord({x:this.mouseX,y:this.mouseY},this.drawnBBOX),h=(r.x-this.updateBBOX.left)/n,l=(r.y-this.updateBBOX.top)/a;t<0?(i=-.25*n,s=-.25*a):(i=.2*n,s=.2*a);var u=this.updateBBOX.left+i,d=this.updateBBOX.top+s,c=this.updateBBOX.right-i,m=this.updateBBOX.bottom-s,f=l*(m-d)+d,p=h*(c-u)+u-r.x,g=f-r.y;u-=p,c-=p,d-=g,m-=g,this.mouseWheelEventBBOXCurrent.copy(this.updateBBOX),this.mouseWheelEventBBOXNew.left=u,this.mouseWheelEventBBOXNew.bottom=m,this.mouseWheelEventBBOXNew.right=c,this.mouseWheelEventBBOXNew.top=d,this.mouseWheelBusy=0,this.flyZoomToBBOXStartZoom(this.mouseWheelEventBBOXCurrent,this.mouseWheelEventBBOXNew)}}},{key:"pinchStart",value:function(e,t,i){this.pinchStart1={x:i.pointers[0].clientX,y:i.pointers[0].clientY},this.pinchStart2={x:i.pointers[1].clientX,y:i.pointers[1].clientY},this.pinchBox=this.bbox.clone(),this.controlsBusy=!0,this.mouseDownPressed=0,this.mouseDragging=1,this.mouseWheelBusy=1}},{key:"pinchMove",value:function(e,t,i){this.mouseDownPressed=0,this.pinchMove1={x:i.pointers[0].clientX,y:i.pointers[0].clientY},this.pinchMove2={x:i.pointers[1].clientX,y:i.pointers[1].clientY};var s=this.pinchMove2.x-this.pinchMove1.x,n=this.pinchStart2.x-this.pinchStart1.x,a=this.pinchMove2.y-this.pinchMove1.y,o=this.pinchStart2.y-this.pinchStart1.y;if(0===n&&(n=1),0===o&&(o=1),s*s>a*a){var r=s/n,h=(this.width-this.pinchMove1.x)/r+this.pinchStart1.x,l=this.pinchStart1.x-this.pinchMove1.x/r;this.bbox.right=h/this.width*(this.pinchBox.right-this.pinchBox.left)+this.pinchBox.left,this.bbox.left=l/this.width*(this.pinchBox.right-this.pinchBox.left)+this.pinchBox.left;var u=(this.pinchBox.right-this.pinchBox.left)/(this.pinchBox.top-this.pinchBox.bottom),d=(this.bbox.top+this.bbox.bottom)/2,c=(this.bbox.left-this.bbox.right)/2/u;this.bbox.bottom=d+c,this.bbox.top=d-c}else{var m=a/o,f=(this.height-this.pinchMove1.y)/m+this.pinchStart1.y,p=this.pinchStart1.y-this.pinchMove1.y/m;this.bbox.bottom=f/this.height*(this.pinchBox.bottom-this.pinchBox.top)+this.pinchBox.top,this.bbox.top=p/this.height*(this.this.pinchBox.bottom-this.pinchBox.top)+this.pinchBox.top;var g=(this.pinchBox.right-this.pinchBox.left)/(this.pinchBox.top-this.pinchBox.bottom),v=(this.bbox.right+this.bbox.left)/2,y=(this.bbox.bottom-this.bbox.top)/2*g;this.bbox.left=v+y,this.bbox.right=v-y}this._updateBoundingBox(this.bbox)}},{key:"pinchEnd",value:function(e,t,i){this.controlsBusy=!1,this.mouseDownPressed=0,this.mouseDragging=0,this.mouseWheelBusy=0,this.zoomTo(this.bbox),this.draw("pinchEnd")}},{key:"destroy",value:function(){this.stopAnimating();for(var e=this.layers.length-1;e>=0;e--)this.layers[e].setAutoUpdate(!1);this.detachEvents(),this.callBack.destroy()}},{key:"detachEvents",value:function(){this.baseDiv.off("mousedown"),Object(o.q)(s(this.baseDiv).get(0),this.mouseWheelEvent),Object(o.j)(document,"mouseup",this.mouseUpEvent),Object(o.j)(document,"mousemove",this.mouseMoveEvent)}},{key:"attachEvents",value:function(){var e=this;this.baseDiv.on("mousedown",this.mouseDownEvent),Object(o.f)(s(this.baseDiv).get(0),this.mouseWheelEvent),Object(o.g)(document,"mouseup",this.mouseUpEvent),Object(o.g)(document,"mousemove",this.mouseMoveEvent),this.isTouchDevice()&&(this.enableInlineGetFeatureInfo(!1),mc.on("panstart",function(t){t.preventDefault(),e.mouseDown(t.center.x,t.center.y,t)}),mc.on("panmove",function(t){t.preventDefault(),e.mouseMove(t.center.x,t.center.y,t)}),mc.on("panend",function(t){t.preventDefault(),e.mouseUp(t.center.x,t.center.y,t)}),mc.on("pinchstart",function(t){t.preventDefault(),e.pinchStart(t.center.x,t.center.y,t)}),mc.on("pinchmove",function(t){t.preventDefault(),e.pinchMove(t.center.x,t.center.y,t)}),mc.on("pinchend",function(t){t.preventDefault(),e.pinchEnd(t.center.x,t.center.y,t)})),this.setMapModePan()}},{key:"_getCorrectWMSDimName",value:function(e){return"TIME"===e.toUpperCase()?e:"ELEVATION"===e.toUpperCase()?e:"DIM_"+e}},{key:"_getMapDimURL",value:function(e){for(var t="",i=0;i<e.dimensions.length;i++){var s=e.dimensions[i].getValue();if(t+="&"+this._getCorrectWMSDimName(e.dimensions[i].name),t+="="+Object(o.c)(s),"outside range"===s||"date too early"===s||"date too late"===s)throw"outside range"}return t}},{key:"_buildLayerDims",value:function(){if(!0!==this.buildLayerDimsBusy)for(var e=0;e<this.mapdimensions.length;e++)for(var t=this.mapdimensions[e],i=0;i<this.layers.length;i++)for(var s=0;s<this.layers[i].dimensions.length;s++){var n=this.layers[i].dimensions[s];!0===n.linked&&n.name===t.name&&("current"!==t.currentValue&&"default"!==t.currentValue&&""!==t.currentValue&&"earliest"!==t.currentValue&&"middle"!==t.currentValue&&"latest"!==t.currentValue||(t.currentValue=n.getClosestValue(t.currentValue)),this.buildLayerDimsBusy=!0,n.setClosestValue(t.currentValue),this.buildLayerDimsBusy=!1)}}},{key:"getMapMode",value:function(){return this.mapMode}},{key:"getWMSMetaDataRequestURL",value:function(e){var t=e.service;t+="&SERVICE=WMS&REQUEST=GetMetaData&VERSION="+e.version,t+="&LAYER="+Object(o.c)(e.name),t+="&FORMAT=text/html";try{t+="&"+this._getMapDimURL(e)}catch(e){return}return A('<a target="_blank" href="'+t+'">'+t+"</a>",!1),t}},{key:"getPointInfoRequestURL",value:function(e,t,i,s,n){var a=s;a+="&GRAPHSTYLE="+n,a+="&"+this.getBBOXandProjString(e),a+="&LAYERS="+Object(o.c)(e.name),a+="WIDTH="+this.width,a+="&HEIGHT="+this.height,a+="&X="+t,a+="&Y="+i,a+="&FORMAT=image/png",a+="&INFO_FORMAT=text/html",a+="&STYLES=";try{a+="&"+this._getMapDimURL(e)}catch(e){return}return A('<a target="_blank" href="'+a+'">'+a+"</a>",!1),a}},{key:"getWMSGetFeatureInfoRequestURL",value:function(e,t,i){var s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"text/html",n=Object(o.e)(e.service);n+="&SERVICE=WMS&REQUEST=GetFeatureInfo&VERSION="+e.version,n+="&LAYERS="+Object(o.c)(e.name);var a=e.name.split(",");n+="&QUERY_LAYERS="+Object(o.c)(a[a.length-1]),n+="&"+this.getBBOXandProjString(e),n+="WIDTH="+this.width,n+="&HEIGHT="+this.height,e.version!==m.version100&&e.version!==m.version111||(n+="&X="+t,n+="&Y="+i),e.version===m.version130&&(n+="&I="+t,n+="&J="+i),n+="&FORMAT=image/gif",n+="&INFO_FORMAT="+s,n+="&STYLES=";try{n+="&"+this._getMapDimURL(e)}catch(e){return}return A('<a target="_blank" href="'+n+'">'+n+"</a>",!1),n}},{key:"featureInfoRequestReady",value:function(e,t){var i;this.numGetFeatureInfoRequests--,i=t?!0===t.queryable?new q(t,e):new q(t,"not queryable"):new q(t,"Query failed..."),this.getFeatureInfoResult.push(i),this.numGetFeatureInfoRequests<=0&&(this.numGetFeatureInfoRequests=0,this.callBack.triggerEvent("ongetfeatureinfoready",this.getFeatureInfoResult))}},{key:"newGetPointInfo",value:function(){A("resuming on ongetpointinfoready"),this.getPointInfo(this.mouseDownX,this.mouseDownY)}},{key:"getPointInfo",value:function(e,t){var i=this;if(this.getPointInfoBusy)return A("suspending on ongetpointinfoready"),void this.addListener("ongetpointinfoready",this.newGetPointInfo,!1);this.getPointInfoBusy=!0,this.callBack.triggerEvent("beforegetpointinfo",{x:e,y:t});var s=this.getGraphingData();if(void 0===s)return W("getPointInfo getGraphingData is undefined"),void(this.getPointInfoBusy=!1);A("getPointInfo("+e+","+t+") "+s.layer.name);var n=this.getPointInfoRequestURL(s.layer,e,t,s.service,s.style);A("GetPointInfo: "+n);var a=new Image;a.loadEvent=function(){i.getPointInfoBusy=!1;var e={};e.url=n,e.layer=s.layer,e.img=a,i.callBack.triggerEvent("ongetpointinfoready",e)},a.src=n}},{key:"newGetFeatureInfo",value:function(){A("resuming on ongetfeatureinfoready"),this.callBack.triggerEvent("beforegetfeatureinfo"),this.getFeatureInfo(this.mouseDownX,this.mouseDownY)}},{key:"getFeatureInfo",value:function(e,t){var i=this;if(this.numGetFeatureInfoRequests>0)return A("suspending on ongetfeatureinfoready"),void this.addListener("ongetfeatureinfoready",this.newGetFeatureInfo,!1);A("GetFeatureInfo:"),this.getFeatureInfoResult=[],this.numGetFeatureInfoRequests=0;for(var s=0;s<this.layers.length;s++){var n=this.layers[this.layers.length-s-1];n.getFeatureInfoUrl="",n.service&&n.enabled&&!0===n.queryable&&(n.getFeatureInfoUrl=this.getWMSGetFeatureInfoRequestURL(n,e,t),Object(o.n)(n.getFeatureInfoUrl)?this.numGetFeatureInfoRequests++:n.getFeatureInfoUrl="")}0===this.numGetFeatureInfoRequests&&this.callBack.triggerEvent("ongetfeatureinfoready",["No layers to query"]);for(var a=0;a<this.layers.length;a++){var r=this.layers[this.layers.length-a-1];if(""!==r.getFeatureInfoUrl)if(!1===r.queryable)this.featureInfoRequestReady("Layer is not queryable.",r);else try{console.log("makehttp"),Object(o.a)(r.getFeatureInfoUrl,this.featureInfoRequestReady,function(e,t){i.featureInfoRequestReady(e,t),W(e)},r,!1,this.requestProxy)}catch(e){console.log(e),this.featureInfoRequestReady("Exception: "+e,r)}}}},{key:"getGetFeatureInfoObjectAsHTML",value:function(e){var t="";try{t+='<div class="getfeatureinfo">';for(var i=0;i<this.layers.length;i++)for(var s=0;s<e.length;s++)e[s].layer===this.layers[i]&&(t+='<div class="getfeatureinfolayer">',t+="<b><a target='_blank' href='"+e[s].layer.getFeatureInfoUrl+"'>"+e[s].layer.title+"</a></b><br/>",t+=e[s].data,t+="</div>");t+="</div>"}catch(e){t="No layers to query."}return t}},{key:"getMapPinXY",value:function(){return[this.divMapPin.exactX,this.divMapPin.exactY]}},{key:"positionMapPinByLatLon",value:function(e){A("positionMapPinByLatLon at "+e.x+","+e.y);var t=this.getPixelCoordFromLatLong(e);this.setMapPin(t.x,t.y),this.showMapPin()}},{key:"repositionMapPin",value:function(e){var t=this.bbox;Object(o.n)(e)&&(t=e);var i=this.getPixelCoordFromGeoCoord({x:this.divMapPin.geoPosX,y:this.divMapPin.geoPosY},t);this.setMapPin(i.x,i.y,t)}},{key:"setMapPin",value:function(e,t,i){var s=e,n=t;if("object"===X(e)&&(s=e.x,n=e.y),s&&n){this.divMapPin.x=parseInt(s),this.divMapPin.y=parseInt(n),this.divMapPin.exactX=parseFloat(s),this.divMapPin.exactY=parseFloat(n);var a=this.getGeoCoordFromPixelCoord({x:this.divMapPin.exactX,y:this.divMapPin.exactY},i);this.divMapPin.geoPosX=a.x,this.divMapPin.geoPosY=a.y}}},{key:"isMapPinVisible",value:function(){return this.divMapPin.displayMapPin}},{key:"showMapPin",value:function(){this.divMapPin.displayMapPin=!0,this.draw()}},{key:"hideMapPin",value:function(){this.divMapPin.displayMapPin=!1,this.draw()}},{key:"setMapModeGetInfo",value:function(){this.mapMode="info",this.baseDiv.css("cursor","default")}},{key:"setMapModeZoomBoxIn",value:function(e){this.mapMode="zoom",this.baseDiv.css("cursor","default")}},{key:"setMapModeZoomOut",value:function(e){this.mapMode="zoomout",this.baseDiv.css("cursor","default")}},{key:"setMapModePan",value:function(e){this.mapMode="pan",this.baseDiv.css("cursor","default")}},{key:"setMapModePoint",value:function(e,t){this.mapMode="point",this.baseDiv.css("cursor","url(webmapjs/img/aero_pen.cur), default")}},{key:"setMapModeNone",value:function(e){this.mapMode="none",this.baseDiv.css("cursor","default")}},{key:"getMouseCoordinatesForDocument",value:function(e){if(Object(o.n)(e.changedTouches))return{x:parseInt(e.changedTouches[0].screenX),y:parseInt(e.changedTouches[0].screenY)};var t=s(this.mainElement).parent().offset(),i=e.pageX,n=e.pageY;return void 0===i&&(i=Object(o.k)(e)),void 0===n&&(n=Object(o.l)(e)),{x:i-t.left,y:n-t.top}}},{key:"getMouseCoordinatesForElement",value:function(e){if(Object(o.n)(e.changedTouches))return{x:parseInt(e.changedTouches[0].screenX),y:parseInt(e.changedTouches[0].screenY)};var t=s(this.mainElement).parent().offset(),i=e.pageX,n=e.pageY;return void 0===i&&(i=Object(o.k)(e)),void 0===n&&(n=Object(o.l)(e)),{x:i-t.left,y:n-t.top}}},{key:"mouseDown",value:function(e,t,i){var s=!1;i&&!0===i.shiftKey&&(s=!0);var n;if(this.mouseDownX=e,this.mouseDownY=t,this.mouseDownPressed=1,0===this.mouseDragging&&0===this._checkInvalidMouseAction(this.mouseDownX,this.mouseDownY))for(var a=(this.callBack.triggerEvent("beforemousedown",{mouseX:e,mouseY:t,mouseDown:!0,event:i,leftButton:(n=i,"buttons"in(n=n||window.event)?1===n.buttons:1===(n.which||n.button)),shiftKey:s})),o=0;o<a.length;o++)if(!1===a[o])return;this.controlsBusy=!0,s?(void 0===this.oldMapMode&&(this.oldMapMode=this.mapMode),this.mapMode="zoom"):void 0!==this.oldMapMode&&(this.mapMode=this.oldMapMode,this.oldMapMode=void 0),this.callBack.triggerEvent("mousedown",{map:this,x:this.mouseDownX,y:this.mouseDownY}),"info"===this.mapMode?(A("GetFeatureInfo"),this.setMapPin(this.mouseDownX,this.mouseDownY),this.showMapPin(),this.callBack.triggerEvent("beforegetfeatureinfo",{map:this,x:this.mouseDownX,y:this.mouseDownY}),this.getFeatureInfo(this.mouseDownX,this.mouseDownY)):"point"===this.mapMode&&(this.setMapPin(this.mouseDownX,this.mouseDownY),this.showMapPin(),this.getPointInfo(this.mouseDownX,this.mouseDownY))}},{key:"_checkInvalidMouseAction",value:function(e,t){return t<0|e<0|e>this.width|t>this.height?(this.InValidMouseAction=1,-1):0}},{key:"updateMouseCursorCoordinates",value:function(e){this.mouseUpdateCoordinates=e,this.mouseGeoCoordXY=this.getGeoCoordFromPixelCoord(e),this.display("updateMouseCursorCoordinates")}},{key:"mouseDownEvent",value:function(e){Object(o.p)(e);var t=this.getMouseCoordinatesForDocument(e);this.mapHeader.cursorSet&&t.y<this.mapHeader.height||this.mouseDown(t.x,t.y,e)}},{key:"mouseMoveEvent",value:function(e){Object(o.p)(e);var t=this.getMouseCoordinatesForDocument(e);0===this.mouseDownPressed&&t.y>=0&&t.y<this.mapHeader.height&&t.x>=0&&t.x<=this.width?!1===this.mapHeader.cursorSet&&(this.mapHeader.cursorSet=!0,this.mapHeader.prevCursor=this.currentCursor,this.mapHeader.hovering=!0,this.setCursor("pointer"),this.draw("mouseMoveEvent")):!0===this.mapHeader.cursorSet&&(this.mapHeader.cursorSet=!1,this.mapHeader.hovering=!1,this.setCursor(this.mapHeader.prevCursor),this.draw("mouseMoveEvent")),this.mouseMove(t.x,t.y,e)}},{key:"mouseUpEvent",value:function(e){Object(o.p)(e);var t=this.getMouseCoordinatesForDocument(e);this.mouseUp(t.x,t.y,e)}},{key:"mouseMove",value:function(e,t){if(this.mouseX=e,this.mouseY=t,0===this.mouseDragging)for(var i=this.callBack.triggerEvent("beforemousemove",{mouseX:this.mouseX,mouseY:this.mouseY,mouseDown:1===this.mouseDownPressed}),s=0;s<i.length;s++)if(!1===i[s])return;if(!0===this.divBoundingBox.displayed&&0===this.mapPanning){var n=this.getPixelCoordFromGeoCoord({x:this.divBoundingBox.bbox.left,y:this.divBoundingBox.bbox.top}),a=this.getPixelCoordFromGeoCoord({x:this.divBoundingBox.bbox.right,y:this.divBoundingBox.bbox.bottom}),o=!1;if(0===this.mouseDownPressed&&(!1===this.resizingBBOXEnabled&&(this.resizingBBOXCursor=this.baseDiv.css("cursor")),Math.abs(this.mouseX-n.x)<6&&this.mouseY>n.y&&this.mouseY<a.y&&(o=!0,this.baseDiv.css("cursor","col-resize"),this.resizingBBOXEnabled="left"),Math.abs(this.mouseY-n.y)<6&&this.mouseX>n.x&&this.mouseX<a.x&&(o=!0,this.baseDiv.css("cursor","row-resize"),this.resizingBBOXEnabled="top"),Math.abs(this.mouseX-a.x)<6&&this.mouseY>n.y&&this.mouseY<a.y&&(o=!0,this.baseDiv.css("cursor","col-resize"),this.resizingBBOXEnabled="right"),Math.abs(this.mouseY-a.y)<6&&this.mouseX>n.x&&this.mouseX<a.x&&(o=!0,this.baseDiv.css("cursor","row-resize"),this.resizingBBOXEnabled="bottom"),Math.abs(this.mouseX-n.x)<6&&Math.abs(this.mouseY-n.y)<6&&(o=!0,this.baseDiv.css("cursor","nw-resize"),this.resizingBBOXEnabled="topleft"),Math.abs(this.mouseX-a.x)<6&&Math.abs(this.mouseY-n.y)<6&&(o=!0,this.baseDiv.css("cursor","ne-resize"),this.resizingBBOXEnabled="topright"),Math.abs(this.mouseX-n.x)<6&&Math.abs(this.mouseY-a.y)<6&&(o=!0,this.baseDiv.css("cursor","sw-resize"),this.resizingBBOXEnabled="bottomleft"),Math.abs(this.mouseX-a.x)<6&&Math.abs(this.mouseY-a.y)<6&&(o=!0,this.baseDiv.css("cursor","se-resize"),this.resizingBBOXEnabled="bottomright")),!0===o||!1!==this.resizingBBOXEnabled&&1===this.mouseDownPressed){if(1===this.mouseDownPressed){"left"===this.resizingBBOXEnabled&&(n.x=this.mouseX),"top"===this.resizingBBOXEnabled&&(n.y=this.mouseY),"right"===this.resizingBBOXEnabled&&(a.x=this.mouseX),"bottom"===this.resizingBBOXEnabled&&(a.y=this.mouseY),"topleft"===this.resizingBBOXEnabled&&(n.x=this.mouseX,n.y=this.mouseY),"topright"===this.resizingBBOXEnabled&&(a.x=this.mouseX,n.y=this.mouseY),"bottomleft"===this.resizingBBOXEnabled&&(n.x=this.mouseX,a.y=this.mouseY),"bottomright"===this.resizingBBOXEnabled&&(a.x=this.mouseX,a.y=this.mouseY),n=this.getGeoCoordFromPixelCoord(n),a=this.getGeoCoordFromPixelCoord(a),this.divBoundingBox.bbox.left=n.x,this.divBoundingBox.bbox.top=n.y,this.divBoundingBox.bbox.right=a.x,this.divBoundingBox.bbox.bottom=a.y,this.showBoundingBox(this.divBoundingBox.bbox);var r={map:this,bbox:this.divBoundingBox.bbox};this.callBack.triggerEvent("bboxchanged",r)}return}this.resizingBBOXEnabled=!1,this.baseDiv.css("cursor",this.resizingBBOXCursor)}if(-1===this._checkInvalidMouseAction(this.mouseX,this.mouseY)){try{this.callBack.triggerEvent("onmousemove",[void 0,void 0]),this.updateMouseCursorCoordinates(void 0)}catch(e){console.error(e)}if(this.mouseUpX=this.mouseX,this.mouseUpY=this.mouseY,0===this.mapPanning)return;return 1===this.mouseDownPressed&&"zoomout"===this.mapMode&&this.zoomOut(),this.mouseDownPressed=0,void(1===this.mouseDragging&&this.mouseDragEnd(this.mouseUpX,this.mouseUpY))}1===this.mouseDownPressed&&(Math.abs(this.mouseDownX-this.mouseX)<3&&Math.abs(this.mouseDownY-this.mouseY)<3||this.mouseDrag(this.mouseX,this.mouseY)),this.callBack.triggerEvent("onmousemove",[this.mouseX,this.mouseY]),this.updateMouseCursorCoordinates({x:this.mouseX,y:this.mouseY})}},{key:"mouseUp",value:function(e,t,i){var s=this;if(this.controlsBusy=!1,this.mouseUpX=e,this.mouseUpY=t,0===this.mouseDragging&&0===this._checkInvalidMouseAction(this.mouseUpX,this.mouseUpY))for(var n=this.callBack.triggerEvent("beforemouseup",{mouseX:e,mouseY:t,mouseDown:!1,event:i}),a=0;a<n.length;a++)if(!1===n[a])return void(this.mouseDownPressed=0);if(1===this.mouseDownPressed){if("zoomout"===this.mapMode&&this.zoomOut(),0===this.mouseDragging&&Math.abs(this.mouseDownX-this.mouseUpX)<3&&Math.abs(this.mouseDownY-this.mouseUpY)<3)if(Object(o.n)(i)&&this.callBack.triggerEvent("mouseclicked",{map:this,x:this.mouseUpX,y:this.mouseUpY,shiftKeyPressed:!0===i.shiftKey}),!0===this.inlineGetFeatureInfo){var r;0===this.gfiDialogList.length?(r=(new R).createDialog({show:this.showDialog,x:this.mouseUpX,y:this.mouseUpY,autoDestroy:!1},this.baseDiv,this,this.loadingImageSrc),this.gfiDialogList.push(r)):r=this.gfiDialogList[0],!1===r.hasBeenDragged&&(!0===r.moveToMouseCursor?r.setXY(this.mouseUpX,this.mouseUpY):r.setXY(5,45)),r.on("hide",function(e,t){r.hasBeenDragged=!1}),r.setLoading(),r.show();this.addListener("ongetfeatureinfoready",function(e){r.setHTML(s.getGetFeatureInfoObjectAsHTML(e))},!0),this.setMapPin(this.mouseDownX,this.mouseDownY),this.showMapPin(),this.callBack.triggerEvent("beforegetfeatureinfo"),this.getFeatureInfo(this.mouseDownX,this.mouseDownY)}else this.setMapPin(this.mouseDownX,this.mouseDownY),this.showMapPin();this.callBack.triggerEvent("mouseup",{map:this,x:this.mouseUpX,y:this.mouseUpY})}this.mouseDownPressed=0,1===this.mouseDragging&&this.mouseDragEnd(this.mouseUpX,this.mouseUpY)}},{key:"_mouseDragStart",value:function(e,t){"pan"===this.mapMode&&this._mapPanStart(e,t),"zoom"===this.mapMode&&this._mapZoomStart(e,t)}},{key:"mouseDrag",value:function(e,t){0===this.mouseDragging&&(this._mouseDragStart(e,t),this.mouseDragging=1),"pan"===this.mapMode&&this._mapPan(e,t),"zoom"===this.mapMode&&this._mapZoom(e,t)}},{key:"mouseDragEnd",value:function(e,t){0!==this.mouseDragging&&(this.mouseDragging=0,"pan"===this.mapMode&&this._mapPanEnd(e,t),"zoom"===this.mapMode&&this._mapZoomEnd(e,t),this.callBack.triggerEvent("mapdragend",{map:this,x:this.mouseUpX,y:this.mouseUpY}))}},{key:"_mapPanStart",value:function(e,t){this.flyZoomToBBOXStop(),this.baseDiv.css("cursor","move");var i=parseInt(e),s=parseInt(t);this.divMapPin.oldx=this.divMapPin.exactX,this.divMapPin.oldy=this.divMapPin.exactY;for(var n=0;n<this.gfiDialogList.length;n++)this.gfiDialogList[n].origX=this.gfiDialogList[n].x,this.gfiDialogList[n].origY=this.gfiDialogList[n].y;this.mapPanning=1,this.updateBBOX.setBBOX(this.drawnBBOX),this.mapPanStartGeoCoords=this.getGeoCoordFromPixelCoord({x:i,y:s},this.bbox)}},{key:"_mapPan",value:function(e,t){if(0!==this.mapPanning){var i=parseInt(e),s=parseInt(t);if(this.mouseX<0||this.mouseY<0||this.mouseX>parseInt(this.mainElement.clientWidth)||this.mouseY>parseInt(this.mainElement.clientHeight))this.mapPanEnd(i,s);else{var n=this.getGeoCoordFromPixelCoord({x:i,y:s},this.updateBBOX),a=n.x-this.mapPanStartGeoCoords.x,o=n.y-this.mapPanStartGeoCoords.y;this.updateBBOX.left=this.updateBBOX.left-a,this.updateBBOX.bottom=this.updateBBOX.bottom-o,this.updateBBOX.right=this.updateBBOX.right-a,this.updateBBOX.top=this.updateBBOX.top-o,this._updateBoundingBox(this.updateBBOX)}}}},{key:"_mapPanEnd",value:function(e,t){this.baseDiv.css("cursor","default");var i=parseInt(e),s=parseInt(t);if(0!==this.mapPanning){this.mapPanning=0;var n=this.getGeoCoordFromPixelCoord({x:i,y:s},this.drawnBBOX),a=n.x-this.mapPanStartGeoCoords.x,o=n.y-this.mapPanStartGeoCoords.y;this.updateBBOX.left=this.drawnBBOX.left-a,this.updateBBOX.bottom=this.drawnBBOX.bottom-o,this.updateBBOX.right=this.drawnBBOX.right-a,this.updateBBOX.top=this.drawnBBOX.top-o,this._updateBoundingBox(this.updateBBOX),this.zoomTo(this.updateBBOX),this.draw("mapPanEnd")}}},{key:"_mapZoomStart",value:function(e,t){this.baseDiv.css("cursor","crosshair"),this.mapZooming=1}},{key:"_mapZoom",value:function(e,t){if(0!==this.mapZooming){e=this.mouseX-this.mouseDownX,t=this.mouseY-this.mouseDownY,e<0&&t<0?this.baseDiv.css("cursor","not-allowed"):this.baseDiv.css("cursor","crosshair");var i=e,s=t;this.divZoomBox.style.display="",i<0?(i=-i,this.divZoomBox.style.left=this.mouseX+"px"):this.divZoomBox.style.left=this.mouseDownX+"px",s<0?(s=-s,this.divZoomBox.style.top=this.mouseY+"px"):this.divZoomBox.style.top=this.mouseDownY+"px",this.divZoomBox.style.width=i+"px",this.divZoomBox.style.height=s+"px"}}},{key:"_mapZoomEnd",value:function(e,t){if(e=this.mouseUpX-this.mouseDownX,t=this.mouseUpY-this.mouseDownY,this.baseDiv.css("cursor","default"),0!==this.mapZooming&&(this.mapZooming=0,this.divZoomBox.style.display="none",!(e<0&&t<0))){var i=new v;e<0?(i.left=this.mouseDownX+e,i.right=this.mouseDownX):(i.left=this.mouseDownX,i.right=this.mouseDownX+e),t<0?(i.top=this.mouseDownY+t,i.bottom=this.mouseDownY):(i.top=this.mouseDownY,i.bottom=this.mouseDownY+t);var s=this.pixelCoordinatesToXY({x:i.left,y:i.bottom}),n=this.pixelCoordinatesToXY({x:i.right,y:i.top});i.left=s.x,i.bottom=s.y,i.right=n.x,i.top=n.y,this.zoomTo(i),this.draw("mapZoomEnd")}}},{key:"setCursor",value:function(e){this.currentCursor=e||"default",this.baseDiv.css("cursor",this.currentCursor)}},{key:"getId",value:function(){return this.makeComponentId("webmapjsinstance")}},{key:"zoomTo",value:function(e){var t=this;var i=!1,s=new v(e),n=1;try{n=(this.resizeBBOX.left-this.resizeBBOX.right)/(this.resizeBBOX.bottom-this.resizeBBOX.top)}catch(e){i=!0}if(isNaN(n)&&(i=!0),!0===i&&(W("Invalid bbox: setting ratio to 1"),n=1),n<0&&(n=-n),n>this.width/this.height){var a=(s.top+s.bottom)/2,o=(s.left-s.right)/2/n;s.bottom=a+o,s.top=a-o}else{var r=(s.right+s.left)/2,h=(s.bottom-s.top)/2*n;s.left=r+h,s.right=r-h}this.setBBOX(s),this._updateBoundingBox(this.bbox),this.drawnBBOX.setBBOX(this.bbox);!function(){for(var e=0;e<t.gfiDialogList.length;e++){var i=t.getPixelCoordFromGeoCoord({x:t.gfiDialogList[e].geoPosX,y:t.gfiDialogList[e].geoPosY});!1===t.gfiDialogList[e].hasBeenDragged&&!0===t.gfiDialogList[e].moveToMouseCursor&&t.gfiDialogList[e].setXY(t.gfiDialogList[e].origX+i.x,t.gfiDialogList[e].origY+i.y)}}()}},{key:"pixelCoordinatesToXY",value:function(e){return this.getGeoCoordFromPixelCoord(e)}},{key:"getGeoCoordFromPixelCoord",value:function(e,t){var i=this.bbox;if(t&&(i=t),Object(o.n)(e))try{return{x:e.x/this.width*(i.right-i.left)+i.left,y:e.y/this.height*(i.bottom-i.top)+i.top}}catch(e){return}}},{key:"getProj4",value:function(){return this.srs&&"GFI:TIME_ELEVATION"!==this.srs?(this.proj4.srs===this.srs&&Object(o.n)(this.proj4.projection)||(this.proj4.projection=this.srs,this.proj4.srs=this.srs),{lonlat:this.longlat,crs:this.proj4.projection,proj4:a}):null}},{key:"getPixelCoordFromLatLong",value:function(e){if(!this.srs||"GFI:TIME_ELEVATION"===this.srs)return e;var t;try{var i={};i.x=parseFloat(e.x),i.y=parseFloat(e.y),this.proj4.srs===this.srs&&Object(o.n)(this.proj4.projection)||(this.proj4.projection=this.srs,this.proj4.srs=this.srs),t=a(this.longlat,this.proj4.projection,[i.x,i.y])}catch(e){return void W("error in getPixelCoordFromLatLong "+e)}return this.getPixelCoordFromGeoCoord({x:t[0],y:t[1]})}},{key:"WCJSSearchRequest",value:function(e){var t=this;if(console.log(e),e.trim().match(/^(-?(?:[1-8]?\d(?:\.\d+)?|90(?:\.0+)?),-?(?:180(?:\.0+)?|(?:(?:1[0-7]\d)|(?:[1-9]?\d))(?:\.\d+)?))$/)){var i=e.split(","),n=i[0],a=i[1];return console.log("LATLON"),void this.calculateBoundingBoxAndZoom(n,a)}if("undefined"!=typeof geoNamesURL||"undefined"!=typeof knmiGeoNamesURL){if(!e.trim())return A(E.no_search_definition.text),void s("#searchtextfield").attr("value","");var o,r=e.trim().match(/^[a-zA-Z0-9 ]*$/);if(!r)return A(E.only_alpha_num_allowed.text),void s("#searchtextfield").attr("value","");if("undefined"!=typeof knmiGeoNamesURL){o=this.knmiGeoNamesURL.replace("{searchTerm}",r),A(E.debug_searching_location.text),A('<a target="_blank" href="'+o+'">'+o+"</a>",!1);s.ajax({dataType:"jsonp",contentType:"application/jsonp",jsonpCallback:"resultGeo",crossDomain:!0,type:"GET",url:o,success:function(e){if(0===s(e).length){var i=t.geoNamesURL.replace("{searchTerm}",r).replace("{username}",t.defaultUsernameSearch);return console.log("urlApiGeonames",i),void t.WCJSSearchRequestGeoNames(i)}console.log("ok");var n=parseFloat(s(e)[0].lat),a=parseFloat(s(e)[0].lon);t.calculateBoundingBoxAndZoom(n,a)},error:function(e,t,i){W(E.geonames_api_call_failed.text)}})}else{var h=this.geoNamesURL.replace("{searchTerm}",r).replace("{username}",this.defaultUsernameSearch);this.WCJSSearchRequestGeoNames(h)}}else W(E.no_urls_in_config.text)}},{key:"WCJSSearchRequestGeoNames",value:function(e){var t=this;A(E.debug_searching_sqlite_location.text),A('<a target="_blank" href="'+e+'">'+e+"</a>",!1);s.ajax({dataType:"xml",type:"GET",url:e,success:function(e){if(console.log("ok",e),"0"!==s(e).find("totalResultsCount").text()){var i=parseFloat(s(e).find("geoname").find("lat").text()),n=parseFloat(s(e).find("geoname").find("lng").text());t.calculateBoundingBoxAndZoom(i,n)}else W(E.no_results_search.text)},error:function(e,t,i){W(E.geonames_sqlite_call_failed.text)}})}},{key:"calculateBoundingBoxAndZoom",value:function(e,t){var i=5e5;"EPSG:4326"!==this.srs&&"EPSG:50001"!==this.srs||(i=5),console.log(e,t);var s=this.getPixelCoordFromLatLong({x:t,y:e});console.log(s);var n=this.getGeoCoordFromPixelCoord(s);console.log(n);var a=new v;a.left=n.x-i,a.bottom=n.y-i,a.right=n.x+i,a.top=n.y+i,this.zoomTo(a),this.positionMapPinByLatLon({x:t,y:e}),this.draw("zoomIn")}},{key:"getLatLongFromPixelCoord",value:function(e){if(!this.srs||"GFI:TIME_ELEVATION"===this.srs)return e;try{var t={};t.x=e.x/this.width*(this.bbox.right-this.bbox.left)+this.bbox.left,t.y=e.y/this.height*(this.bbox.bottom-this.bbox.top)+this.bbox.top,this.proj4.srs!==this.srs&&(this.proj4.projection=this.srs,this.proj4.srs=this.srs);var i=a(this.proj4.projection,this.longlat,[t.x,t.y]);return{x:i[0],y:i[1]}}catch(e){return}}},{key:"getPixelCoordFromGeoCoord",value:function(e,t,i,s){var n=this.width,a=this.height,r=this.updateBBOX;Object(o.n)(i)&&(n=i),Object(o.n)(s)&&(a=s),Object(o.n)(t)&&(r=t);var h=n*(e.x-r.left)/(r.right-r.left),l=a*(e.y-r.top)/(r.bottom-r.top);return{x:parseFloat(h),y:parseFloat(l)}}},{key:"addListener",value:function(e,t,i){return this.callBack.addToCallback(e,t,i)}},{key:"removeListener",value:function(e,t){return this.callBack.removeEvents(e,t)}},{key:"getListener",value:function(e){return this.callBack}},{key:"suspendEvent",value:function(e){this.callBack.suspendEvent(e)}},{key:"resumeEvent",value:function(e){this.callBack.resumeEvent(e)}},{key:"getDimensionList",value:function(){return this.mapdimensions}},{key:"getDimension",value:function(e){for(var t=0;t<this.mapdimensions.length;t++)if(this.mapdimensions[t].name===e)return this.mapdimensions[t]}},{key:"setDimension",value:function(e,t,i){if(A("WebMapJS::setDimension("+e+","+t+")"),Object(o.n)(e)&&Object(o.n)(t)){var s=this.getDimension(e);!1===Object(o.n)(s)&&(s={name:e,currentValue:t},this.mapdimensions.push(s)),Object(o.n)(this.mainTimeSlider)&&this.mainTimeSlider.setValue(e,t),s.currentValue!==t&&(s.currentValue=t,this._buildLayerDims(),!1!==i&&(i=!0),!0===i&&this.callBack.triggerEvent("ondimchange",e))}else W("Unable to set dimension with undefined value or name")}},{key:"setLayerOpacity",value:function(e,t){if(e){e.opacity=t;for(var i=this.numBaseLayers,s=0;s<this.getNumLayers();s++)if(this.layers[s].service&&this.layers[s].enabled){if(e===this.layers[s])return void this.setBufferImageOpacity(this.newSwapBuffer,i,t);i++}}}},{key:"zoomToLayer",value:function(e){var t=e;if(t||(t=this.activeLayer),!t)return this.zoomTo(this.defaultBBOX),void this.draw("zoomTolayer");for(var i=0;i<t.projectionProperties.length;i++)if(t.projectionProperties[i].srs===this.srs){var s=t.projectionProperties[i].bbox.right-t.projectionProperties[i].bbox.left,n=t.projectionProperties[i].bbox.top-t.projectionProperties[i].bbox.bottom,a=t.projectionProperties[i].bbox.clone();return a.left-=s/100,a.right+=s/100,a.bottom-=n/100,a.top+=n/100,this.zoomTo(a),void this.draw("zoomTolayer")}W("Unable to find the correct bbox with current map projection "+this.srs+" for layer "+t.title+". Using default bbox instead."),this.zoomTo(this.defaultBBOX),this.draw("zoomTolayer")}},{key:"setPreviousExtent",value:function(){this.DoUndo=1,this.UndoPointer++,this.UndoPointer>=this.NrOfUndos&&(this.UndoPointer=this.NrOfUndos-1),this.setProjection(this.WMJSProjection_undo[this.UndoPointer].srs,this.WMJSProjection_undo[this.UndoPointer].bbox),this.draw("setPreviousExtent")}},{key:"setNextExtent",value:function(){this.DoRedo=1,this.UndoPointer--,this.UndoPointer<0&&(this.UndoPointer=0),this.setProjection(this.WMJSProjection_undo[this.UndoPointer].srs,this.WMJSProjection_undo[this.UndoPointer].bbox),this.draw("setNextExtent")}},{key:"setBBOX",value:function(e,t,i,s){if(this.bbox.setBBOX(e,t,i,s),this.resizeBBOX.setBBOX(this.bbox),"GFI:TIME_ELEVATION"!==this.srs){var n=this.width/this.height;if((this.bbox.right-this.bbox.left)/(this.bbox.top-this.bbox.bottom)>n){var a=(this.bbox.top+this.bbox.bottom)/2,o=(this.bbox.left-this.bbox.right)/2/n;this.bbox.bottom=a+o,this.bbox.top=a-o}else{var r=(this.bbox.right+this.bbox.left)/2,h=(this.bbox.bottom-this.bbox.top)/2*n;this.bbox.left=r+h,this.bbox.right=r-h}}if(this.updateBBOX.setBBOX(this.bbox),this.drawnBBOX.setBBOX(this.bbox),0===this.DoRedo&&0===this.DoUndo){if(0!==this.UndoPointer){for(var l=0;l<=this.UndoPointer;l++)this.WMJSProjection_tempundo[l]=this.WMJSProjection_undo[l];for(var u=0;u<=this.UndoPointer;u++)this.WMJSProjection_undo[u]=this.WMJSProjection_tempundo[this.UndoPointer-u];this.UndoPointer=0}for(var d=this.MaxUndos-1;d>0;d--)this.WMJSProjection_undo[d].bbox.setBBOX(this.WMJSProjection_undo[d-1].bbox),this.WMJSProjection_undo[d].srs=this.WMJSProjection_undo[d-1].srs;this.WMJSProjection_undo[0].bbox.setBBOX(this.bbox),this.WMJSProjection_undo[0].srs=this.srs,this.NrOfUndos++,this.NrOfUndos>this.MaxUndos&&(this.NrOfUndos=this.MaxUndos)}return this.DoRedo=0,this.DoUndo=0,!0!==this.bbox.equals(e,t,i,s)&&(this.callBack.triggerEvent("aftersetbbox",this),!0)}},{key:"zoomOut",value:function(){var e=(this.resizeBBOX.right-this.resizeBBOX.left)/6;this.zoomTo(new v(this.resizeBBOX.left-e,this.resizeBBOX.bottom-e,this.resizeBBOX.right+e,this.resizeBBOX.top+e)),this.draw("zoomOut")}},{key:"zoomIn",value:function(e){var t=(this.resizeBBOX.left-this.resizeBBOX.right)/8;if(!1===Object(o.n)(e))e=1;else if(0===e)return;t*=e,this.zoomTo(new v(this.resizeBBOX.left-t,this.resizeBBOX.bottom-t,this.resizeBBOX.right+t,this.resizeBBOX.top+t)),this.draw("zoomIn")}},{key:"searchForLocation",value:function(e){this.WCJSSearchRequest(e)}},{key:"displayLegendInMap",value:function(e){this._displayLegendInMap=e,this.repositionLegendGraphic()}},{key:"showBoundingBox",value:function(e,t){if(Object(o.n)(e)&&(this.divBoundingBox.bbox=e,this.divBoundingBox.style.display="",this.divBoundingBox.displayed=!0),!0===this.divBoundingBox.displayed){var i=this.bbox;Object(o.n)(t)&&(i=t);var s=this.getPixelCoordFromGeoCoord({x:this.divBoundingBox.bbox.left,y:this.divBoundingBox.bbox.top},i),n=this.getPixelCoordFromGeoCoord({x:this.divBoundingBox.bbox.right,y:this.divBoundingBox.bbox.bottom},i);this.divBoundingBox.style.left=s.x-1+"px",this.divBoundingBox.style.top=s.y-2+"px",this.divBoundingBox.style.width=n.x-s.x+"px",this.divBoundingBox.style.height=n.y-s.y-1+"px"}}},{key:"hideBoundingBox",value:function(){this.divBoundingBox.style.display="none",this.divBoundingBox.displayed=!1}},{key:"clearImageStore",value:function(){this.getLegendStore().clear(),this.getImageStore().clear()}}])&&U(t.prototype,i),r&&U(t,r),e}();function Z(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function H(e,t){for(var i=0;i<t.length;i++){var s=t[i];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}function J(e,t,i){return t&&H(e.prototype,t),i&&H(e,i),e}var K=function(){function e(t,i,s,n,a,o){Z(this,e),this.year=parseInt(t),this.month=parseInt(i),this.day=parseInt(s),this.hour=parseInt(n),this.minute=parseInt(a),this.second=parseInt(o),this.isRegularInterval=!1,0===this.month&&0===this.year&&(this.isRegularInterval=!0),this.getTime=this.getTime.bind(this),this.toISO8601=this.toISO8601.bind(this)}return J(e,[{key:"getTime",value:function(){var e=0;if(0!==this.month)throw new Error("month !== 0");if(0!==this.year)throw new Error("year !== 0");return e+=60*this.day*60*24,e+=60*this.hour*60,e+=60*this.minute,e+=this.second,e*=1e3}},{key:"toISO8601",value:function(){var e="P";return 0!==this.year&&(e+=this.year+"Y"),0!==this.month&&(e+=this.month+"M"),0!==this.day&&(e+=this.day+"D"),0!==this.hour&&0!==this.minute&&0!==this.second&&(e+="T"),0!==this.hour&&(e+=this.hour+"H"),0!==this.minute&&(e+=this.minute+"M"),0!==this.second&&(e+=this.second+"S"),e}}]),e}(),Q=function e(t){if(t){var i=t.split("T");i[0]=i[0].replace(/-/g,":"),i[0]=i[0].replace(/::/g,":-");var s=i[0].split(":"),n=i[1].split(":"),a=new Date(Date.UTC(s[0],s[1]-1,s[2],n[0],n[1],n[2].split("Z")[0]));return a.add=function(e){!1===e.isRegularInterval?(0!==e.year&&this.setUTCFullYear(this.getUTCFullYear()+e.year),0!==e.month&&this.setUTCMonth(this.getUTCMonth()+e.month),0!==e.day&&this.setUTCDate(this.getUTCDate()+e.day),0!==e.hour&&this.setUTCHours(this.getUTCHours()+e.hour),0!==e.minute&&this.setUTCMinutes(this.getUTCMinutes()+e.minute),0!==e.second&&this.setUTCSeconds(this.getUTCSeconds()+e.second)):this.setTime(this.getTime()+e.getTime())},a.substract=function(e){!1===e.isRegularInterval?(0!==e.year&&this.setUTCFullYear(this.getUTCFullYear()-e.year),0!==e.month&&this.setUTCMonth(this.getUTCMonth()-e.month),0!==e.day&&this.setUTCDate(this.getUTCDate()-e.day),0!==e.hour&&this.setUTCHours(this.getUTCHours()-e.hour),0!==e.minute&&this.setUTCMinutes(this.getUTCMinutes()-e.minute),0!==e.second&&this.setUTCSeconds(this.getUTCSeconds()-e.second)):this.setTime(this.getTime()-e.getTime())},a.addMultipleTimes=function(e,t){!1===e.isRegularInterval?(0!==e.year&&this.setUTCFullYear(this.getUTCFullYear()+e.year*t),0!==e.month&&this.setUTCMonth(this.getUTCMonth()+e.month*t),0!==e.day&&this.setUTCDate(this.getUTCDate()+e.day*t),0!==e.hour&&this.setUTCHours(this.getUTCHours()+e.hour*t),0!==e.minute&&this.setUTCMinutes(this.getUTCMinutes()+e.minute*t),0!==e.second&&this.setUTCSeconds(this.getUTCSeconds()+e.second*t)):this.setTime(this.getTime()+e.getTime()*t)},a.substractMultipleTimes=function(e,t){!1===e.isRegularInterval?(0!==e.year&&this.setUTCFullYear(this.getUTCFullYear()-e.year*t),0!==e.month&&this.setUTCMonth(this.getUTCMonth()-e.month*t),0!==e.day&&this.setUTCDate(this.getUTCDate()-e.day*t),0!==e.hour&&this.setUTCHours(this.getUTCHours()-e.hour*t),0!==e.minute&&this.setUTCMinutes(this.getUTCMinutes()-e.minute*t),0!==e.second&&this.setUTCSeconds(this.getUTCSeconds()-e.second*t)):this.setTime(this.getTime()-e.getTime()*t)},a.toISO8601=function(){function e(e,t){var i,s=e+"",n=t-s.length,a="";for(i=0;i<n;i++)a+="0"+a;return s=a+s}return e(this.getUTCFullYear(),4)+"-"+e(this.getUTCMonth()+1,2)+"-"+e(this.getUTCDate(),2)+"T"+e(this.getUTCHours(),2)+":"+e(this.getUTCMinutes(),2)+":"+e(this.getUTCSeconds(),2)+"Z"},a.clone=function(){return e(a.toISO8601())},a}console.log("Warning: no date given to parseISO8601DateToDate")},$=function(e){if("P"===e.charAt(0)){var t=e.split("T"),i=0,s=0,n=0,a=0,r=0,h=0,l=t[0].split("P")[1];if(l){var u=l.indexOf("Y"),d=l.indexOf("M"),c=l.indexOf("D");if(-1!==u&&(i=l.substring(0,u)),-1!==d&&(s=l.substring(u+1,d)),-1!==c){var m=u;-1!==d&&(m=d),n=l.substring(m+1,c)}}if(t.length>0&&Object(o.n)(t[1])){var f=t[1];if(f){var p=f.indexOf("H"),g=f.indexOf("M"),v=f.indexOf("S");if(-1!==p&&(a=f.substring(0,p)),-1!==g&&(r=f.substring(p+1,g)),-1!==v){var y=p;-1!==g&&(y=g),h=f.substring(y+1,v)}}}return new K(i,s,n,a,r,h)}};var ee=function(){function e(t){Z(this,e);var i=t.split("/");void 0===i[2]&&(i[2]="PT1M"),void 0===i[1]&&(i[1]=i[0],i[2]="PT1M"),this.startTime=Q(i[0]),this.stopTime=Q(i[1]),this.timeInterval=$(i[2]),this.timeSteps=function(e,t,i){var s=0;if(0!==i.month||0!==i.year){for(var n=e.clone(),a=t.getTime();n.getTime()<a;)n.add(i),s++;return++s}return s=parseInt((t.getTime()-e.getTime())/i.getTime()+.5)+1}(this.startTime,this.stopTime,this.timeInterval),this.getTimeSteps=this.getTimeSteps.bind(this),this.getDateAtTimeStep=this.getDateAtTimeStep.bind(this),this.getTimeStepFromISODate=this.getTimeStepFromISODate.bind(this),this.getTimeStepFromDate=this.getTimeStepFromDate.bind(this),this.getTimeStepFromDateWithinRange=this.getTimeStepFromDateWithinRange.bind(this),this.getTimeStepFromDateClipped=this.getTimeStepFromDateClipped.bind(this)}return J(e,[{key:"getTimeSteps",value:function(){return this.timeSteps}},{key:"getDateAtTimeStep",value:function(e){if(!1===this.timeInterval.isRegularInterval){var t=this.startTime.clone();return t.addMultipleTimes(this.timeInterval,e),t}var i=this.startTime.clone(),s=this.timeInterval.getTime();return s*=e,i.setTime(i.getTime()+s),i}},{key:"getTimeStepFromISODate",value:function(e,t){var i=null;try{i=Q(e)}catch(t){throw new Error("The date "+e+" is not a valid date")}return this.getTimeStepFromDate(i,t)}},{key:"getTimeStepFromDate",value:function(e,t){t||(t=!1);var i=e.getTime();if(i<this.startTime.getTime()){if(!0===t)throw new Error(0);return 0}var s=this.stopTime.clone();if(s.add(this.timeInterval),i>=s.getTime()){if(!0===t)throw new Error(this.timeSteps-1);return this.timeSteps-1}if(i>this.stopTime.getTime())return this.timeSteps-1;var n=0;if(!1===this.timeInterval.isRegularInterval){for(var a=this.startTime.clone(),o=0;o<this.timeSteps;o++){var r=a.getTime();a.add(this.timeInterval);var h=a.getTime();if(i>=r&&i<h)return o}throw new Error("Date "+e.toISO8601()+" not found!")}return n=(e.getTime()-this.startTime.getTime())/this.timeInterval.getTime(),n=parseInt(n)}},{key:"getTimeStepFromDateWithinRange",value:function(e){return this.getTimeStepFromDate(e,!0)}},{key:"getTimeStepFromDateClipped",value:function(e){return this.getTimeStepFromDate(e,!1)}}]),e}();function te(e,t){for(var i=0;i<t.length;i++){var s=t[i];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}var ie=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.name=void 0,this.units=void 0,this.values=void 0,this.currentValue=void 0,this.defaultValue=void 0,this.parentLayer=void 0,this.timeRangeDuration=void 0,this.linked=!0,this._initialized=!1,this._timeRangeDurationDate=null,this._allDates=[],this._type=null,this._allValues=[],this.__setStartTime=this.__setStartTime.bind(this),this.generateAllValues=this.generateAllValues.bind(this),this.reInitializeValues=this.reInitializeValues.bind(this),this.initialize=this.initialize.bind(this),this.getValue=this.getValue.bind(this),this.setValue=this.setValue.bind(this),this.setClosestValue=this.setClosestValue.bind(this),this.getNextClosestValue=this.getNextClosestValue.bind(this),this.addTimeRangeDurationToValue=this.addTimeRangeDurationToValue.bind(this),this.setTimeRangeDuration=this.setTimeRangeDuration.bind(this),this.getClosestValue=this.getClosestValue.bind(this),this.getValueForIndex=this.getValueForIndex.bind(this),this.get=this.get.bind(this),this.getIndexForValue=this.getIndexForValue.bind(this),this.size=this.size.bind(this),this.clone=this.clone.bind(this),Object(o.n)(t)&&(Object(o.n)(t.name)&&(this.name=t.name),Object(o.n)(t.units)&&(this.units=t.units),Object(o.n)(t.values)&&(this.values=t.values),Object(o.n)(t.currentValue)&&(this.currentValue=t.currentValue),Object(o.n)(t.defaultValue)&&(this.defaultValue=t.defaultValue),Object(o.n)(t.parentLayer)&&(this.parentLayer=t.parentLayer),Object(o.n)(t.linked)&&(this.linked=t.linked))}var t,i,s;return t=e,(i=[{key:"generateAllValues",value:function(){var e=[];if(this.size()>5e3)throw new Error("Error: Dimension too large to query all possible values at once");for(var t=0;t<this.size();t++)e.push(this.getValueForIndex(t));return e}},{key:"__setStartTime",value:function(e){this._initialized||this.initialize();var t=e;if(!t||0===t.length)return this.reInitializeValues(this.values),this.setClosestValue(!0),void console.log("returning");if(t=Q(t).toISO8601(),"timestartstopres"===this._type){var i=this.values,s=t+i.substring(i.indexOf("/"));this.reInitializeValues(s),this.setClosestValue()}else if("timevalues"===this._type){for(var n=Q(t),a=arr.filter(function(e){return allDates[j]>=n}),o="",r=0;r<a.length;r++)r>0&&(o+="/"),o+=a[r].toISO8601();return this.reInitializeValues(o),void this.setClosestValue()}}},{key:"reInitializeValues",value:function(e){this._initialized=!1,this.initialize(e)}},{key:"initialize",value:function(e){if(!0!==this._initialized){var t=this.values;if(e&&(t=e),Object(o.n)(t)){if(this._allValues=[],this._initialized=!0,"ISO8601"===this.units?t.indexOf("/")>0?(this._type="timestartstopres",this._timeRangeDurationDate=new ee(t)):this._type="timevalues":(this._type="anyvalue",this.linked=!1),"timestartstopres"!==this._type){for(var i=t.split(","),s=0;s<i.length;s++){var n=i[s].split("/");if(3===n.length){var a=parseFloat(n[0]),r=parseFloat(n[1]),h=parseFloat(n[2]);a>(r+=h)&&(r=a),h<=0&&(h=1);for(var l=a;l<r;l+=h)this._allValues.push(l)}else this._allValues.push(i[s])}if("timevalues"===this._type)for(var u=0;u<this._allValues.length;u++)this._allDates[u]=Q(this._allValues[u])}Object(o.n)(this.defaultValue)||(this.defaultValue=this.getValueForIndex(0)),Object(o.n)(this.currentValue)||(this.currentValue=this.getValueForIndex(0)),this.dimMinValue=this.getValueForIndex(0),this.dimMaxValue=this.getValueForIndex(this.size()-1)}}}},{key:"getValue",value:function(){this._initialized||this.initialize();var e=this.defaultValue;return Object(o.n)(this.currentValue)&&(e=this.currentValue),e=this.addTimeRangeDurationToValue(e)}},{key:"setValue",value:function(e){this._initialized||this.initialize(),"outside range"!==e&&"date too early"!==e&&"date too late"!==e&&(this.currentValue=e)}},{key:"setClosestValue",value:function(e,t){e||(e=this.getValue(),t=!0),this.currentValue=this.getClosestValue(e,t)}},{key:"getNextClosestValue",value:function(e){var t=this.getClosestValue(e),i=this.getIndexForValue(t),s=this.getValueForIndex(i+1);return!s||"date too early"===s||moment(e)>=moment(s)?null:s}},{key:"addTimeRangeDurationToValue",value:function(e){if("outside range"===e||"date too early"===e||"date too late"===e)return e;if(this.timeRangeDuration&&this.timeRangeDuration.length>0){var t=$(this.timeRangeDuration),i=Q(e);return i.add(t),e+"/"+i.toISO8601()}return e}},{key:"setTimeRangeDuration",value:function(e){if(this.timeRangeDuration=e,e&&e.length>0){this.reInitializeValues(this.values);var t=Q(this.dimMinValue),i=this.dimMaxValue,s=$(this.timeRangeDuration);0!==s.second&&t.setUTCSeconds(0),0!==s.minute&&(t.setUTCSeconds(0),t.setUTCMinutes(0)),0!==s.hour&&(t.setUTCSeconds(0),t.setUTCMinutes(0),t.setUTCSHours(0)),0!==s.day&&(t.setUTCSeconds(0),t.setUTCMinutes(0),t.setUTCSHours(0),t.setUTCDate(0)),0!==s.month&&(t.setUTCSeconds(0),t.setUTCMinutes(0),t.setUTCSHours(0),t.setUTCDate(0)),this.reInitializeValues(t.toISO8601()+"/"+i+"/"+this.timeRangeDuration)}else this.reInitializeValues(this.values)}},{key:"getClosestValue",value:function(e,t){e&&-1!==e.indexOf("/")&&(e=e.split("/")[0]),t=void 0!==t&&t;var i=-1,s="outside range";try{i=this.getIndexForValue(e),s=this.getValueForIndex(i)}catch(e){"number"==typeof e&&(s=0===e?"date too early":"date too late")}if("current"===e||"default"===e||""===e)s=this.defaultValue;else if("latest"===e||t&&"date too late"===s)s=this.getValueForIndex(this.size()-1);else if("earliest"===e||t&&"date too early"===s)s=this.getValueForIndex(0);else if("middle"===e){var n=this.size()/2-1;n<0&&(n=0),s=this.getValueForIndex(n)}return s}},{key:"getValueForIndex",value:function(e){if(this.initialize(),e<0)return-1===e?"date too early":-2===e?"date too late":-1;if("timestartstopres"===this._type){try{return this._timeRangeDurationDate.getDateAtTimeStep(e).toISO8601()}catch(e){}return this._timeRangeDurationDate.getDateAtTimeStep(e)}return"timevalues"===this._type?this._allValues[e]:"anyvalue"===this._type?this._allValues[e]:void 0}},{key:"get",value:function(e){return this.getValueForIndex(e)}},{key:"getIndexForValue",value:function(e,t){if(this.initialize(),Object(o.n)(t)||(t=!0),"string"==typeof e&&"current"===e&&"current"!==this.defaultValue)return this.getIndexForValue(this.defaultValue);if("timestartstopres"===this._type)try{return"string"==typeof e?this._timeRangeDurationDate.getTimeStepFromISODate(e,t):this._timeRangeDurationDate.getTimeStepFromDate(e,t)}catch(e){return 0===parseInt(e)?-1:-2}if("timevalues"===this._type)try{for(var i,s=Q(e).getTime(),n=0,a=0;a<this._allValues.length;a++){var r=this._allDates[a].getTime()-s;r<0&&(r=-r),0===a&&(i=r),r<i&&(i=r,n=a)}return n}catch(e){return c("WMSJDimension::getIndexForValue,2: "+e),-1}if("anyvalue"===this._type)for(var h=0;h<this._allValues.length;h++)if(this._allValues[h]===e)return h;return-1}},{key:"size",value:function(){return this.initialize(),"timestartstopres"===this._type?this._timeRangeDurationDate.getTimeSteps():"timevalues"===this._type||"anyvalue"===this._type?this._allValues.length:void 0}},{key:"clone",value:function(){var t=new e;return t.name=this.name,t.units=this.units,t.values=this.values,t.initialize(),t.currentValue=this.currentValue,t.defaultValue=this.defaultValue,t.parentLayer=this.parentLayer,t.linked=this.linked,t}}])&&te(t.prototype,i),s&&te(t,s),e}(),se=[],ne={proxy:"Check WMJSGlobals WMJSServiceStoreXML2JSONRequest"};function ae(e){return(ae="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}var oe=function(e){return new Promise(function(t,i){fetch(e,{method:"GET",mode:"cors"}).then(function(e){var t=e.headers.get("content-type");return t&&t.includes("application/xml"),e.text()}).catch(function(e){i(e)}).then(function(e){"object"!==ae(e)&&"parseerror"===(e=(new DOMParser).parseFromString(e,"text/xml")).documentElement.nodeName&&i(new Error("Error while parsing: "+e));var s={};!function e(t,i,s){if(t.children&&t.children.length)for(var n=0;n<t.children.length;n++){var a=t.children[n],o=i+"->"+a.nodeName,r=null,h=a.nodeName;if(s[h]){if(r={attr:{}},s[h]instanceof Array);else{var l=Object.assign({},s[h]);s[h]=[],s[h].push(l)}s[h].push(r)}else s[h]={attr:{}},r=s[h];if(a.childNodes&&a.childNodes.length>0&&a.childNodes[0].nodeValue){var u=a.childNodes[0].nodeValue.trim();"\n"!==u&&u.length>0&&(r.value=u)}if(a.attributes&&a.attributes.length>0)for(var d=0;d<a.attributes.length;d++)r.attr[a.attributes[d].name]=a.attributes[d].value;e(a,o,r)}}(e,"",s),t(s)})})};function re(e,t){for(var i=0;i<t.length;i++){var s=t[i];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}var he={xml2jsonrequestURL:"Check WMJSService line 8"},le=function(e,t,i,n){var a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:(void 0).xml2jsonrequestURL;if(Object(o.n)(e)){if(0===e.length)return c("Service is empty"),void n(E.service_url_empty.text);if(e.startsWith("/")&&!e.startsWith("//")){var r=window.location.href.split("/").filter(function(e){return e.length>0});e=r[0]+"//"+r[1]+"/"+e}if(!e.startsWith("http://")&&!e.startsWith("https:")&&!e.startsWith("//"))return c("Service does not start with HTTPS"),void n(E.service_url_empty.text);-1===e.indexOf("?")&&(e+="?");var h=e+"&service=WMS&request=GetCapabilities&random"+Math.random(),l=a;oe(h).then(function(e){try{i(e)}catch(e){console.error(e)}}).catch(function(e){!function(e,t,i,n){var a=n+"request=",r=function(e){i(E.unable_to_do_getcapabilities.text+":\n"+a+"\n"+E.result.text+":\n"+e)};a+=Object(o.c)(e);try{s.ajax({url:a,crossDomain:!0,dataType:"jsonp"}).done(function(e){t(e)}).fail(function(){r({error:"Request failed for "+a})})}catch(e){c(e),r({error:"Request failed for "+a})}}(h,i,function(){n("Request failed for "+h)},l)})}else n(E.no_service_defined.text)},ue=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.service=void 0,this.title=void 0,this.onlineresource=void 0,this.abstract=void 0,this.version=m.version111,this.getcapabilitiesDoc=void 0,this.busy=!1,this._flatLayerObject=void 0,t&&(this.service=t.service,this.title=t.title),this.checkVersion111=this.checkVersion111.bind(this),this.checkVersion130=this.checkVersion130.bind(this),this.getCapabilityElement=this.getCapabilityElement.bind(this),this.checkVersion=this.checkVersion.bind(this),this.getCapabilities=this.getCapabilities.bind(this),this.checkException=this.checkException.bind(this),this.getNodes=this.getNodes.bind(this),this.getLayerNames=this.getLayerNames.bind(this),this.getLayerObjectsFlat=this.getLayerObjectsFlat.bind(this),this.xml2jsonrequestURL=t.xml2jsonrequestURL?t.xml2jsonrequestURL:he.xml2jsonrequestURL,this.functionCallbackList=[]}var t,i,s;return t=e,(i=[{key:"checkVersion111",value:function(e){try{if(!e.WMT_MS_Capabilities.Capability.Layer)throw new Error("No 111 layer")}catch(i){var t=this.checkException(e);if(void 0!==t)throw t;if(!e.WMT_MS_Capabilities.Capability)throw E.no_wms_capability_element_found.text;if(!e.WMT_MS_Capabilities.Capability.Layer)throw E.no_wms_layer_element_found.text}}},{key:"setXML2JSONProxy",value:function(e){this.xml2jsonrequestURL=e}},{key:"checkVersion130",value:function(e){try{if(!e.WMS_Capabilities.Capability.Layer)throw new Error("No 130 layer")}catch(i){var t=this.checkException(e);if(void 0!==t)throw t;if(!e.WMS_Capabilities.Capability)throw E.no_wms_capability_element_found.text;if(!e.WMS_Capabilities.Capability.Layer)throw E.no_wms_layer_element_found.text}}},{key:"getCapabilityElement",value:function(e){var t;try{t=e.WMT_MS_Capabilities.Capability}catch(i){try{t=e.WMS_Capabilities.Capability}catch(e){throw E.no_capability_element_found.text}}if(!Object(o.n)(t))throw E.no_capability_element_found.text;return t}},{key:"checkVersion",value:function(e){var t=null;try{m.version100===e.WMT_MS_Capabilities.attr.version&&(t=m.version100),m.version111===e.WMT_MS_Capabilities.attr.version&&(t=m.version111),m.version130===e.WMT_MS_Capabilities.attr.version&&(t=m.version130)}catch(s){try{m.version100===e.WMS_Capabilities.attr.version&&(t=m.version100),m.version111===e.WMS_Capabilities.attr.version&&(t=m.version111),m.version130===e.WMS_Capabilities.attr.version&&(t=m.version130)}catch(t){var i=this.checkException(e);throw i?new Error(i):new Error("Unable to determine WMS version")}}if(null===t)throw new Error("Unable to determine WMS version");return t===m.version111?(this.checkVersion111(e),t):t===m.version130?(this.checkVersion130(e),t):m.version111}},{key:"getCapabilities",value:function(e,t,i){var s=this,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:this.xml2jsonrequestURL;if(this.busy){var a={callback:e,fail:t};this.functionCallbackList.push(a)}else if(this._flatLayerObject=void 0,this.getcapabilitiesDoc&&!0!==i)e(this.getcapabilitiesDoc);else{this.busy=!0;var o={callback:e,fail:t};this.functionCallbackList.push(o);var r=function(e){var t;for(s.busy=!1;t=s.functionCallbackList.pop();)t.fail(e)};le(this.service,!1,function(e){s.busy=!1,s.getcapabilitiesDoc=e;try{s.version=s.checkVersion(e)}catch(e){return void r(e.message)}var t,i=e.WMS_Capabilities;i||(i=e.WMT_MS_Capabilities);try{s.abstract=i.Service.Abstract.value}catch(e){s.abstract=E.not_available_message.text}try{s.title=i.Service.Title.value}catch(e){s.title=E.not_available_message.text}try{i.Service.OnlineResource.value?s.onlineresource=i.Service.OnlineResource.value:s.onlineresource=i.Service.OnlineResource.attr["xlink:href"]}catch(e){s.onlineresource=E.not_available_message.text}for(;t=s.functionCallbackList.pop();)t.callback(e)},r,n)}}},{key:"checkException",value:function(e){try{if(e.ServiceExceptionReport){var t="Undefined",i=e.ServiceExceptionReport.ServiceException;if(i){try{i.attr.code&&(t=i.attr.code)}catch(e){}if(i.value)return"Exception: "+t+".\n"+i.value}return E.wms_service_exception_code.text+t}}catch(e){}}},{key:"_sortByKey",value:function(e,t){return e.sort(function(e,i){var s=e[t],n=i[t];return s<n?-1:s>n?1:0})}},{key:"getNodes",value:function(e,t,i){var s=this,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:he.xml2jsonrequestURL;this.nodeCache=void 0,t||(t=function(e){c(e)});this.getCapabilities(function(i){!function(i){var n={leaf:!1,expanded:!0,children:[]},a=s.getCapabilityElement(i).Layer;try{s.version=s.checkVersion(i)}catch(e){return void t(e)}var r=Object(o.r)(a.Layer);try{n.text=a.Title.value}catch(e){n.text=E.unnamed_service.text}!function e(t,i,n){for(var a=0;a<t.length;a++){var r=!1;t[a].Name&&(r=!0);try{t[a].Layer&&(r=!1)}catch(e){}var h={};t[a].Name?h={name:t[a].Name.value,text:t[a].Title.value,leaf:r,path:n}:(Object(o.o)(t[a].Title)&&(t[a].Title=[],t[a].Title.value="Layer"),h={text:t[a].Title.value,leaf:r}),i.push(h),t[a].Layer&&(h.children=[],e(Object(o.r)(t[a].Layer),h.children,n+t[a].Title.value))}s._sortByKey(i,"text")}(r,n.children,""),e(n)}(i)},function(e){t(e)},i,n)}},{key:"getLayerNames",value:function(e,t,i){var s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:this.xml2jsonrequestURL;try{this.getNodes(function(t){var i=[];!function e(t){for(var s=0;s<t.length;s++)t[s].name&&i.push(t[s].name),t[s].children&&e(t[s].children)}(t.children),e(i)},t,i,s)}catch(e){t(e)}}},{key:"getLayerObjectsFlat",value:function(e,t,i){var s=this,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:this.xml2jsonrequestURL;if(Object(o.n)(this._flatLayerObject)&&!0!==i)e(this._flatLayerObject);else{this.getNodes(function(t){s._flatLayerObject=[];!function e(t){for(var i=0;i<t.length;i++)t[i].name&&s._flatLayerObject.push(t[i]),t[i].children&&e(t[i].children)}(t.children),e(s._flatLayerObject)},t,i,n)}}}])&&re(t.prototype,i),s&&re(t,s),e}(),de=function(e,t){for(var i=0;i<se.length;i++)if(se[i].service===e)return se[i];t&&(ne.proxy=t);var s=new ue({service:e,xml2jsonrequestURL:ne.proxy});return se.push(s),s};function ce(e,t){for(var i=0;i<t.length;i++){var s=t[i];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}function me(e,t,i){return t&&ce(e.prototype,t),i&&ce(e,i),e}var fe=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.init=this.init.bind(this),this.wmsextensions=this.wmsextensions.bind(this),this.getLayerName=this.getLayerName.bind(this),this.toggleAutoUpdate=this.toggleAutoUpdate.bind(this),this.setAutoUpdate=this.setAutoUpdate.bind(this),this.setOpacity=this.setOpacity.bind(this),this.getOpacity=this.getOpacity.bind(this),this.remove=this.remove.bind(this),this.moveUp=this.moveUp.bind(this),this.moveDown=this.moveDown.bind(this),this.zoomToLayer=this.zoomToLayer.bind(this),this.draw=this.draw.bind(this),this.handleReferenceTime=this.handleReferenceTime.bind(this),this.setDimension=this.setDimension.bind(this),this.configureDimensions=this.configureDimensions.bind(this),this.parseLayer=this.parseLayer.bind(this),this.cloneLayer=this.cloneLayer.bind(this),this.setName=this.setName.bind(this),this.getLayerRelative=this.getLayerRelative.bind(this),this.autoSelectLayer=this.autoSelectLayer.bind(this),this.getNextLayer=this.getNextLayer.bind(this),this.getPreviousLayer=this.getPreviousLayer.bind(this),this.setStyle=this.setStyle.bind(this),this.getStyles=this.getStyles.bind(this),this.getStyleObject=this.getStyleObject.bind(this),this.getStyle=this.getStyle.bind(this),this.setService=this.setService.bind(this),this.getDimension=this.getDimension.bind(this),this.getProjection=this.getProjection.bind(this),this.setSLDURL=this.setSLDURL.bind(this),this.display=this.display.bind(this),this.init(),this._options=t,this.sldURL=null,t&&(this.service=t.service,this.getmapURL=t.service,this.getfeatureinfoURL=t.service,this.getlegendgraphicURL=t.service,this.name=t.name,t.getgraphinfoURL&&(this.getgraphinfoURL=t.getgraphinfoURL),t.style&&(this.currentStyle=t.style),t.sldURL&&(this.sldURL=t.sldURL),t.format?this.format=t.format:this.format="image/png",t.opacity&&(this.opacity=t.opacity),t.title&&(this.title=t.title),this.abstract=E.not_available_message.text,!1===t.enabled&&(this.enabled=!1),!0===t.keepOnTop&&(this.keepOnTop=!0),!0===t.transparent&&(this.transparent=!0),!1===t.transparent&&(this.transparent=!1),Object(o.n)(t.onReady)&&(this.onReady=t.onReady,this.parseLayer(void 0,void 0,"WMJSLayer::configOptions")),Object(o.n)(t.type)&&(this.type=t.type),t.parentMaps&&(console.log(t.parentMaps),this.parentMaps=t.parentMaps))}return me(e,[{key:"init",value:function(){this.autoupdate=!1,this.timer=void 0,this.service=void 0,this.WMJSService=void 0,this.getmapURL=void 0,this.getfeatureinfoURL=void 0,this.getlegendgraphicURL=void 0,this.keepOnTop=!1,this.transparent=!0,this.hasError=!1,this.legendIsDimensionDependant=!0,this.wms130bboxcompatibilitymode=!1,this.version=m.version111,this.path="",this.type="wms",this.objectpath=[],this.wmsextensions.url="",this.jsonlayer_v1_1_1=void 0,this.name=void 0,this.title="empty layer",this.abstract=void 0,this.dimensions=[],this.legendGraphic="",this.projectionProperties=[],this.queryable=!1,this.enabled=!0,this.styles=void 0,this.currentStyle="",this.id=-1,this.opacity=1,this.getCapabilitiesDoc=void 0,this.serviceTitle="not defined",this.parentMaps=[],this.sldURL}}]),me(e,[{key:"wmsextensions",value:function(e){this.wmsextensions.colorscalerange="",Object(o.n)(e.colorscalerange)&&(this.wmsextensions.colorscalerange=e.colorscalerange),this.wmsextensions.url="",this.wmsextensions.colorscalerange.length>2&&(this.wmsextensions.url+="&COLORSCALERANGE="+this.wmsextensions.colorscalerange)}},{key:"getLayerName",value:function(){return this.name}},{key:"toggleAutoUpdate",value:function(){if(this.autoupdate=!this.autoupdate,this.autoupdate){this.timer=setInterval((e=this,function(){e.parseLayer(void 0,!0,"WMJSLayer::autoupdate")}),6e4)}else clearInterval(this.timer);var e}},{key:"setAutoUpdate",value:function(e,t,i){var s;e!==this.autoupdate&&(this.autoupdate=e,e?this.timer=setInterval((s=this,function(){s.parseLayer(i,!0,"WMJSLayer::autoupdate")}),t):clearInterval(this.timer))}},{key:"setOpacity",value:function(e){this.opacity=parseFloat(e),0===this.parentMaps.length&&console.error("Layer has no parent maps");for(var t=0;t<this.parentMaps.length;t++)this.parentMaps[t].redrawBuffer()}},{key:"getOpacity",value:function(){return this.opacity}},{key:"remove",value:function(){for(var e=0;e<this.parentMaps.length;e++)this.parentMaps[e].deleteLayer(this),this.parentMaps[e].draw("WMJSLayer::remove");clearInterval(this.timer)}},{key:"moveUp",value:function(){for(var e=0;e<this.parentMaps.length;e++)this.parentMaps[e].moveLayerUp(this),this.parentMaps[e].draw("WMJSLayer::moveUp")}},{key:"moveDown",value:function(){for(var e=0;e<this.parentMaps.length;e++)this.parentMaps[e].moveLayerDown(this),this.parentMaps[e].draw("WMJSLayer::moveDown")}},{key:"zoomToLayer",value:function(){for(var e=0;e<this.parentMaps.length;e++)this.parentMaps[e].zoomToLayer(this)}},{key:"draw",value:function(e){for(var t=0;t<this.parentMaps.length;t++)this.parentMaps[t].draw("WMJSLayer::draw::"+e)}},{key:"handleReferenceTime",value:function(e,t){if("reference_time"===e){var i=this.getDimension("time");i&&(i.__setStartTime(t),this.parentMaps&&this.parentMaps.length>0&&this.parentMaps[0].getListener().triggerEvent("ondimchange","time"))}}},{key:"setDimension",value:function(e,t){for(var i,s=0;s<this.dimensions.length;s++)this.dimensions[s].name===e&&(i=this.dimensions[s]);if(!1!==Object(o.n)(i)&&!1!==Object(o.n)(t)&&(i.setValue(t),this.handleReferenceTime(e,t),!0===i.linked))for(var n=0;n<this.parentMaps.length;n++)this.parentMaps[n].setDimension(e,i.getValue())}},{key:"configureDimensions",value:function(){var e=this,t=this.cloneLayer(),i=e.jsonlayer_v1_1_1;if(i){for(var s=Object(o.r)(i.Dimension),n=e.objectpath.length-1;n>=0;n--){var a=e.objectpath[n].Dimension;if(!Object(o.o)(a)&&Object(o.n)(a))for(var r=0;r<a.length;r++){var h=a[r];if(!Object(o.o)(h)&&Object(o.n)(h)){for(var l=!1,u=0;u<s.length;u++)if(h.attr.name.toLowerCase()===s[n].attr.name.toLowerCase()){l=!0;break}l||s.push(h)}}}var d=Object(o.r)(i.Extent);e.dimensions=[];for(var f=!1,p=function(i){var n=void 0;"reference_time"===s[i].attr.name.toLowerCase()?(f=!0,n=new ie({linked:!1})):n=new ie,n.name=s[i].attr.name.toLowerCase(),n.units=s[i].attr.units;for(var a=0;a<d.length;a++)if(d[a].attr.name.toLowerCase()===n.name){if(d[a].value?n.values=d[a].value.trim():n.values="",d[a].attr.default)n.defaultValue=d[a].attr.default.trim();else{var r=n.values.split("/");r.length>1?n.defaultValue=r[1]:r.length>0&&(n.defaultValue=r[0])}d[a].value||(c("No extent defined for dim "+n.name+" in layer "+e.title),c("Using default value "+n.defaultValue),n.values=n.defaultValue)}e.version===m.version130&&(n.values=s[i].value,n.defaultValue=s[i].attr.default);var h=n.defaultValue;if(e.parentMaps.length>0){var l=e.parentMaps[0].getDimension(n.name);Object(o.n)(l)&&l.linked&&(Object(o.n)(l.currentValue)?(h=n.getClosestValue(l.currentValue),n.name,l.currentValue):n.name)}if(1===t.dimensions.filter(function(e){return e.name===n.name}).length){var u=t.dimensions.filter(function(e){return e.name===n.name})[0];Object(o.n)(u.currentValue)?n.setValue(u.currentValue):n.setValue(h)}else n.setValue(h);n.parentLayer=e,Object(o.n)(n.values)?e.dimensions.push(n):c("Skipping dimension "+n.name)},g=0;g<s.length;g++)p(g);if(f){var v=e.getDimension("reference_time");this.handleReferenceTime("reference_time",v.getValue())}}}},{key:"__parseGetCapForLayer",value:function(e,t,i,s){var n=t;if(0===n||void 0===n)return e.title=E.service_has_error.text,e.abstract=E.not_available_message.text,void s(e,E.unable_to_connect_server.text);var a,r=0;try{a=e.WMJSService.getCapabilityElement(t)}catch(t){return void s(e,t)}e.version=e.WMJSService.version;var h=a.Layer;if(Object(o.n)(h)){try{e.serviceTitle=h.Title.value}catch(t){e.serviceTitle="Unnamed service"}this.optimalFormat="image/png";try{for(var l=a.Request.GetMap.Format,u=0;u<l.length;u++)l[u].value.indexOf("24")>0&&(this.optimalFormat=l[u].value),l[u].value.indexOf("32")>0&&(this.optimalFormat=l[u].value)}catch(e){c("This WMS service has no getmap formats listed: using image/png")}if(void 0===e.name||e.name.length<1)return e.title="empty layer",e.abstract=E.not_available_message.text,void i(e);var d=0,f=function(t,i,s){e.jsonlayer_v1_1_1=t,e.getmapURL=void 0;try{e.getmapURL=a.Request.GetMap.DCPType.HTTP.Get.OnlineResource.attr["xlink:href"]}catch(e){}Object(o.n)(e.getmapURL)||(e.getmapURL=e.service,c("GetMap OnlineResource is not specified. Using default.")),e.getfeatureinfoURL=void 0;try{e.getfeatureinfoURL=a.Request.GetFeatureInfo.DCPType.HTTP.Get.OnlineResource.attr["xlink:href"]}catch(e){}Object(o.n)(e.getfeatureinfoURL)||(e.getfeatureinfoURL=e.service,c("GetFeatureInfo OnlineResource is not specified. Using default.")),e.getlegendgraphicURL=void 0;try{e.getlegendgraphicURL=a.Request.GetLegendGraphic.DCPType.HTTP.Get.OnlineResource.attr["xlink:href"]}catch(e){}Object(o.n)(e.getlegendgraphicURL)||(e.getlegendgraphicURL=e.service),e.getmapURL=Object(o.e)(e.getmapURL),e.getfeatureinfoURL=Object(o.e)(e.getfeatureinfoURL),e.getlegendgraphicURL=Object(o.e)(e.getlegendgraphicURL),e.getCapabilitiesDoc=n,e.title=t.Title.value;try{e.abstract=t.Abstract.value}catch(t){e.abstract=E.not_available_message.text}e.path=i,e.objectpath=s,e.styles=void 0,e.jsonlayer=e;try{var l="";t.Style&&(l=Object(o.r)(t.Style)),e.styles=l;for(var u=0;u<e.styles.length;u++){var f=e.styles[u];f.index=u,f.nrOfStyles=e.styles.length,f.title="default",f.name="default",f.legendURL="",f.abstracttext="No abstract available";try{f.title=f.Title.value}catch(e){}try{f.name=f.Name.value}catch(e){}try{f.legendURL=f.LegendURL.OnlineResource.attr["xlink:href"]}catch(e){}try{f.abstracttext=f.Abstract.value}catch(e){}}""===e.currentStyle&&(e.currentStyle=e.styles[0].Name.value),e.setStyle(e.currentStyle)}catch(t){e.currentStyle="",e.styles="",c("No styles found for layer "+e.title)}e.configureDimensions();var p=Object(o.r)(t.SRS);Object(o.n)(t.CRS)&&(p=Object(o.r)(t.CRS)),e.projectionProperties=[];var g=[],v=function(t){if(Object(o.n)(t.BoundingBox)){var i=Object(o.r)(t.BoundingBox);for(r=0;r<i.length;r++){var s=void 0;s=i[r].attr.SRS,Object(o.n)(i[r].attr.CRS)&&(s=i[r].attr.CRS),s&&s.length>0&&(s=decodeURIComponent(s));for(var n=!1,a=0;a<e.projectionProperties.length;a++)if(s===e.projectionProperties[a].srs){n=!0;break}if(!1===n){var h=new y;h.srs=s;var l=!1;e.version===m.version130&&"EPSG:4326"===h.srs&&!1===e.wms130bboxcompatibilitymode&&(l=!0),!1===l?(h.bbox.left=parseFloat(i[r].attr.minx),h.bbox.bottom=parseFloat(i[r].attr.miny),h.bbox.right=parseFloat(i[r].attr.maxx),h.bbox.top=parseFloat(i[r].attr.maxy)):(h.bbox.left=parseFloat(i[r].attr.miny),h.bbox.bottom=parseFloat(i[r].attr.minx),h.bbox.right=parseFloat(i[r].attr.maxy),h.bbox.top=parseFloat(i[r].attr.maxx)),e.projectionProperties.push(h),g.push(h.srs)}}}};for(v(t),v(h),r=0;r<p.length;r++)if(-1===g.indexOf(p[r].value)){var b=new y;c("Warning: BoundingBOX missing for SRS "+p[r].value),b.bbox.left=-180,b.bbox.bottom=-90,b.bbox.right=180,b.bbox.top=90,b.srs=p[r].value,e.projectionProperties.push(b)}g="",e.queryable=!1;try{1===parseInt(t.attr.queryable)?e.queryable=!0:e.queryable=!1}catch(t){c("Unable to detect whether this layer is queryable (for layer "+e.title+")")}d=1},p=Object(o.r)(h.Layer),g=[];if(g.push(h),function t(i,s,n){for(var a=[],r=0;r<n.length;r++)a.push(n[r]);a.push(i);for(var h=0;h<i.length;h++)if(i[h].Layer){var l=s;try{l+=i[h].Title.value+"/"}catch(e){}t(Object(o.r)(i[h].Layer),l,a)}else if(i[h].Name&&i[h].Name.value===e.name)return void f(i[h],s,a)}(p,"",g),0===d){var v="";return v=e.name?"Unable to find layer '"+e.name+"' in service '"+e.service+"'":"Unable to find layer '"+e.title+"' in service '"+e.service+"'",e.title="--- layer not found in service ---",e.abstract=E.not_available_message.text,s(e,v),e}return e.onReady&&e.onReady(e),i(e),e}s(e,"No Layer element in service")}},{key:"parseLayer",value:function(e,t,i,s){var n=this,a=this;a.hasError=!1;var r=function(t){if(Object(o.n)(e))try{e(t)}catch(e){console.log(e)}},h=function(e,t){a.hasError=!0,a.lastError=t,a.title=E.service_has_error.text,c(t),r(e),Object(o.n)(n._options.failure)&&n._options.failure(e,t)},l=s;s||(l=a.parentMaps&&a.parentMaps.length>0?a.parentMaps[0].xml2jsonrequest:void 0),a.WMJSService=de(this.service,l),a.WMJSService.getCapabilities(function(e){!function(e){a.__parseGetCapForLayer(a,e,r,h)}(e)},function(e){h(a,e)},t)}},{key:"cloneLayer",value:function(){var e={};for(var t in this)e[t]=this[t];return e}},{key:"setName",value:function(e){this.name=e,this.parseLayer(void 0,void 0,"WMJSLayer::setName")}},{key:"getLayerRelative",value:function(e,t,i){Object(o.n)(i)||(i=0);var s=this;s.WMJSService.getLayerObjectsFlat(function(n){for(var a=-1,o=0;o<n.length;o++)if(n[o].name===s.name){a=o;break}-1!==a?(-1===i&&a--,1===i&&a++,a>n.length-1&&(a=0),a<0&&(a=n.length-1),e(n[a],a,n.length)):t("Current layer ["+s.name+"] not in this service")},t)}},{key:"autoSelectLayer",value:function(e,t){this.WMJSService.getLayerObjectsFlat(function(t){for(var i=0;i<t.length;i++)if(Object(o.n)(t[i].name)&&-1===t[i].name.indexOf("baselayer")&&-1===t[i].path.indexOf("baselayer"))return void e(t[i])},t)}},{key:"getNextLayer",value:function(e,t){this.getLayerRelative(e,t,1)}},{key:"getPreviousLayer",value:function(e,t){this.getLayerRelative(e,t,-1)}},{key:"setStyle",value:function(e){if(!this.styles||0===this.styles.length)return this.currentStyle="",void(this.legendGraphic="");for(var t=0;t<this.styles.length;t++)if(this.styles[t].name===e)return this.legendGraphic=this.styles[t].legendURL,void(this.currentStyle=this.styles[t].name);this.styles[0].name,this.currentStyle=this.styles[0].name,this.legendGraphic=this.styles[0].legendURL}},{key:"getStyles",value:function(){return this.styles?this.styles:[]}},{key:"getStyleObject",value:function(e,t){if(!1!==Object(o.n)(this.styles))for(var i=0;i<this.styles.length;i++)if(this.styles[i].name===e)return-1===t&&i--,1===t&&i++,i<0&&(i=this.styles.length-1),i>this.styles.length-1&&(i=0),this.styles[i].nrOfStyles=this.styles.length,this.styles[i].index=i,this.styles[i]}},{key:"getStyle",value:function(){return this.currentStyle}},{key:"setService",value:function(e){this.service=e,this.getmapURL=e,this.getfeatureinfoURL=e,this.getlegendgraphicURL=e,this.getgraphinfoURL=e}},{key:"getDimension",value:function(e){for(var t=0;t<this.dimensions.length;t++)if(this.dimensions[t].name===e)return this.dimensions[t]}},{key:"getProjection",value:function(e){for(var t=0;t<this.projectionProperties.length;t++)if(this.projectionProperties[t].srs===e){var i=[];return i.srs=this.projectionProperties[t].srs+"",i.bbox=new v(this.projectionProperties[t].bbox.left,this.projectionProperties[t].bbox.bottom,this.projectionProperties[t].bbox.right,this.projectionProperties[t].bbox.top),i}}},{key:"setSLDURL",value:function(e){this.sldURL=e}},{key:"display",value:function(e){this.enabled=e;for(var t=0;t<this.parentMaps.length;t++)this.parentMaps[t].displayLayer(this,this.enabled)}}]),e}();i.d(t,"WMJSMap",function(){return Y}),i.d(t,"isDefined",function(){return o.n}),i.d(t,"WMJSLayer",function(){return fe}),i.d(t,"getUrlVars",function(){return o.m}),i.d(t,"checkIfHashTagChanged",function(){return o.h}),i.d(t,"WMJSTimer",function(){return w}),i.d(t,"WMJSGetServiceFromStore",function(){return de}),i.d(t,"WMJScheckURL",function(){return o.e}),i.d(t,"URLEncode",function(){return o.c}),i.d(t,"URLDecode",function(){return o.b}),i.d(t,"WMJSDateOutSideRange",function(){return"outside range"}),i.d(t,"WMJSDateTooEarlyString",function(){return"date too early"}),i.d(t,"WMJSDateTooLateString",function(){return"date too late"}),i.d(t,"WMJSEmptyLayerName",function(){return"empty_layer"}),i.d(t,"WMJSEmptyLayerTitle",function(){return"empty layer"}),i.d(t,"parseISO8601DateToDate",function(){return Q}),i.d(t,"I18n",function(){return E}),i.d(t,"addMouseWheelEvent",function(){return o.f}),i.d(t,"removeMouseWheelEvent",function(){return o.q}),i.d(t,"WMJSKVP",function(){return o.d}),i.d(t,"composeUrlObjectFromURL",function(){return o.i}),i.d(t,"WMJSBBOX",function(){return v}),i.d(t,"toArray",function(){return o.r})}])});